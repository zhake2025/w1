function s(n,e,t,r){if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}function f(n,e,t,r,l){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}var d,a,h,p;const T="__TAURI_TO_IPC_KEY__";function P(n,e=!1){return window.__TAURI_INTERNALS__.transformCallback(n,e)}class j{constructor(e){d.set(this,void 0),a.set(this,0),h.set(this,[]),p.set(this,void 0),f(this,d,e||(()=>{})),this.id=P(t=>{const r=t.index;if("end"in t){r==s(this,a,"f")?this.cleanupCallback():f(this,p,r);return}const l=t.message;if(r==s(this,a,"f")){for(s(this,d,"f").call(this,l),f(this,a,s(this,a,"f")+1);s(this,a,"f")in s(this,h,"f");){const y=s(this,h,"f")[s(this,a,"f")];s(this,d,"f").call(this,y),delete s(this,h,"f")[s(this,a,"f")],f(this,a,s(this,a,"f")+1)}s(this,a,"f")===s(this,p,"f")&&this.cleanupCallback()}else s(this,h,"f")[r]=l})}cleanupCallback(){window.__TAURI_INTERNALS__.unregisterCallback(this.id)}set onmessage(e){f(this,d,e)}get onmessage(){return s(this,d,"f")}[(d=new WeakMap,a=new WeakMap,h=new WeakMap,p=new WeakMap,T)](){return`__CHANNEL__:${this.id}`}toJSON(){return this[T]()}}async function w(n,e={},t){return window.__TAURI_INTERNALS__.invoke(n,e,t)}const m="Request cancelled";async function M(n,e){const t=e?.signal;if(t?.aborted)throw new Error(m);const r=e?.maxRedirections,l=e?.connectTimeout,y=e?.proxy,k=e?.danger;e&&(delete e.maxRedirections,delete e.connectTimeout,delete e.proxy,delete e.danger);const c=e?.headers?e.headers instanceof Headers?e.headers:new Headers(e.headers):new Headers,u=new Request(n,e),E=await u.arrayBuffer(),x=E.byteLength!==0?Array.from(new Uint8Array(E)):null;for(const[o,i]of u.headers)c.get(o)||c.set(o,i);const I=(c instanceof Headers?Array.from(c.entries()):Array.isArray(c)?c:Object.entries(c)).map(([o,i])=>[o,typeof i=="string"?i:i.toString()]);if(t?.aborted)throw new Error(m);const R=await w("plugin:http|fetch",{clientConfig:{method:u.method,url:u.url,headers:I,data:x,maxRedirections:r,connectTimeout:l,proxy:y,danger:k}}),C=()=>w("plugin:http|fetch_cancel",{rid:R});if(t?.aborted)throw C(),new Error(m);t?.addEventListener("abort",()=>void C());const{status:A,statusText:S,url:L,headers:N,rid:v}=await w("plugin:http|fetch_send",{rid:R}),H=[101,103,204,205,304].includes(A)?null:new ReadableStream({start:o=>{const i=new j;i.onmessage=b=>{if(t?.aborted){o.error(m);return}const _=new Uint8Array(b),U=_[_.byteLength-1],O=_.slice(0,_.byteLength-1);if(U==1){o.close();return}o.enqueue(O)},w("plugin:http|fetch_read_body",{rid:v,streamChannel:i}).catch(b=>{o.error(b)})}}),g=new Response(H,{status:A,statusText:S});return Object.defineProperty(g,"url",{value:L}),Object.defineProperty(g,"headers",{value:new Headers(N)}),g}export{M as fetch};
