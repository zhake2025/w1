import{c$ as i}from"./index-BFQp9Otg.js";async function d(n,e){const p="https://generativelanguage.googleapis.com/v1beta",r={instances:[{prompt:e.prompt}],parameters:{aspectRatio:e.aspectRatio||"16:9",personGeneration:e.personGeneration||"dont_allow"}};e.image&&(r.instances[0].image={imageBytes:e.image,mimeType:"image/png"}),e.negativePrompt&&(r.parameters.negativePrompt=e.negativePrompt),e.durationSeconds&&(r.parameters.durationSeconds=e.durationSeconds),e.enhancePrompt!==void 0&&(r.parameters.enhancePrompt=e.enhancePrompt),i("INFO","[Google Veo] 提交视频生成请求",{prompt:e.prompt.substring(0,50),hasImage:!!e.image});const s=await fetch(`${p}/models/veo-2.0-generate-001:predictLongRunning?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok){const t=await s.text();throw new Error(`Google Veo API请求失败: ${s.status} ${s.statusText} - ${t}`)}const o=await s.json();if(!o.name)throw new Error("Google Veo API未返回操作名称");return i("INFO","[Google Veo] 获得操作名称",{operationName:o.name}),o.name}async function w(n,e){const p="https://generativelanguage.googleapis.com/v1beta";for(let o=1;o<=60;o++)try{i("INFO",`[Google Veo] 轮询操作状态 (${o}/60)`,{operationName:e});const t=await fetch(`${p}/${e}?key=${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok){if(t.status>=400&&t.status<500)throw new Error(`轮询状态失败: ${t.status} ${t.statusText}`);if(o<60){await c(1e4);continue}else throw new Error(`轮询状态失败: ${t.status} ${t.statusText}`)}const l=await t.json();if(i("INFO","[Google Veo] 操作状态",{operationName:e,done:l.done,attempt:o}),l.done){if(l.error)throw new Error(`Google Veo生成失败: ${l.error.message}`);const g=l.response?.generateVideoResponse?.generatedSamples;if(!g||g.length===0||!g[0]?.video?.uri)throw new Error("Google Veo生成完成但未返回视频URL");let a=g[0].video.uri;if(!a.includes("key=")){const m=a.includes("?")?"&":"?";a=`${a}${m}key=${n}`}return i("INFO","[Google Veo] 视频生成完成",{videoUrl:a.substring(0,50),totalVideos:g.length}),a}if(o<60)await c(1e4);else throw new Error("Google Veo视频生成超时，请稍后重试")}catch(t){if(o>=60)throw t;i("WARN","[Google Veo] 轮询出错，继续重试",{error:t.message,attempt:o,operationName:e}),await c(1e4)}throw new Error("Google Veo视频生成超时，请稍后重试")}function c(n){return new Promise(e=>setTimeout(e,n))}export{w as pollVeoOperation,d as submitVeoGeneration};
