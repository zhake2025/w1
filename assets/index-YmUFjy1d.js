import{ea as be,eb as E,ec as O,ed as P,ee as M,bE as N,bF as W,u as ne,r as c,ef as ae,j as e,bc as V,A as ye,T as we,I as A,b as re,d as h,f as v,B as o,g as _,C as X,P as q,a5 as ve,e as le,an as ke,i as Z,br as Ce,k as oe,m as ie,n as ce,o as de,M as L,G as xe,a3 as he,aP as Se,eg as Ie,X as ue,a2 as De,Y as Be,a4 as ze,Z as Te,ac as z,e6 as Re,V as Ae,aj as $e,af as Ke,dX as Y,ag as Ee,bm as Oe,a$ as Pe,eh as Le,ei as Q}from"./index-5OteHtpV.js";import{C as Ge}from"./CreateKnowledgeDialog-BJ5NgaiA.js";import{P as J}from"./plus-CNFnFWu4.js";import{C as me}from"./CardContent-CZNsHkoT.js";import{F as Fe}from"./folder-czwo2eRW.js";import{C as Me}from"./CardActions-DtoYwIKo.js";import{C as pe}from"./Card-0S04eo67.js";import{S as ge}from"./Stack-6qTbuoMo.js";import{I as U}from"./InputAdornment-a3_xDuZj.js";import{S as je}from"./search-Dw_6t9R9.js";import{F as Ne}from"./file-JP01FXBa.js";import{Z as ee}from"./zap-BiQK8T1p.js";import{T as We,a as te}from"./Tabs-CDQ1XREM.js";import"./useThemeProps-CP38LDNq.js";const He={async createMainTextBlock(t){const n=M("block"),s={id:n,messageId:t,type:W.MAIN_TEXT,content:"",createdAt:new Date().toISOString(),status:N.PENDING};return console.log(`[BlockManager] 创建主文本块 - ID: ${n}, 消息ID: ${t}`),E.dispatch(O(s)),await P.blocks.save(s),s},async createThinkingBlock(t){const n=M("thinking"),s={id:n,messageId:t,type:W.THINKING,content:"",createdAt:new Date().toISOString(),status:N.PENDING};return console.log(`[BlockManager] 创建思考过程块 - ID: ${n}, 消息ID: ${t}`),E.dispatch(O(s)),await P.blocks.save(s),s},async createErrorBlock(t,n){const s=M("error"),l={id:s,messageId:t,type:W.ERROR,content:n,createdAt:new Date().toISOString(),status:N.ERROR};return console.log(`[BlockManager] 创建错误块 - ID: ${s}, 消息ID: ${t}, 错误: ${n}`),E.dispatch(O(l)),await P.blocks.save(l),l},async createCodeBlock(t,n,s){const l=M("code"),d={id:l,messageId:t,type:W.CODE,content:n,language:s,createdAt:new Date().toISOString(),status:N.SUCCESS};return console.log(`[BlockManager] 创建代码块 - ID: ${l}, 消息ID: ${t}, 语言: ${s||"text"}`),E.dispatch(O(d)),await P.blocks.save(d),d},async createVideoBlock(t,n){const s=M("video"),l={id:s,messageId:t,type:W.VIDEO,url:n.url,base64Data:n.base64Data,mimeType:n.mimeType,width:n.width,height:n.height,size:n.size,duration:n.duration,poster:n.poster,createdAt:new Date().toISOString(),status:N.SUCCESS};return console.log(`[BlockManager] 创建视频块 - ID: ${s}, 消息ID: ${t}, 类型: ${n.mimeType}`),E.dispatch(O(l)),await P.blocks.save(l),l},async createKnowledgeReferenceBlock(t,n,s,l){const d=be(t,n,s,l);return console.log(`[BlockManager] 创建知识库引用块 - ID: ${d.id}, 消息ID: ${t}`),E.dispatch(O(d)),await P.blocks.save(d),d},async createKnowledgeReferenceBlockFromSearchResult(t,n,s,l){return this.createKnowledgeReferenceBlock(t,n.content,s,{source:n.metadata.source,similarity:n.similarity,fileName:n.metadata.fileName,fileId:n.metadata.fileId,knowledgeDocumentId:n.documentId,searchQuery:l})}},Ue=V(o)(()=>({flexGrow:1,display:"flex",flexDirection:"column",minHeight:"100vh",position:"relative",overflow:"hidden"})),Ve=V(pe)(({theme:t})=>({height:"100%",display:"flex",flexDirection:"column",transition:"transform 0.2s, box-shadow 0.2s",cursor:"pointer",borderRadius:t.shape.borderRadius*2,"&:hover":{transform:"translateY(-4px)",boxShadow:t.shadows[4]}})),Xe=()=>{const t=ne(),[n,s]=c.useState(!1),[l,d]=c.useState(null),[x,y]=c.useState(!1),[b,g]=c.useState(null),{knowledgeBases:u,isLoading:C,error:T,refreshKnowledgeBases:$}=ae(),S=a=>{t(`/knowledge/${a}`)},j=()=>{t("/settings")},f=a=>{g(a||null),y(!0)},I=()=>{y(!1),g(null)},R=async a=>{try{if(b)await L.getInstance().updateKnowledgeBase(b.id,a);else{const r=await L.getInstance().createKnowledgeBase(a);t(`/knowledge/${r.id}`)}I(),$()}catch(r){console.error("保存知识库失败:",r)}},k=(a,r)=>{r.stopPropagation(),d(a),s(!0)},w=()=>{s(!1),d(null)},G=async()=>{if(l)try{await L.getInstance().deleteKnowledgeBase(l),w(),$()}catch(a){console.error("删除知识库失败:",a)}},F=a=>new Date(a).toLocaleDateString();return e.jsxs(Ue,{children:[e.jsx(ye,{position:"fixed",elevation:0,sx:{zIndex:a=>a.zIndex.drawer+1,bgcolor:"background.paper",color:"text.primary",borderBottom:1,borderColor:"divider"},children:e.jsxs(we,{children:[e.jsx(A,{edge:"start",onClick:j,"aria-label":"back",sx:{color:a=>a.palette.primary.main},children:e.jsx(re,{size:20})}),e.jsx(h,{variant:"h6",component:"div",sx:{flexGrow:1,fontWeight:600},children:"知识库管理"}),e.jsx(v,{variant:"contained",startIcon:e.jsx(J,{size:20}),onClick:()=>f(),sx:{background:"linear-gradient(45deg, #059669 30%, #10b981 90%)","&:hover":{background:"linear-gradient(45deg, #047857 30%, #059669 90%)"}},children:"添加知识库"})]})}),e.jsxs(o,{sx:{flexGrow:1,overflow:"auto",px:2,py:2,mt:8},children:[T&&e.jsx(_,{severity:"error",sx:{mb:3},children:T}),C?e.jsx(o,{display:"flex",justifyContent:"center",my:5,children:e.jsx(X,{})}):u.length===0?e.jsxs(q,{sx:{p:4,textAlign:"center",my:5,borderRadius:2},children:[e.jsx(h,{variant:"body1",color:"textSecondary",gutterBottom:!0,children:"暂无知识库"}),e.jsx(v,{variant:"contained",startIcon:e.jsx(J,{size:20}),onClick:()=>f(),sx:{mt:2,background:"linear-gradient(45deg, #059669 30%, #10b981 90%)","&:hover":{background:"linear-gradient(45deg, #047857 30%, #059669 90%)"}},children:"创建第一个知识库"})]}):e.jsx(o,{sx:{display:"flex",flexWrap:"wrap",margin:-1},children:u.map(a=>e.jsx(o,{sx:{width:{xs:"100%",sm:"50%",md:"33.33%"},p:1},children:e.jsxs(Ve,{onClick:()=>S(a.id),children:[e.jsxs(me,{sx:{flexGrow:1},children:[e.jsxs(o,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(ve,{sx:{mr:1,bgcolor:"primary.main"},children:e.jsx(Fe,{size:20})}),e.jsx(h,{variant:"h6",noWrap:!0,children:a.name})]}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2,height:40,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:a.description||"无描述"}),e.jsxs(o,{display:"flex",flexWrap:"wrap",gap:.5,children:[e.jsxs(h,{variant:"caption",color:"text.secondary",children:["模型: ",a.model]}),e.jsxs(h,{variant:"caption",color:"text.secondary",children:["• 创建: ",F(a.created_at)]})]})]}),e.jsx(le,{}),e.jsxs(Me,{children:[e.jsx(A,{size:"small",onClick:r=>{r.stopPropagation(),f(a)},children:e.jsx(ke,{size:16})}),e.jsx(A,{size:"small",onClick:r=>k(a.id,r),children:e.jsx(Z,{size:16})}),e.jsx(o,{flexGrow:1}),e.jsx(v,{size:"small",variant:"outlined",startIcon:e.jsx(Ce,{size:16}),onClick:()=>S(a.id),children:"查看"})]})]})},a.id))})]}),e.jsx(Ge,{open:x,onClose:I,onSave:R,initialData:b||void 0,isEditing:!!b}),e.jsxs(oe,{open:n,onClose:w,children:[e.jsx(ie,{children:"确认删除"}),e.jsx(ce,{children:e.jsx(h,{children:"确认要删除这个知识库吗？此操作将删除所有相关文档，无法撤销。"})}),e.jsxs(de,{children:[e.jsx(v,{onClick:w,children:"取消"}),e.jsx(v,{onClick:G,color:"error",children:"删除"})]})]})]})},qe=V("input")({clip:"rect(0 0 0 0)",clipPath:"inset(50%)",height:1,overflow:"hidden",position:"absolute",bottom:0,left:0,whiteSpace:"nowrap",width:1}),Ze=({knowledgeBaseId:t,onDocumentsAdded:n})=>{const[s,l]=c.useState([]),[d,x]=c.useState(!0),[y,b]=c.useState(!1),[g,u]=c.useState(""),[C,T]=c.useState({active:!1,current:0,total:0}),[$,S]=c.useState(!1),[j,f]=c.useState(null),I=c.useRef(null),R=c.useRef(null),k=L.getInstance(),w=async()=>{try{x(!0);const i=await k.getDocumentsByKnowledgeBaseId(t);l(i)}catch(i){console.error("加载文档失败:",i),f("无法加载文档列表，请稍后再试")}finally{x(!1)}};c.useEffect(()=>(t&&w(),()=>{R.current&&R.current.abort()}),[t]);const G=async i=>{const m=i.target.files;if(!(!m||m.length===0)){b(!0),f(null);try{T({active:!0,current:0,total:m.length});for(let D=0;D<m.length;D++){const B=m[D];try{const K=await F(B);T(fe=>({...fe,current:D+1})),await k.addDocument({knowledgeBaseId:t,content:K,metadata:{source:B.name,fileName:B.name}})}catch(K){console.error(`处理文件 ${B.name} 失败:`,K),f(`处理文件 ${B.name} 失败，请检查文件格式`)}}w(),n&&n()}catch(D){console.error("文件上传失败:",D),f("文件上传失败，请稍后再试")}finally{b(!1),T({active:!1,current:0,total:0}),I.current&&(I.current.value="")}}},F=i=>new Promise((m,D)=>{const B=new FileReader;B.onload=K=>{K.target?.result?m(K.target.result):D(new Error("读取文件失败"))},B.onerror=()=>D(new Error("读取文件出错")),B.readAsText(i)}),a=i=>{u(i.target.value)},r=async i=>{try{await k.deleteDocument(i),w()}catch(m){console.error("删除文档失败:",m),f("删除文档失败，请稍后再试")}},p=c.useCallback(async()=>{try{x(!0),await Promise.all(s.map(i=>k.deleteDocument(i.id))),w()}catch(i){console.error("清理文档失败:",i),f("清理文档失败，请稍后再试")}finally{S(!1),x(!1)}},[s,k]),H=s.filter(i=>{if(!g)return!0;const m=g.toLowerCase();return i.content.toLowerCase().includes(m)||i.metadata.fileName?.toLowerCase().includes(m)||i.metadata.source.toLowerCase().includes(m)});return e.jsxs(o,{sx:{width:"100%",overflow:"auto",maxHeight:"calc(100vh - 300px)"},children:[e.jsxs(ge,{direction:{xs:"column",sm:"row"},spacing:2,mb:2,alignItems:"center",children:[e.jsx(xe,{placeholder:"搜索文档...",variant:"outlined",size:"small",fullWidth:!0,value:g,onChange:a,disabled:d,slotProps:{input:{startAdornment:e.jsx(U,{position:"start",children:e.jsx(je,{size:20})}),endAdornment:g?e.jsx(U,{position:"end",children:e.jsx(A,{onClick:()=>u(""),size:"small","aria-label":"清除搜索",children:e.jsx(he,{size:20})})}):null}}}),e.jsxs(v,{component:"label",variant:"contained",startIcon:e.jsx(Se,{}),disabled:y,children:[y?"上传中...":"上传文档",e.jsx(qe,{ref:I,type:"file",onChange:G,multiple:!0,accept:".txt,.md,.csv,.json"})]}),s.length>0&&e.jsx(v,{variant:"outlined",color:"error",startIcon:e.jsx(Z,{}),onClick:()=>S(!0),disabled:y||d,children:"一键清理"})]}),j&&e.jsx(_,{severity:"error",sx:{mb:2},onClose:()=>f(null),children:j}),C.active&&e.jsxs(o,{mb:2,children:[e.jsxs(h,{variant:"body2",gutterBottom:!0,children:["处理文件 (",C.current,"/",C.total,")"]}),e.jsx(Ie,{variant:"determinate",value:C.current/C.total*100})]}),e.jsx(q,{variant:"outlined",children:d?e.jsxs(o,{display:"flex",justifyContent:"center",alignItems:"center",p:4,children:[e.jsx(X,{size:32}),e.jsx(h,{ml:2,variant:"body1",children:"加载文档中..."})]}):H.length>0?e.jsx(ue,{children:H.map((i,m)=>e.jsxs(De.Fragment,{children:[m>0&&e.jsx(le,{}),e.jsxs(Be,{secondaryAction:e.jsx(A,{edge:"end",onClick:()=>r(i.id),"aria-label":"删除",size:"small",children:e.jsx(Z,{size:20})}),children:[e.jsx(ze,{children:e.jsx(Ne,{})}),e.jsx(Te,{primary:i.metadata.fileName||"未命名文档",secondary:e.jsxs(o,{component:"span",children:[e.jsxs(h,{sx:{display:"inline"},component:"span",variant:"body2",color:"text.primary",children:[i.content.substring(0,100),i.content.length>100?"...":""]}),e.jsx("br",{}),e.jsxs(o,{mt:.5,children:[e.jsx(z,{label:`块 #${i.metadata.chunkIndex||0}`,size:"small",sx:{mr:.5}}),e.jsx(z,{label:new Date(i.metadata.timestamp).toLocaleDateString(),size:"small",variant:"outlined"})]})]})})]})]},i.id))}):e.jsx(o,{p:4,textAlign:"center",children:e.jsx(h,{color:"textSecondary",children:g?"没有找到匹配的文档":"暂无文档，请上传文件或添加URL"})})}),e.jsxs(oe,{open:$,onClose:()=>S(!1),children:[e.jsx(ie,{children:"确认清理所有文档"}),e.jsx(ce,{children:e.jsxs(Re,{children:["确定要删除知识库中的所有 ",s.length," 个文档吗？此操作不可撤销。"]})}),e.jsxs(de,{children:[e.jsx(v,{onClick:()=>S(!1),children:"取消"}),e.jsx(v,{onClick:p,color:"error",children:"清理全部"})]})]})]})},_e=({knowledgeBaseId:t,onInsertReference:n})=>{const[s,l]=c.useState(""),[d,x]=c.useState([]),[y,b]=c.useState(!1),[g,u]=c.useState(null),[C,T]=c.useState(.7),[$,S]=c.useState(5),[j,f]=c.useState(!0),[I,R]=c.useState(null),k=Ae(r=>r.messages.currentTopicId);c.useEffect(()=>{(async()=>{try{const p=await L.getInstance().getKnowledgeBase(t);p&&(T(p.threshold||.7),S(p.documentCount||5))}catch(p){console.error("Error fetching knowledge base details:",p)}})()},[t]);const w=async()=>{if(!s.trim()){u("请输入搜索内容");return}b(!0),u(null),R(null);const r=Date.now();try{const p=await L.getInstance().search({knowledgeBaseId:t,query:s.trim(),threshold:C,limit:$,useEnhancedRAG:j}),H=Date.now();R(H-r),x(p),p.length===0&&u("没有找到匹配的内容")}catch(p){console.error("Search error:",p),u("搜索过程中发生错误")}finally{b(!1)}},G=()=>{l(""),x([]),u(null)},F=r=>{r.key==="Enter"&&w()},a=async r=>{try{if(!k){u("未选择会话");return}await He.createKnowledgeReferenceBlockFromSearchResult(k,r,t,s),n&&n(r.documentId,r.content)}catch(p){console.error("Error inserting reference:",p),u("插入引用失败")}};return e.jsxs(o,{sx:{width:"100%",overflow:"auto",maxHeight:"calc(100vh - 300px)"},children:[e.jsxs(q,{elevation:0,sx:{p:2,mb:2},children:[e.jsxs(o,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(h,{variant:"subtitle1",children:"知识库搜索"}),e.jsx($e,{title:j?"增强RAG搜索：使用查询扩展、混合搜索和重排序":"简单搜索：仅使用向量相似度",children:e.jsx(Ke,{control:e.jsx(Ee,{checked:j,onChange:r=>f(r.target.checked)}),label:e.jsxs(o,{display:"flex",alignItems:"center",gap:.5,children:[j?e.jsx(Y,{size:16}):e.jsx(ee,{size:16}),e.jsx(h,{variant:"caption",children:j?"增强RAG":"简单搜索"})]})})})]}),e.jsx(xe,{fullWidth:!0,variant:"outlined",size:"small",placeholder:"输入搜索内容...",value:s,onChange:r=>l(r.target.value),onKeyDown:F,slotProps:{input:{startAdornment:e.jsx(U,{position:"start",children:e.jsx(je,{size:20})}),endAdornment:s&&e.jsx(U,{position:"end",children:e.jsx(A,{size:"small",onClick:G,children:e.jsx(he,{size:16})})})}},sx:{mb:1}}),e.jsx(v,{variant:"contained",color:"primary",onClick:w,disabled:y||!s.trim(),fullWidth:!0,children:y?e.jsx(X,{size:24,color:"inherit"}):"搜索"})]}),g&&e.jsx(_,{severity:"info",sx:{mb:2},children:g}),d.length>0&&e.jsxs(o,{children:[e.jsxs(o,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,children:[e.jsxs(h,{variant:"subtitle2",children:["搜索结果 (",d.length,")"]}),e.jsxs(o,{display:"flex",gap:1,children:[I&&e.jsx(z,{label:`${I}ms`,size:"small",variant:"outlined",color:"primary"}),e.jsx(z,{label:j?"增强RAG":"简单搜索",size:"small",color:j?"success":"default",icon:j?e.jsx(Y,{size:16}):e.jsx(ee,{size:16})})]})]}),e.jsx(ue,{disablePadding:!0,children:d.map(r=>e.jsx(pe,{variant:"outlined",sx:{mb:1},children:e.jsx(me,{sx:{p:2,"&:last-child":{pb:2}},children:e.jsxs(ge,{spacing:1,children:[e.jsx(h,{variant:"body2",component:"div",sx:{fontSize:"0.875rem",mb:1,maxHeight:100,overflow:"auto"},children:r.content}),e.jsxs(o,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(h,{variant:"caption",color:"text.secondary",children:["相似度: ",(r.similarity*100).toFixed(1),"%"]}),e.jsx(v,{size:"small",variant:"outlined",startIcon:e.jsx(Oe,{size:16}),onClick:()=>a(r),children:"插入引用"})]})]})})},r.documentId))})]})]})},Ye=V(o)(({theme:t})=>({padding:t.spacing(2),maxWidth:1e3,margin:"0 auto",display:"flex",flexDirection:"column",minHeight:"100vh",position:"relative"}));function se(t){const{children:n,value:s,index:l,...d}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==l,id:`knowledge-tabpanel-${l}`,"aria-labelledby":`knowledge-tab-${l}`,style:{width:"100%",overflow:"visible"},...d,children:s===l&&e.jsx(o,{sx:{pt:2},children:n})})}const Qe=()=>{const{id:t}=Pe(),n=ne(),[s,l]=c.useState(0),{selectKnowledgeBase:d,selectedKnowledgeBase:x}=ae();c.useEffect(()=>{t&&d(t)},[t,d]);const y=(g,u)=>{l(u)},b=()=>{n("/knowledge")};return t?e.jsxs(Ye,{children:[e.jsxs(o,{display:"flex",alignItems:"center",mb:2,position:"sticky",top:0,bgcolor:"background.paper",zIndex:1,children:[e.jsx(A,{onClick:b,size:"small",sx:{mr:1},children:e.jsx(re,{size:20})}),e.jsx(h,{variant:"h5",component:"h1",sx:{flexGrow:1},children:x?.name||"知识库详情"})]}),e.jsx(o,{sx:{flexGrow:1,overflow:"auto"},children:x?e.jsxs(e.Fragment,{children:[e.jsxs(q,{elevation:0,sx:{mb:2,p:2},children:[e.jsx(h,{variant:"body1",paragraph:!0,children:x.description||"没有描述"}),e.jsxs(o,{display:"flex",gap:1,flexWrap:"wrap",children:[e.jsx(z,{label:`模型: ${x.model}`,size:"small",color:"primary",variant:"outlined"}),e.jsx(z,{label:`维度: ${x.dimensions}`,size:"small",color:"primary",variant:"outlined"}),e.jsx(z,{label:`块大小: ${x.chunkSize}`,size:"small",color:"primary",variant:"outlined"}),e.jsx(z,{label:`重叠: ${x.chunkOverlap}`,size:"small",color:"primary",variant:"outlined"}),e.jsx(z,{label:`阈值: ${x.threshold}`,size:"small",color:"primary",variant:"outlined"})]})]}),e.jsx(o,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(We,{value:s,onChange:y,"aria-label":"知识库功能标签",variant:"fullWidth",children:[e.jsx(te,{label:"文档管理"}),e.jsx(te,{label:"知识搜索"})]})}),e.jsx(se,{value:s,index:0,children:e.jsx(Ze,{knowledgeBaseId:t})}),e.jsx(se,{value:s,index:1,children:e.jsx(_e,{knowledgeBaseId:t})})]}):e.jsx(o,{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",children:e.jsx(X,{})})})]}):(n("/knowledge"),null)},ut=()=>e.jsxs(Le,{children:[e.jsx(Q,{path:"/",element:e.jsx(Xe,{})}),e.jsx(Q,{path:"/:id",element:e.jsx(Qe,{})})]});export{ut as default};
