import{u as de,r as c,aZ as x,j as e,B as i,a as l,A as ce,T as xe,I as F,b as me,d as o,f as d,P as v,a_ as I,e as S,X as G,a2 as pe,Y as A,a5 as D,Z as B,ac as C,ag as he,i as ge,k as M,m as T,n as H,G as w,H as ue,J as be,S as fe,K as Y,af as ye,aO as je,o as O,aR as ve,g as Se,D as Ce,ah as we}from"./index-Bp4oiTTd.js";import{P as L}from"./plus-DzgKc2iD.js";import{L as E}from"./ListItemButton-ypcwwCi0.js";import{L as R}from"./ListItemAvatar-6gKGS2AR.js";const Ie=()=>{const J=de(),[b,Z]=c.useState([]),[K,h]=c.useState(!1),[X,f]=c.useState(!1),[_,q]=c.useState([]),[Q,g]=c.useState(!1),[k,U]=c.useState(""),[u,n]=c.useState({open:!1,message:"",severity:"success"}),[W,N]=c.useState(null),[s,m]=c.useState({name:"",type:"httpStream",description:"",baseUrl:"",isActive:!1,enableSSE:!1});c.useEffect(()=>{p(),V()},[]);const p=()=>{const r=x.getServers();Z(r)},V=()=>{try{const r=x.getBuiltinServers();q(r)}catch(r){console.error("加载内置服务器失败:",r)}},ee=()=>{J("/settings")},re=async(r,a)=>{try{await x.toggleServer(r,a),p(),n({open:!0,message:a?"服务器已启用":"服务器已停用",severity:"success"})}catch{n({open:!0,message:"操作失败",severity:"error"})}},se=async()=>{if(!s.name||!s.type){n({open:!0,message:"请填写必要信息",severity:"error"});return}if(s.type==="httpStream"&&!s.baseUrl){n({open:!0,message:"HTTP Stream 服务器需要提供 URL",severity:"error"});return}try{const r={id:Date.now().toString(),name:s.name,type:s.type,description:s.description,baseUrl:s.baseUrl,isActive:!1,headers:{},env:{},args:[]};await x.addServer(r),p(),h(!1),m({name:"",type:"httpStream",description:"",baseUrl:"",isActive:!1,enableSSE:!1}),n({open:!0,message:"服务器添加成功",severity:"success"})}catch{n({open:!0,message:"添加失败",severity:"error"})}},z=r=>b.some(a=>a.name===r),te=async r=>{if(z(r.name)){n({open:!0,message:`服务器 ${r.name} 已存在`,severity:"warning"});return}try{await x.addBuiltinServer(r.name,{description:r.description,env:r.env,args:r.args,tags:r.tags,provider:r.provider}),p(),n({open:!0,message:`内置服务器 ${r.name} 添加成功`,severity:"success"})}catch{n({open:!0,message:"添加内置服务器失败",severity:"error"})}},oe=r=>{J(`/settings/mcp-server/${r.id}`,{state:{server:r}})},ae=async r=>{if(!W){N(r.id);try{await x.removeServer(r.id),p(),n({open:!0,message:`服务器 "${r.name}" 已删除`,severity:"success"})}catch{n({open:!0,message:"删除失败",severity:"error"})}finally{N(null)}}},ie=async()=>{try{const r=JSON.parse(k);if(!r.mcpServers||typeof r.mcpServers!="object")throw new Error("JSON 格式不正确：缺少 mcpServers 字段");let a=0;const t=[];for(const[P,$]of Object.entries(r.mcpServers))try{const j={id:Date.now().toString()+Math.random().toString(36).substring(2,11),name:P,type:$.type||"sse",baseUrl:$.url,description:`从 JSON 导入的服务器: ${P}`,isActive:!1,headers:{},env:{},args:[]};await x.addServer(j),a++}catch(j){t.push(`${P}: ${j instanceof Error?j.message:"未知错误"}`)}p(),g(!1),U(""),a>0?n({open:!0,message:`成功导入 ${a} 个服务器${t.length>0?`，${t.length} 个失败`:""}`,severity:t.length>0?"error":"success"}):n({open:!0,message:"导入失败："+t.join("; "),severity:"error"})}catch(r){n({open:!0,message:`JSON 解析失败: ${r instanceof Error?r.message:"未知错误"}`,severity:"error"})}},ne=r=>{switch(r){case"httpStream":return e.jsx(we,{});case"inMemory":return e.jsx(Ce,{});default:return e.jsx(I,{})}},le=r=>{switch(r){case"httpStream":return"HTTP Stream";case"inMemory":return"内存";default:return"未知"}},y=r=>{switch(r){case"httpStream":return"#9c27b0";case"inMemory":return"#ff9800";default:return"#9e9e9e"}};return e.jsxs(i,{sx:{flexGrow:1,display:"flex",flexDirection:"column",height:"100vh",bgcolor:r=>r.palette.mode==="light"?l(r.palette.primary.main,.02):l(r.palette.background.default,.9)},children:[e.jsx(ce,{position:"fixed",elevation:0,sx:{zIndex:r=>r.zIndex.drawer+1,bgcolor:"background.paper",color:"text.primary",borderBottom:1,borderColor:"divider",backdropFilter:"blur(8px)"},children:e.jsxs(xe,{children:[e.jsx(F,{edge:"start",color:"inherit",onClick:ee,"aria-label":"back",sx:{color:r=>r.palette.primary.main},children:e.jsx(me,{})}),e.jsx(o,{variant:"h6",component:"div",sx:{flexGrow:1,fontWeight:600,backgroundImage:"linear-gradient(90deg, #9333EA, #754AB4)",backgroundClip:"text",color:"transparent"},children:"MCP 服务器"}),e.jsx(d,{startIcon:e.jsx(L,{}),onClick:()=>h(!0),sx:{bgcolor:r=>l(r.palette.primary.main,.1),color:"primary.main","&:hover":{bgcolor:r=>l(r.palette.primary.main,.2)},borderRadius:2},children:"添加"})]})}),e.jsxs(i,{sx:{flexGrow:1,overflowY:"auto",p:{xs:1,sm:2},mt:8,"&::-webkit-scrollbar":{width:{xs:"4px",sm:"6px"}},"&::-webkit-scrollbar-thumb":{backgroundColor:"rgba(0,0,0,0.1)",borderRadius:"3px"}},children:[b.length===0?e.jsx(v,{elevation:0,sx:{mb:2,borderRadius:2,border:"1px solid",borderColor:"divider",overflow:"hidden",bgcolor:"background.paper",boxShadow:"0 4px 12px rgba(0,0,0,0.05)"},children:e.jsxs(i,{sx:{p:{xs:3,sm:4},textAlign:"center"},children:[e.jsx(i,{sx:{mb:{xs:1.5,sm:2}},children:e.jsx(I,{size:48,style:{color:"#9333EA"}})}),e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:600,fontSize:{xs:"1.1rem",sm:"1.25rem"}},children:"还没有配置 MCP 服务器"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:{xs:2.5,sm:3},fontSize:{xs:"0.875rem",sm:"0.875rem"}},children:"MCP 服务器可以为 AI 提供额外的工具和功能"}),e.jsxs(i,{sx:{display:"flex",gap:{xs:1.5,sm:2},flexWrap:"wrap",justifyContent:"center",flexDirection:{xs:"column",sm:"row"},alignItems:"center"},children:[e.jsx(d,{variant:"contained",startIcon:e.jsx(L,{}),onClick:()=>h(!0),fullWidth:window.innerWidth<600,sx:{bgcolor:"primary.main","&:hover":{bgcolor:"primary.dark"},minHeight:{xs:44,sm:36},fontSize:{xs:"0.9rem",sm:"0.875rem"}},children:"添加服务器"}),e.jsx(d,{variant:"outlined",onClick:()=>g(!0),fullWidth:window.innerWidth<600,sx:{borderColor:"primary.main",color:"primary.main","&:hover":{borderColor:"primary.dark",color:"primary.dark"},minHeight:{xs:44,sm:36},fontSize:{xs:"0.9rem",sm:"0.875rem"}},children:"导入配置"}),e.jsx(d,{variant:"outlined",onClick:()=>f(!0),fullWidth:window.innerWidth<600,sx:{borderColor:"primary.main",color:"primary.main","&:hover":{borderColor:"primary.dark",color:"primary.dark"},minHeight:{xs:44,sm:36},fontSize:{xs:"0.9rem",sm:"0.875rem"}},children:"内置服务器"})]})]})}):e.jsxs(v,{elevation:0,sx:{mb:2,borderRadius:2,border:"1px solid",borderColor:"divider",overflow:"hidden",bgcolor:"background.paper",boxShadow:"0 4px 12px rgba(0,0,0,0.05)"},children:[e.jsxs(i,{sx:{p:{xs:1.5,sm:2},bgcolor:"rgba(0,0,0,0.01)"},children:[e.jsx(o,{variant:"subtitle1",sx:{fontWeight:600,fontSize:{xs:"1rem",sm:"1.1rem"}},children:"MCP 服务器列表"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"0.875rem"}},children:"管理您的 MCP 服务器配置和状态"})]}),e.jsx(S,{}),e.jsx(G,{disablePadding:!0,children:b.map((r,a)=>e.jsxs(pe.Fragment,{children:[e.jsxs(A,{disablePadding:!0,sx:{transition:"all 0.2s","&:hover":{bgcolor:t=>l(t.palette.primary.main,.05)}},children:[e.jsxs(E,{onClick:()=>oe(r),sx:{flex:1},children:[e.jsx(R,{children:e.jsx(D,{sx:{bgcolor:l(y(r.type),.12),color:y(r.type),boxShadow:"0 2px 6px rgba(0,0,0,0.05)"},children:ne(r.type)})}),e.jsx(B,{primary:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:1},flexWrap:"wrap"},children:[e.jsx(o,{sx:{fontWeight:600,color:"text.primary",fontSize:{xs:"0.9rem",sm:"1rem"}},children:r.name}),e.jsx(C,{label:le(r.type),size:"small",sx:{bgcolor:l(y(r.type),.1),color:y(r.type),fontWeight:500,fontSize:{xs:"0.7rem",sm:"0.75rem"},height:{xs:20,sm:24}}}),r.isActive&&e.jsx(C,{label:"运行中",size:"small",color:"success",variant:"outlined",sx:{fontSize:{xs:"0.7rem",sm:"0.75rem"},height:{xs:20,sm:24}}})]}),secondary:e.jsxs(i,{component:"div",sx:{mt:{xs:.5,sm:1}},children:[r.description&&e.jsx(o,{variant:"body2",color:"text.secondary",component:"div",sx:{fontSize:{xs:"0.8rem",sm:"0.875rem"},lineHeight:1.4,display:"-webkit-box",WebkitLineClamp:{xs:2,sm:3},WebkitBoxOrient:"vertical",overflow:"hidden"},children:r.description}),r.baseUrl&&e.jsx(o,{variant:"caption",color:"text.secondary",component:"div",sx:{fontSize:{xs:"0.7rem",sm:"0.75rem"},mt:.5,wordBreak:"break-all"},children:r.baseUrl})]})})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,pr:2},children:[e.jsx(he,{checked:r.isActive,onChange:t=>{t.stopPropagation(),re(r.id,t.target.checked)}}),e.jsx(F,{onClick:t=>{t.stopPropagation(),ae(r)},size:"small",disabled:W===r.id,sx:{color:W===r.id?"text.disabled":"error.main","&:hover":{bgcolor:t=>l(t.palette.error.main,.1)}},children:e.jsx(ge,{size:18})})]})]}),a<b.length-1&&e.jsx(S,{variant:"inset",component:"li",sx:{ml:0}})]},r.id))})]}),e.jsxs(v,{elevation:0,sx:{mb:2,borderRadius:2,border:"1px solid",borderColor:"divider",overflow:"hidden",bgcolor:"background.paper",boxShadow:"0 4px 12px rgba(0,0,0,0.05)"},children:[e.jsxs(i,{sx:{p:{xs:1.5,sm:2},bgcolor:"rgba(0,0,0,0.01)"},children:[e.jsx(o,{variant:"subtitle1",sx:{fontWeight:600,fontSize:{xs:"1rem",sm:"1.1rem"}},children:"快捷操作"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"0.875rem"}},children:"快速添加和管理 MCP 服务器"})]}),e.jsx(S,{}),e.jsxs(G,{disablePadding:!0,children:[e.jsx(A,{disablePadding:!0,children:e.jsxs(E,{onClick:()=>g(!0),sx:{transition:"all 0.2s","&:hover":{bgcolor:r=>l(r.palette.primary.main,.05)}},children:[e.jsx(R,{children:e.jsx(D,{sx:{bgcolor:l("#06b6d4",.12),color:"#06b6d4",boxShadow:"0 2px 6px rgba(0,0,0,0.05)"},children:e.jsx(L,{})})}),e.jsx(B,{primary:e.jsx(o,{sx:{fontWeight:600,color:"text.primary",fontSize:{xs:"0.9rem",sm:"1rem"}},children:"导入配置"}),secondary:e.jsx(o,{sx:{fontSize:{xs:"0.8rem",sm:"0.875rem"}},children:"从 JSON 文件导入 MCP 服务器配置"})})]})}),e.jsx(S,{variant:"inset",component:"li",sx:{ml:0}}),e.jsx(A,{disablePadding:!0,children:e.jsxs(E,{onClick:()=>f(!0),sx:{transition:"all 0.2s","&:hover":{bgcolor:r=>l(r.palette.primary.main,.05)}},children:[e.jsx(R,{children:e.jsx(D,{sx:{bgcolor:l("#8b5cf6",.12),color:"#8b5cf6",boxShadow:"0 2px 6px rgba(0,0,0,0.05)"},children:e.jsx(I,{})})}),e.jsx(B,{primary:e.jsx(o,{sx:{fontWeight:600,color:"text.primary",fontSize:{xs:"0.9rem",sm:"1rem"}},children:"内置服务器"}),secondary:e.jsx(o,{sx:{fontSize:{xs:"0.8rem",sm:"0.875rem"}},children:"添加预配置的内置 MCP 服务器"})})]})})]})]})]}),e.jsxs(M,{open:K,onClose:()=>h(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(T,{children:"添加 MCP 服务器"}),e.jsxs(H,{children:[e.jsx(w,{autoFocus:!0,margin:"dense",label:"服务器名称",fullWidth:!0,variant:"outlined",value:s.name,onChange:r=>m({...s,name:r.target.value}),sx:{mb:2}}),e.jsxs(ue,{fullWidth:!0,sx:{mb:2},children:[e.jsx(be,{children:"服务器类型"}),e.jsxs(fe,{value:s.type,label:"服务器类型",onChange:r=>m({...s,type:r.target.value}),children:[e.jsx(Y,{value:"httpStream",children:"HTTP Stream (支持SSE+HTTP)"}),e.jsx(Y,{value:"inMemory",children:"内存服务器"})]})]}),s.type==="httpStream"&&e.jsx(w,{margin:"dense",label:"服务器 URL",fullWidth:!0,variant:"outlined",value:s.baseUrl,onChange:r=>m({...s,baseUrl:r.target.value}),placeholder:"https://example.com/mcp",sx:{mb:2}}),e.jsx(w,{margin:"dense",label:"描述（可选）",fullWidth:!0,variant:"outlined",multiline:!0,rows:2,value:s.description,onChange:r=>m({...s,description:r.target.value})}),s.type==="httpStream"&&e.jsx(ye,{control:e.jsx(je,{checked:s.enableSSE===!0,onChange:r=>m({...s,enableSSE:r.target.checked})}),label:"启用SSE流（Server-Sent Events）",sx:{mt:1}})]}),e.jsxs(O,{children:[e.jsx(d,{onClick:()=>h(!1),children:"取消"}),e.jsx(d,{onClick:se,variant:"contained",children:"添加"})]})]}),e.jsxs(M,{open:Q,onClose:()=>g(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(T,{children:"导入 MCP 服务器配置"}),e.jsxs(H,{children:[e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"粘贴包含 MCP 服务器配置的 JSON 文件内容。支持的格式示例："}),e.jsx(i,{sx:{bgcolor:"grey.100",p:2,borderRadius:1,mb:2,fontFamily:"monospace",fontSize:"0.875rem"},children:`{
  "mcpServers": {
    "fetch": {
      "type": "sse",
      "url": "https://mcp.api-inference.modelscope.cn/sse/89261d74d6814a"
    },
    "memory": {
      "type": "streamableHttp",
      "url": "https://example.com/mcp/memory"
    }
  }
}`}),e.jsx(w,{autoFocus:!0,margin:"dense",label:"JSON 配置",fullWidth:!0,multiline:!0,rows:10,variant:"outlined",value:k,onChange:r=>U(r.target.value),placeholder:"在此粘贴 JSON 配置..."})]}),e.jsxs(O,{children:[e.jsx(d,{onClick:()=>g(!1),children:"取消"}),e.jsx(d,{onClick:ie,variant:"contained",disabled:!k.trim(),children:"导入"})]})]}),e.jsxs(M,{open:X,onClose:()=>f(!1),maxWidth:"md",fullWidth:!0,fullScreen:window.innerWidth<600,sx:{"& .MuiDialog-paper":{maxHeight:{xs:"100vh",sm:"90vh"},margin:{xs:0,sm:2},borderRadius:{xs:0,sm:2}}},children:[e.jsx(T,{sx:{px:{xs:2,sm:3},py:{xs:2,sm:2.5},fontSize:{xs:"1.25rem",sm:"1.5rem"},fontWeight:600,borderBottom:"1px solid",borderColor:"divider"},children:"添加内置 MCP 服务器"}),e.jsxs(H,{sx:{px:{xs:2,sm:3},py:{xs:2,sm:3}},children:[e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:{xs:2,sm:3},fontSize:{xs:"0.875rem",sm:"0.875rem"},lineHeight:1.5},children:"选择要添加的内置 MCP 服务器。这些服务器由 Cherry Studio 提供，无需额外配置即可使用。"}),e.jsx(i,{sx:{display:"flex",flexDirection:"column",gap:{xs:1.5,sm:2},maxHeight:{xs:"calc(100vh - 200px)",sm:"70vh",md:"80vh"},overflow:"auto",pr:{xs:.5,sm:1},WebkitOverflowScrolling:"touch","&::-webkit-scrollbar":{width:{xs:"2px",sm:"4px"}},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:"rgba(0, 0, 0, 0.2)",borderRadius:"2px"}},children:_.map(r=>{const a=z(r.name);return e.jsx(v,{elevation:0,sx:{border:"1px solid",borderColor:a?"#d1fae5":"#e5e7eb",borderRadius:{xs:2,sm:2},transition:"all 0.2s ease-in-out",backgroundColor:a?"#f0fdf4":"#ffffff",cursor:"pointer",touchAction:"manipulation","&:hover":{borderColor:a?"#a7f3d0":"#10b981",boxShadow:{xs:"0 2px 8px rgba(0,0,0,0.06)",sm:"0 4px 12px rgba(0,0,0,0.08)"}},"&:active":{transform:{xs:"scale(0.98)",sm:"none"}}},children:e.jsxs(i,{sx:{p:{xs:2,sm:2.5,md:3},display:"flex",flexDirection:{xs:"column",sm:"row"},alignItems:{xs:"stretch",sm:"flex-start"},gap:{xs:2,sm:2.5}},children:[e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:{xs:.75,sm:1}},children:[e.jsx(o,{variant:"h6",fontWeight:600,sx:{fontSize:{xs:"1rem",sm:"1.1rem",md:"1.2rem"},color:"text.primary",lineHeight:1.3,wordBreak:"break-word"},children:r.name}),a&&e.jsx(C,{label:"已添加",size:"small",sx:{height:20,fontSize:"0.7rem",backgroundColor:"#dcfce7",color:"#166534",border:"1px solid #bbf7d0",fontWeight:500}})]}),e.jsx(o,{variant:"body2",sx:{color:"text.secondary",mb:{xs:1.5,sm:2},lineHeight:1.6,fontSize:{xs:"0.8rem",sm:"0.875rem",md:"0.9rem"},display:"-webkit-box",WebkitLineClamp:{xs:3,sm:2},WebkitBoxOrient:"vertical",overflow:"hidden"},children:r.description}),e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:{xs:.75,sm:1},flexWrap:"wrap"},children:r.tags&&r.tags.map(t=>e.jsx(C,{label:t,size:"small",variant:"outlined",sx:{fontSize:{xs:"0.7rem",sm:"0.75rem"},height:{xs:22,sm:24},borderColor:"#e5e7eb",color:"#6b7280",backgroundColor:"#f9fafb",fontWeight:500,"& .MuiChip-label":{px:{xs:1,sm:1.5}},"&:hover":{borderColor:"#10b981",backgroundColor:l("#10b981",.05)}}},t))})]}),e.jsx(i,{sx:{display:"flex",alignItems:{xs:"stretch",sm:"center"},flexShrink:0,mt:{xs:1,sm:0}},children:z(r.name)?e.jsx(d,{variant:"outlined",size:window.innerWidth<600?"medium":"small",fullWidth:window.innerWidth<600,disabled:!0,sx:{borderColor:"#d1d5db",color:"#6b7280",borderRadius:{xs:2,sm:1.5},px:{xs:3,sm:2},py:{xs:1,sm:.75},fontWeight:500,fontSize:{xs:"0.9rem",sm:"0.875rem"},textTransform:"none",minWidth:{xs:"auto",sm:"auto"},minHeight:{xs:44,sm:"auto"},cursor:"default"},children:"已添加"}):e.jsx(d,{onClick:t=>{t.stopPropagation(),te(r)},variant:"contained",size:window.innerWidth<600?"medium":"small",fullWidth:window.innerWidth<600,sx:{backgroundColor:"#10b981",color:"white",borderRadius:{xs:2,sm:1.5},px:{xs:3,sm:2},py:{xs:1,sm:.75},fontWeight:500,fontSize:{xs:"0.9rem",sm:"0.875rem"},textTransform:"none",minWidth:{xs:"auto",sm:"auto"},minHeight:{xs:44,sm:"auto"},"&:hover":{backgroundColor:"#059669"}},children:"添加"})})]})},r.id)})})]}),e.jsx(O,{sx:{px:{xs:2,sm:3},py:{xs:2,sm:2.5},borderTop:"1px solid",borderColor:"divider",gap:{xs:1,sm:2}},children:e.jsx(d,{onClick:()=>f(!1),variant:"outlined",fullWidth:window.innerWidth<600,sx:{minHeight:{xs:44,sm:36},fontSize:{xs:"1rem",sm:"0.875rem"}},children:"关闭"})})]}),e.jsx(ve,{open:u.open,autoHideDuration:3e3,onClose:()=>n({...u,open:!1}),children:e.jsx(Se,{severity:u.severity,onClose:()=>n({...u,open:!1}),children:u.message})})]})};export{Ie as default};
