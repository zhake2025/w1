import{j as e,B as m,d as b,g as _,G as N,I as P,br as L,H as W,J as T,S as K,K as t,L as A,N as M,r as d,f as O,aQ as J,C as D,P as E,ac as B,u as G,ae as c,A as H,T as U,b as $,a as F,ad as p}from"./index-Bp4oiTTd.js";import{o as g}from"./VoiceRecognitionService-C2ff6Zt2.js";import{I as q}from"./InputAdornment-DlY_7arK.js";import{E as Q}from"./eye-off-D4qHSTw4.js";import{S as V}from"./square-CnXLMq5X.js";import{M as Y}from"./mic-BSbeGKkG.js";const X=({settings:r,onSettingsChange:n})=>{const s=(a,u)=>{n({...r,[a]:u})},o=()=>{s("showApiKey",!r.showApiKey)};return e.jsxs(m,{sx:{py:1},children:[e.jsx(b,{variant:"h6",sx:{mb:2},children:"OpenAI Whisper 语音识别设置"}),e.jsx(_,{severity:"info",sx:{mb:3},children:"OpenAI Whisper是一个强大的语音识别模型，支持多种语言。您需要有OpenAI的API密钥才能使用此功能。"}),e.jsx(N,{fullWidth:!0,label:"OpenAI API密钥",value:r.apiKey,onChange:a=>s("apiKey",a.target.value),type:r.showApiKey?"text":"password",margin:"normal",sx:{mb:3},helperText:"请输入您的OpenAI API密钥",InputProps:{endAdornment:e.jsx(q,{position:"end",children:e.jsx(P,{"aria-label":"切换API密钥可见性",onClick:o,edge:"end",children:r.showApiKey?e.jsx(Q,{}):e.jsx(L,{})})})}}),e.jsxs(W,{fullWidth:!0,margin:"normal",sx:{mb:3},children:[e.jsx(T,{children:"Whisper模型"}),e.jsx(K,{value:r.model,onChange:a=>s("model",a.target.value),label:"Whisper模型",children:g.getAvailableModels().map(a=>e.jsx(t,{value:a,children:a},a))}),e.jsx(A,{children:"目前只有whisper-1一个模型可用"})]}),e.jsxs(W,{fullWidth:!0,margin:"normal",sx:{mb:3},children:[e.jsx(T,{children:"语言"}),e.jsxs(K,{value:r.language||"",onChange:a=>s("language",a.target.value||void 0),label:"语言",children:[e.jsx(t,{value:"",children:"自动检测"}),e.jsx(t,{value:"zh",children:"中文"}),e.jsx(t,{value:"en",children:"英语"}),e.jsx(t,{value:"ja",children:"日语"}),e.jsx(t,{value:"ko",children:"韩语"}),e.jsx(t,{value:"fr",children:"法语"}),e.jsx(t,{value:"de",children:"德语"}),e.jsx(t,{value:"es",children:"西班牙语"}),e.jsx(t,{value:"ru",children:"俄语"})]}),e.jsx(A,{children:"指定音频的语言可以提高转录准确性，留空则自动检测"})]}),e.jsxs(m,{sx:{mb:3},children:[e.jsxs(b,{id:"temperature-slider",gutterBottom:!0,children:["温度: ",r.temperature]}),e.jsx(M,{"aria-labelledby":"temperature-slider",value:r.temperature||0,onChange:(a,u)=>s("temperature",u),step:.1,marks:!0,min:0,max:1,valueLabelDisplay:"auto"}),e.jsx(A,{children:"较高的值会使输出更加随机，较低的值则使输出更加确定。建议设置为0以获得最准确的结果。"})]}),e.jsxs(W,{fullWidth:!0,margin:"normal",sx:{mb:3},children:[e.jsx(T,{children:"响应格式"}),e.jsxs(K,{value:r.responseFormat||"json",onChange:a=>s("responseFormat",a.target.value),label:"响应格式",children:[e.jsx(t,{value:"json",children:"JSON"}),e.jsx(t,{value:"text",children:"纯文本"}),e.jsx(t,{value:"srt",children:"SRT"}),e.jsx(t,{value:"verbose_json",children:"详细JSON"}),e.jsx(t,{value:"vtt",children:"VTT"})]}),e.jsx(A,{children:"选择API返回的响应格式，一般使用默认的JSON格式即可"})]})]})},Z=({settings:r,enabled:n})=>{const[s,o]=d.useState(!1),[a,u]=d.useState(!1),[h,f]=d.useState(null),[y,i]=d.useState(null),l=d.useRef(null),S=d.useRef([]),j=d.useRef(null),R=async()=>{try{if(i(null),f(null),!r.apiKey){i("请先设置OpenAI API密钥");return}g.setApiKey(r.apiKey),g.setModel(r.model),r.language&&g.setLanguage(r.language),g.setTemperature(r.temperature||0),g.setResponseFormat(r.responseFormat||"json");const v=await navigator.mediaDevices.getUserMedia({audio:!0});j.current=v;const w=new MediaRecorder(v);l.current=w,S.current=[],w.addEventListener("dataavailable",x=>{S.current.push(x.data)}),w.addEventListener("stop",async()=>{try{o(!1),u(!0);const x=new Blob(S.current,{type:"audio/webm"}),C=await g.transcribeAudio(x);f(C)}catch(x){i(x.message||"转录失败")}finally{u(!1),j.current&&(j.current.getTracks().forEach(x=>x.stop()),j.current=null)}}),w.start(),o(!0),setTimeout(()=>{l.current&&l.current.state!=="inactive"&&l.current.stop()},5e3)}catch(v){i(v.message||"无法访问麦克风"),o(!1)}},I=()=>{l.current&&l.current.state!=="inactive"&&l.current.stop()},k=()=>{f(null),i(null)};return e.jsxs(m,{sx:{mt:4,mb:2},children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"测试OpenAI Whisper语音识别"}),!n&&e.jsx(_,{severity:"warning",sx:{mb:3},children:"请先启用语音识别功能"}),y&&e.jsx(_,{severity:"error",sx:{mb:3},children:y}),e.jsxs(m,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(O,{variant:"contained",color:s?"error":"primary",startIcon:s?e.jsx(V,{}):e.jsx(Y,{}),onClick:s?I:R,disabled:!n||a||!r.apiKey,children:s?"停止录制":"开始录制"}),e.jsx(O,{variant:"outlined",startIcon:e.jsx(J,{}),onClick:k,disabled:s||a||!h&&!y,children:"清除结果"})]}),a&&e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:2,my:3},children:[e.jsx(D,{size:24}),e.jsx(b,{children:"正在处理音频..."})]}),h&&e.jsxs(E,{elevation:1,sx:{p:3,mb:3,bgcolor:"background.paper",border:"1px solid",borderColor:"divider",borderRadius:2},children:[e.jsx(b,{variant:"subtitle1",gutterBottom:!0,fontWeight:500,children:"识别结果:"}),e.jsx(b,{variant:"body1",sx:{whiteSpace:"pre-wrap"},children:h.text}),h.language&&e.jsx(B,{label:`检测到语言: ${h.language}`,color:"primary",size:"small",sx:{mt:2,mr:1}}),h.duration&&e.jsx(B,{label:`音频时长: ${h.duration.toFixed(2)}秒`,color:"secondary",size:"small",sx:{mt:2}})]}),e.jsx(_,{severity:"info",sx:{mb:2},children:'提示: 点击"开始录制"按钮，系统将录制5秒的音频，然后自动使用OpenAI Whisper API进行转录。'})]})},ie=()=>{const r=G(),[n,s]=d.useState({apiKey:"",showApiKey:!1,model:"whisper-1",language:"zh",temperature:0,responseFormat:"json"}),[o,a]=d.useState({enabled:!0,language:"zh-CN",autoStart:!1,silenceTimeout:2e3,maxResults:5,partialResults:!0,permissionStatus:"unknown",provider:"openai"}),[u,h]=d.useState({saveError:""});d.useEffect(()=>{(async()=>{try{const l=await p("whisper_api_key")||"",S=await p("whisper_model")||"whisper-1",j=await p("whisper_language")||"zh",R=Number(await p("whisper_temperature")||"0"),I=await p("whisper_response_format")||"json",k=await p("speech_recognition_enabled")!=="false",v=await p("speech_recognition_language")||"zh-CN",w=await p("speech_recognition_auto_start")==="true",x=Number(await p("speech_recognition_silence_timeout")||"2000"),C=Number(await p("speech_recognition_max_results")||"5"),z=await p("speech_recognition_partial_results")!=="false";s({apiKey:l,showApiKey:!1,model:S,language:j,temperature:R,responseFormat:I}),a({enabled:k,language:v,autoStart:w,silenceTimeout:x,maxResults:C,partialResults:z,permissionStatus:"unknown",provider:"openai"})}catch(l){console.error("加载OpenAI Whisper设置失败:",l)}})()},[]);const f=d.useCallback(async()=>{try{await c("whisper_api_key",n.apiKey),await c("whisper_model",n.model),await c("whisper_language",n.language||""),await c("whisper_temperature",n.temperature?.toString()||"0"),await c("whisper_response_format",n.responseFormat||"json"),await c("speech_recognition_enabled",o.enabled.toString()),await c("speech_recognition_language",o.language),await c("speech_recognition_auto_start",o.autoStart.toString()),await c("speech_recognition_silence_timeout",o.silenceTimeout.toString()),await c("speech_recognition_max_results",o.maxResults.toString()),await c("speech_recognition_partial_results",o.partialResults.toString()),await c("speech_recognition_provider","openai"),setTimeout(()=>{r("/settings/voice")},0)}catch(i){console.error("保存OpenAI Whisper设置失败:",i),h(l=>({...l,saveError:"保存设置失败，请重试"}))}},[n,o]),y=()=>{r("/settings/voice")};return e.jsxs(m,{sx:{display:"flex",flexDirection:"column",height:"100vh",width:"100vw",overflow:"hidden",bgcolor:"background.default"},children:[e.jsx(H,{position:"fixed",elevation:0,sx:{zIndex:i=>i.zIndex.drawer+1,bgcolor:"background.paper",color:"text.primary",borderBottom:1,borderColor:"divider",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",background:"rgba(255, 255, 255, 0.8)","@media (prefers-color-scheme: dark)":{background:"rgba(18, 18, 18, 0.8)"}},children:e.jsxs(U,{sx:{minHeight:{xs:56,sm:64},px:{xs:1,sm:2,md:3}},children:[e.jsx(P,{edge:"start",onClick:y,"aria-label":"返回",size:"large",sx:{color:"primary.main",mr:{xs:1,sm:2},"&:hover":{bgcolor:"primary.main",color:"primary.contrastText",transform:"scale(1.05)"},transition:"all 0.2s ease-in-out"},children:e.jsx($,{size:20})}),e.jsx(b,{variant:"h6",component:"div",sx:{flexGrow:1,fontWeight:600,backgroundImage:"linear-gradient(90deg, #9333EA, #754AB4)",backgroundClip:"text",WebkitBackgroundClip:"text",color:"transparent"},children:"OpenAI Whisper 设置"}),e.jsx(O,{onClick:f,variant:"contained",sx:{bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"},borderRadius:2,px:3},children:"保存"})]})}),e.jsx(m,{sx:{flexGrow:1,overflowY:"auto",p:2,mt:8,bgcolor:i=>i.palette.mode==="light"?F(i.palette.primary.main,.02):F(i.palette.background.default,.9),"&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-thumb":{backgroundColor:"rgba(0,0,0,0.1)",borderRadius:"3px"}},children:e.jsxs(m,{sx:{width:"100%"},children:[u.saveError&&e.jsx(_,{severity:"error",sx:{mb:{xs:1.5,sm:2},borderRadius:{xs:1,sm:2}},children:u.saveError}),e.jsx(E,{elevation:0,sx:{p:3,mb:3,borderRadius:2,border:"1px solid",borderColor:"divider",background:"background.paper",boxShadow:"0 4px 12px rgba(0,0,0,0.05)"},children:e.jsx(X,{settings:n,onSettingsChange:s})}),e.jsx(E,{elevation:0,sx:{p:3,mb:3,borderRadius:2,border:"1px solid",borderColor:"divider",background:"background.paper",boxShadow:"0 4px 12px rgba(0,0,0,0.05)"},children:e.jsx(Z,{settings:n,enabled:o.enabled})})]})})]})};export{ie as default};
