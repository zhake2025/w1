function s(r,e,t,n){if(typeof e=="function"?r!==e||!0:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}function f(r,e,t,n,l){if(typeof e=="function"?r!==e||!0:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(r,t),t}var d,a,h,_;const T="__TAURI_TO_IPC_KEY__";function U(r,e=!1){return window.__TAURI_INTERNALS__.transformCallback(r,e)}class j{constructor(e){d.set(this,void 0),a.set(this,0),h.set(this,[]),_.set(this,void 0),f(this,d,e||(()=>{})),this.id=U(t=>{const n=t.index;if("end"in t){n==s(this,a,"f")?this.cleanupCallback():f(this,_,n);return}const l=t.message;if(n==s(this,a,"f")){for(s(this,d,"f").call(this,l),f(this,a,s(this,a,"f")+1);s(this,a,"f")in s(this,h,"f");){const y=s(this,h,"f")[s(this,a,"f")];s(this,d,"f").call(this,y),delete s(this,h,"f")[s(this,a,"f")],f(this,a,s(this,a,"f")+1)}s(this,a,"f")===s(this,_,"f")&&this.cleanupCallback()}else s(this,h,"f")[n]=l})}cleanupCallback(){Reflect.deleteProperty(window,`_${this.id}`)}set onmessage(e){f(this,d,e)}get onmessage(){return s(this,d,"f")}[(d=new WeakMap,a=new WeakMap,h=new WeakMap,_=new WeakMap,T)](){return`__CHANNEL__:${this.id}`}toJSON(){return this[T]()}}async function w(r,e={},t){return window.__TAURI_INTERNALS__.invoke(r,e,t)}const m="Request cancelled";async function M(r,e){const t=e?.signal;if(t?.aborted)throw new Error(m);const n=e?.maxRedirections,l=e?.connectTimeout,y=e?.proxy,x=e?.danger;e&&(delete e.maxRedirections,delete e.connectTimeout,delete e.proxy,delete e.danger);const c=e?.headers?e.headers instanceof Headers?e.headers:new Headers(e.headers):new Headers,u=new Request(r,e),E=await u.arrayBuffer(),k=E.byteLength!==0?Array.from(new Uint8Array(E)):null;for(const[o,i]of u.headers)c.get(o)||c.set(o,i);const I=(c instanceof Headers?Array.from(c.entries()):Array.isArray(c)?c:Object.entries(c)).map(([o,i])=>[o,typeof i=="string"?i:i.toString()]);if(t?.aborted)throw new Error(m);const R=await w("plugin:http|fetch",{clientConfig:{method:u.method,url:u.url,headers:I,data:k,maxRedirections:n,connectTimeout:l,proxy:y,danger:x}}),C=()=>w("plugin:http|fetch_cancel",{rid:R});if(t?.aborted)throw C(),new Error(m);t?.addEventListener("abort",()=>void C());const{status:A,statusText:S,url:L,headers:N,rid:v}=await w("plugin:http|fetch_send",{rid:R}),H=[101,103,204,205,304].includes(A)?null:new ReadableStream({start:o=>{const i=new j;i.onmessage=b=>{if(t?.aborted){o.error(m);return}const p=new Uint8Array(b),O=p[p.byteLength-1],P=p.slice(0,p.byteLength-1);if(O==1){o.close();return}o.enqueue(P)},w("plugin:http|fetch_read_body",{rid:v,streamChannel:i}).catch(b=>{o.error(b)})}}),g=new Response(H,{status:A,statusText:S});return Object.defineProperty(g,"url",{value:L}),Object.defineProperty(g,"headers",{value:new Headers(N)}),g}export{M as fetch};
