import{r as t,q as j,s as C,v as S,w as E,x as k,y as K,z as w,F as P,j as e,k as G,m as q,n as J,g as Q,G as y,H as V,J as Z,S as X,K as z,L as Y,B as O,d as i,N as M,e as $,I as ee,O as se,Q as ne,R as re,o as te,f as _}from"./index-5OteHtpV.js";import{S as U}from"./Stack-6qTbuoMo.js";const ae=({open:x,onClose:b,onSave:N,initialData:n,isEditing:m=!1})=>{const[T,W]=t.useState([]),[r,u]=t.useState({name:n?.name||"",model:n?.model||"",dimensions:n?.dimensions||k,documentCount:n?.documentCount||E,chunkSize:n?.chunkSize||S,chunkOverlap:n?.chunkOverlap||C,threshold:n?.threshold||j}),[c,v]=t.useState({}),[p,A]=t.useState(!1),[f,D]=t.useState(!1),[F,h]=t.useState(null),d=t.useRef(null);t.useEffect(()=>{const s=K();if(W(s),m&&!r.model&&s.length>0){const l=s[0],a=w(l.id);u(o=>({...o,model:l.id,dimensions:a}))}},[m,r.model]),t.useEffect(()=>{u(n?{name:n.name||"",model:n.model||"",dimensions:n.dimensions||k,documentCount:n.documentCount||E,chunkSize:n.chunkSize||S,chunkOverlap:n.chunkOverlap||C,threshold:n.threshold||j}:{name:"",model:"",dimensions:k,documentCount:E,chunkSize:S,chunkOverlap:C,threshold:j})},[n]),t.useEffect(()=>{x||(v({}),h(null))},[x]),t.useEffect(()=>()=>{d.current&&d.current.abort()},[]);const g=s=>{const{name:l,value:a}=s.target;l&&(u(o=>({...o,[l]:a})),c[l]&&v(o=>{const L={...o};return delete L[l],L}))},I=t.useCallback(s=>(l,a)=>{typeof a=="number"&&u(o=>({...o,[s]:a}))},[]),R=t.useCallback(async s=>{const l=s.target.value;d.current&&d.current.abort(),d.current=new AbortController;let a;try{a=await P.getInstance().getEmbeddingDimensions(l)}catch(o){console.error("获取模型维度失败:",o),a=w(l)}d.current?.signal.aborted||u(o=>({...o,model:l,dimensions:a}))},[]),B=()=>{const s={};return r.name?.trim()||(s.name="知识库名称不能为空"),r.model||(s.model="请选择嵌入模型"),v(s),Object.keys(s).length===0},H=async()=>{if(B())try{A(!0),h(null),await N(r),b()}catch(s){console.error("保存知识库失败:",s),h(s instanceof Error?s.message:"保存知识库失败，请稍后再试")}finally{A(!1)}};return e.jsxs(G,{open:x,onClose:b,fullWidth:!0,maxWidth:"md",children:[e.jsx(q,{children:m?"编辑知识库":"创建知识库"}),e.jsx(J,{dividers:!0,children:e.jsxs(U,{spacing:3,children:[F&&e.jsx(Q,{severity:"error",onClose:()=>h(null),children:F}),e.jsx(y,{autoFocus:!0,name:"name",label:"知识库名称",fullWidth:!0,required:!0,value:r.name,onChange:g,error:!!c.name,helperText:c.name||"给知识库起一个描述性的名称"}),e.jsxs(V,{fullWidth:!0,error:!!c.model,children:[e.jsx(Z,{children:"嵌入模型 *"}),e.jsx(X,{name:"model",value:r.model||"",onChange:R,label:"嵌入模型 *",MenuProps:{disableAutoFocus:!0,disableRestoreFocus:!0},children:T.length>0?T.map(s=>e.jsxs(z,{value:s.id,children:[s.name," (来自 ",s.provider,")"]},s.id)):e.jsx(z,{disabled:!0,value:"",children:"未找到可用的嵌入模型，请先在设置中配置"})}),e.jsx(Y,{children:c.model||"用于将文本转换为向量的模型"})]}),e.jsxs(O,{children:[e.jsxs(i,{gutterBottom:!0,children:["请求文档段数量: ",r.documentCount]}),e.jsx(M,{name:"documentCount",value:r.documentCount||6,onChange:I("documentCount"),min:1,max:30,step:1,marks:[{value:1,label:"1"},{value:6,label:"默认"},{value:30,label:"30"}],valueLabelDisplay:"auto","aria-label":"文档数量"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"搜索时返回的文档段数量，影响回答的详细程度"})]}),e.jsx($,{}),e.jsxs(O,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(i,{variant:"subtitle1",fontWeight:"bold",children:"高级设置"}),e.jsx(ee,{onClick:()=>D(!f),size:"small",children:f?e.jsx(se,{size:20}):e.jsx(ne,{size:20})})]}),e.jsx(re,{in:f,children:e.jsxs(U,{spacing:3,sx:{mt:2},children:[e.jsx(y,{name:"chunkSize",label:"分块大小",type:"number",fullWidth:!0,value:r.chunkSize,onChange:g,helperText:"将文档分割成的块的大小（字符数）",slotProps:{htmlInput:{min:100,max:5e3,step:100}}}),e.jsx(y,{name:"chunkOverlap",label:"重叠大小",type:"number",fullWidth:!0,value:r.chunkOverlap,onChange:g,helperText:"每个块之间重叠的字符数",slotProps:{htmlInput:{min:0,max:1e3,step:50}}}),e.jsxs(O,{children:[e.jsxs(i,{gutterBottom:!0,children:["相似度阈值: ",r.threshold]}),e.jsx(M,{name:"threshold",value:r.threshold||.7,onChange:I("threshold"),min:0,max:1,step:.05,marks:[{value:0,label:"0"},{value:.5,label:"0.5"},{value:1,label:"1"}],valueLabelDisplay:"auto","aria-label":"相似度阈值"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"搜索结果的最低相似度分数，值越高结果越精确"})]})]})})]})}),e.jsxs(te,{children:[e.jsx(_,{onClick:b,disabled:p,children:"取消"}),e.jsx(_,{onClick:H,variant:"contained",color:"primary",disabled:p,children:p?"保存中...":m?"更新":"创建"})]})]})};export{ae as C};
