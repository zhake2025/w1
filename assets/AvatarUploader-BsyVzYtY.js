import{r as c,j as n,k as A,m as $,n as D,B as f,d as v,N as E,f as b,aN as U,o as B}from"./index-Bp4oiTTd.js";import{C as S}from"./camera-NkArBSeE.js";class x{static instance;keyUsageMap=new Map;roundRobinIndexMap=new Map;static getInstance(){return x.instance||(x.instance=new x),x.instance}selectApiKey(e,t="round_robin"){const s=e.filter(a=>a.isEnabled&&a.status==="active"&&!this.isKeyInCooldown(a));if(s.length===0)return{key:null,reason:"没有可用的 API Key"};let r;switch(t){case"priority":r=this.selectByPriority(s);break;case"least_used":r=this.selectByLeastUsed(s);break;case"random":r=this.selectByRandom(s);break;case"round_robin":default:r=this.selectByRoundRobin(s);break}return{key:r,reason:`使用 ${t} 策略选择`}}selectByPriority(e){return e.sort((t,s)=>t.priority-s.priority)[0]}selectByLeastUsed(e){return e.sort((t,s)=>t.usage.totalRequests-s.usage.totalRequests)[0]}selectByRandom(e){const t=Math.floor(Math.random()*e.length);return e[t]}selectByRoundRobin(e){const t=e.sort((u,m)=>u.id.localeCompare(m.id));if(t.length===0)throw new Error("没有可用的 Key");const s=t.map(u=>u.id).join("|");let r=this.roundRobinIndexMap.get(s)||0;const a=t[r],l=(r+1)%t.length;return this.roundRobinIndexMap.set(s,l),console.log(`[ApiKeyManager] 🔄 轮询选择: ${a.name||a.id.substring(0,8)}... (索引: ${r}/${t.length-1}, 下次索引: ${l})`),a}recordKeyUsage(e,t,s){const r=this.keyUsageMap.get(e)||0;this.keyUsageMap.set(e,r+1);const a=t?"✅ 成功":"❌ 失败",l=s?` - ${s}`:"";console.log(`[ApiKeyManager] Key 使用记录: ${e.substring(0,8)}... ${a}${l}`)}updateKeyStatus(e,t,s){const r=Date.now(),a={...e};return a.usage={...e.usage,totalRequests:e.usage.totalRequests+1,lastUsed:r},t?(a.usage.successfulRequests+=1,a.usage.consecutiveFailures=0,a.status="active",a.lastError=void 0):(a.usage.failedRequests+=1,a.usage.consecutiveFailures+=1,a.lastError=s,a.usage.consecutiveFailures>=3&&(a.status="error")),a.updatedAt=r,a}isKeyInCooldown(e){if(e.status!=="error")return!1;const t=5*60*1e3;return Date.now()-e.updatedAt<t}createApiKeyConfig(e,t,s=5){return{id:this.generateKeyId(),key:e,name:t||`API Key ${Date.now()}`,isEnabled:!0,priority:s,usage:{totalRequests:0,successfulRequests:0,failedRequests:0,consecutiveFailures:0},status:"active",createdAt:Date.now(),updatedAt:Date.now()}}generateKeyId(){return`key_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}resetRoundRobinState(e){e?(Array.from(this.roundRobinIndexMap.keys()).filter(s=>s.includes(e)).forEach(s=>this.roundRobinIndexMap.delete(s)),console.log(`[ApiKeyManager] 重置供应商 ${e} 的轮询状态`)):(this.roundRobinIndexMap.clear(),console.log("[ApiKeyManager] 重置所有轮询状态"))}validateApiKey(e,t){if(!e||e.trim().length===0)return!1;switch(t){case"openai":case"openai-aisdk":return e.startsWith("sk-")&&e.length>20;case"anthropic":return e.startsWith("sk-ant-")&&e.length>30;case"gemini":return e.length>20;case"deepseek":return e.startsWith("sk-")&&e.length>20;case"zhipu":return e.includes(".")&&e.length>30;case"siliconflow":return e.startsWith("sk-")&&e.length>20;case"volcengine":return e.length>20;default:return e.length>10}}getKeyStats(e){const t={total:e.length,active:0,disabled:0,error:0,totalRequests:0,successRate:0};let s=0;return e.forEach(r=>{switch(r.status){case"active":t.active++;break;case"disabled":t.disabled++;break;case"error":t.error++;break}t.totalRequests+=r.usage.totalRequests,s+=r.usage.successfulRequests}),t.successRate=t.totalRequests>0?Math.round(s/t.totalRequests*100):0,t}}const L=({open:h,onClose:e,onSave:t,currentAvatar:s,title:r="上传头像"})=>{const[a,l]=c.useState(null),[u,m]=c.useState(1),y=c.useRef(null),p=c.useRef(null),j=c.useRef(null);c.useEffect(()=>{h&&s&&!a&&l(s)},[h,s]),c.useEffect(()=>{h||(l(null),m(1))},[h]);const I=i=>{const o=i.target.files?.[0];if(o){const g=new FileReader;g.onload=d=>{const R=d.target?.result;l(R)},g.readAsDataURL(o)}},K=(i,o)=>{m(o)},C=()=>{if(!a||!p.current)return;const i=new Image;i.onload=()=>{const o=p.current,g=o.getContext("2d");o.width=200,o.height=200,g.clearRect(0,0,o.width,o.height);const d=Math.min(i.width,i.height),R=(i.width-d)/2,M=(i.height-d)/2;g.drawImage(i,R,M,d,d,0,0,o.width,o.height);const q=o.toDataURL("image/png");t(q),e()},i.src=a},w=()=>{y.current?.click()};return n.jsxs(A,{open:h,onClose:e,maxWidth:"sm",fullWidth:!0,children:[n.jsx($,{children:r}),n.jsx(D,{children:n.jsxs(f,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[a?n.jsxs(n.Fragment,{children:[n.jsx(f,{sx:{position:"relative",width:200,height:200,overflow:"hidden",borderRadius:"50%"},children:n.jsx("img",{ref:j,src:a,alt:"Avatar preview",style:{width:"100%",height:"100%",objectFit:"cover",transform:`scale(${u})`,transformOrigin:"center"}})}),n.jsxs(f,{sx:{width:"100%",mt:2},children:[n.jsx(v,{gutterBottom:!0,children:"缩放"}),n.jsx(E,{value:u,onChange:K,min:1,max:3,step:.1,"aria-labelledby":"zoom-slider"})]}),n.jsx(b,{variant:"outlined",startIcon:n.jsx(U,{}),onClick:w,sx:{mt:1},children:"更换图片"})]}):n.jsx(f,{sx:{width:200,height:200,border:"2px dashed #ccc",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",backgroundColor:"rgba(0,0,0,0.03)"},onClick:w,children:n.jsxs(f,{sx:{textAlign:"center"},children:[n.jsx(S,{size:48,color:"var(--mui-palette-text-secondary)"}),n.jsx(v,{variant:"body2",color:"text.secondary",children:"点击上传图片"})]})}),n.jsx("input",{type:"file",ref:y,style:{display:"none"},accept:"image/*",onChange:I}),n.jsx("canvas",{ref:p,style:{display:"none"}})]})}),n.jsxs(B,{children:[n.jsx(b,{onClick:e,children:"取消"}),n.jsx(b,{onClick:C,color:"primary",variant:"contained",disabled:!a,children:"保存"})]})]})};export{x as A,L as a};
