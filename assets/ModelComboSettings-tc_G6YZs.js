import{r as h,V as re,j as e,k as X,m as Z,n as $,B as l,o as ee,f as p,d as o,ac as G,g as _,I as F,i as se,H as J,J as K,S as Q,K as u,G as P,af as te,_ as ae,u as ie,a0 as le,a1 as Y,di as ne,dj as C,a as q,A as oe,T as de,b as ce,P as xe,bk as O,an as ue,bv as he}from"./index-BFQp9Otg.js";import{D as me}from"./DropdownModelSelector-BDut0jxK.js";import{S as pe,a as ge,b as je}from"./Stepper-Dw5MQudZ.js";import{C as L}from"./Card-IUdLwBcS.js";import{C as H}from"./CardContent-DXovnOt-.js";import{P as E}from"./plus-kwQ_QrJb.js";import{C as U}from"./CardActions-ByhgIrLR.js";import{A as fe}from"./arrow-right-D2LK74Ov.js";import{W as be}from"./wand-sparkles-wXO-UtLx.js";import{A as ve}from"./arrow-left-right-CJFCZjJr.js";import{G as ye}from"./git-branch-BRug6AQj.js";import"./ListSubheader-DnPPHmr2.js";const Ce=({open:I,onClose:S,onSave:s,combo:c})=>{const[m,w]=h.useState(0),[a,x]=h.useState({name:"",description:"",strategy:"routing",enabled:!0,models:[]}),j=re(t=>t.settings.providers).filter(t=>t.id!=="model-combo"&&t.isEnabled).flatMap(t=>t.models.filter(i=>i.enabled)),b=["基本信息","选择策略","配置模型","完成设置"];h.useEffect(()=>{x(c?{name:c.name,description:c.description||"",strategy:c.strategy,enabled:c.enabled,models:c.models.map(t=>({modelId:t.modelId,role:t.role,weight:t.weight,priority:t.priority}))}:{name:"",description:"",strategy:"routing",enabled:!0,models:[]}),w(0)},[c,I]);const z=()=>{w(t=>t+1)},R=()=>{w(t=>t-1)},v=()=>{s(a)},k=()=>{x(t=>({...t,models:[...t.models,{modelId:"",role:"primary",weight:1,priority:1}]}))},M=t=>{x(i=>({...i,models:i.models.filter((n,d)=>d!==t)}))},g=(t,i,n)=>{x(d=>({...d,models:d.models.map((D,W)=>W===t?{...D,[i]:n}:D)}))},y=t=>{switch(t){case"routing":return"智能路由 (开发中)";case"ensemble":return"模型集成 (开发中)";case"comparison":return"对比分析";case"cascade":return"级联调用 (开发中)";case"sequential":return"顺序执行";default:return t}},N=t=>{switch(t){case"routing":return"根据查询内容智能选择最适合的模型进行响应（基础功能可用，高级路由规则开发中）";case"ensemble":return"多个模型同时工作，综合它们的输出结果（基础功能可用，高级集成算法开发中）";case"comparison":return"同时使用多个模型，展示对比结果供用户选择（功能完整可用）";case"cascade":return"先使用便宜的模型，必要时升级到更强的模型（功能开发中，暂时使用路由策略）";case"sequential":return"按顺序使用模型，如先思考再生成（功能完整可用）";default:return""}},A=t=>{switch(t){case 0:return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(P,{fullWidth:!0,label:"组合名称",value:a.name,onChange:i=>x(n=>({...n,name:i.target.value})),required:!0}),e.jsx(P,{fullWidth:!0,label:"描述",value:a.description,onChange:i=>x(n=>({...n,description:i.target.value})),multiline:!0,rows:3}),e.jsx(te,{control:e.jsx(ae,{checked:a.enabled,onChange:i=>x(n=>({...n,enabled:i.target.checked}))}),label:"启用此组合"})]});case 1:return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"组合策略"}),e.jsxs(Q,{value:a.strategy,onChange:i=>x(n=>({...n,strategy:i.target.value})),label:"组合策略",children:[e.jsx(u,{value:"routing",children:"智能路由 (开发中)"}),e.jsx(u,{value:"ensemble",children:"模型集成 (开发中)"}),e.jsx(u,{value:"comparison",children:"对比分析"}),e.jsx(u,{value:"cascade",children:"级联调用 (开发中)"}),e.jsx(u,{value:"sequential",children:"顺序执行"})]})]}),e.jsx(_,{severity:"info",children:N(a.strategy)})]});case 2:return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(o,{variant:"h6",children:"配置模型"}),e.jsx(p,{startIcon:e.jsx(E,{}),onClick:k,variant:"outlined",size:"small",children:"添加模型"})]}),a.models.length===0?e.jsx(_,{severity:"warning",children:"请至少添加一个模型"}):a.models.map((i,n)=>e.jsx(L,{variant:"outlined",children:e.jsxs(H,{children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsxs(o,{variant:"subtitle1",children:["模型 ",n+1]}),e.jsx(F,{size:"small",onClick:()=>M(n),color:"error",children:e.jsx(se,{})})]}),e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(l,{children:[e.jsx(o,{variant:"body2",sx:{mb:1,fontWeight:500},children:"选择模型 *"}),e.jsx(me,{selectedModel:j.find(d=>d.id===i.modelId)||null,availableModels:j,handleModelSelect:d=>{g(n,"modelId",d?.id||"")}})]}),e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"角色"}),e.jsxs(Q,{value:i.role,onChange:d=>g(n,"role",d.target.value),label:"角色",MenuProps:{disableAutoFocus:!0,disableRestoreFocus:!0},children:[e.jsx(u,{value:"primary",children:"主要"}),e.jsx(u,{value:"secondary",children:"次要"}),e.jsx(u,{value:"fallback",children:"备用"}),e.jsx(u,{value:"thinking",children:"思考"}),e.jsx(u,{value:"generating",children:"生成"})]})]}),(a.strategy==="ensemble"||a.strategy==="comparison")&&e.jsx(P,{fullWidth:!0,label:"权重",type:"number",value:i.weight||1,onChange:d=>g(n,"weight",Number(d.target.value)),slotProps:{htmlInput:{min:0,max:1,step:.1}}}),(a.strategy==="cascade"||a.strategy==="sequential")&&e.jsx(P,{fullWidth:!0,label:"优先级",type:"number",value:i.priority||1,onChange:d=>g(n,"priority",Number(d.target.value)),slotProps:{htmlInput:{min:1}}})]})]})},n))]});case 3:return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(o,{variant:"h6",children:"确认配置"}),e.jsx(L,{variant:"outlined",children:e.jsxs(H,{children:[e.jsx(o,{variant:"subtitle1",gutterBottom:!0,children:a.name}),e.jsx(o,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:a.description}),e.jsxs(l,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(G,{label:y(a.strategy),size:"small"}),e.jsx(G,{label:a.enabled?"已启用":"已禁用",size:"small",color:a.enabled?"success":"default"})]}),e.jsxs(o,{variant:"body2",children:["包含 ",a.models.length," 个模型"]})]})})]});default:return null}},B=t=>{switch(t){case 0:return a.name.trim()!=="";case 1:return!!a.strategy;case 2:return a.models.length>0&&a.models.every(i=>i.modelId.trim()!=="");case 3:return!0;default:return!1}};return e.jsxs(X,{open:I,onClose:S,maxWidth:"md",fullWidth:!0,slotProps:{paper:{sx:{minHeight:"500px"}}},children:[e.jsx(Z,{children:c?"编辑模型组合":"创建模型组合"}),e.jsx($,{children:e.jsxs(l,{sx:{width:"100%",mt:2},children:[e.jsx(pe,{activeStep:m,alternativeLabel:!0,children:b.map(t=>e.jsx(ge,{children:e.jsx(je,{children:t})},t))}),e.jsx(l,{sx:{mt:3},children:A(m)})]})}),e.jsxs(ee,{children:[e.jsx(p,{onClick:S,children:"取消"}),e.jsx(l,{sx:{flex:"1 1 auto"}}),e.jsx(p,{disabled:m===0,onClick:R,children:"上一步"}),m===b.length-1?e.jsx(p,{variant:"contained",onClick:v,disabled:!B(m),children:"保存"}):e.jsx(p,{variant:"contained",onClick:z,disabled:!B(m),children:"下一步"})]})]})},qe=()=>{const I=ie(),S=le(),s=Y(S.breakpoints.down("md")),c=Y(S.breakpoints.down("sm")),[m,w]=h.useState([]),[a,x]=h.useState([]),[V,j]=h.useState(!1),[b,z]=h.useState(null),[R,v]=h.useState(!1),[k,M]=h.useState(null),{syncModelCombos:g}=ne();h.useEffect(()=>{y()},[]);const y=async()=>{try{const[r,f]=await Promise.all([C.getAllCombos(),Promise.resolve(C.getTemplates())]);w(r),x(f)}catch(r){console.error("加载模型组合数据失败:",r)}},N=()=>{I("/settings")},A=()=>{z(null),j(!0)},B=r=>{z(r),j(!0)},t=r=>{M(r),v(!0)},i=async()=>{if(k)try{await C.deleteCombo(k.id),await y(),await g(),v(!1),M(null)}catch(r){console.error("删除模型组合失败:",r)}},n=async r=>{try{b?await C.updateCombo(b.id,r):await C.createCombo(r),await y(),await g(),j(!1),z(null)}catch(f){console.error("保存模型组合失败:",f)}},d=async r=>{try{const f={...r.template,name:r.name,description:r.description};await C.createCombo(f),await y(),await g()}catch(f){console.error("从模板创建模型组合失败:",f)}},D=r=>{switch(r){case"routing":return e.jsx(O,{size:20});case"ensemble":return e.jsx(ye,{size:20});case"comparison":return e.jsx(ve,{size:20});case"cascade":return e.jsx(be,{size:20});case"sequential":return e.jsx(fe,{size:20});default:return e.jsx(O,{size:20})}},W=r=>{switch(r){case"routing":return"智能路由 (开发中)";case"ensemble":return"模型集成 (开发中)";case"comparison":return"对比分析";case"cascade":return"级联调用 (开发中)";case"sequential":return"顺序执行";default:return r}},T=r=>{switch(r){case"routing":return"#2196f3";case"ensemble":return"#4caf50";case"comparison":return"#ff9800";case"cascade":return"#9c27b0";case"sequential":return"#f44336";default:return"#757575"}};return e.jsxs(l,{sx:{flexGrow:1,display:"flex",flexDirection:"column",height:"100vh",bgcolor:r=>r.palette.mode==="light"?q(r.palette.primary.main,.02):q(r.palette.background.default,.9)},children:[e.jsx(oe,{position:"fixed",elevation:0,sx:{zIndex:r=>r.zIndex.drawer+1,bgcolor:"background.paper",color:"text.primary",borderBottom:1,borderColor:"divider",backdropFilter:"blur(8px)"},children:e.jsxs(de,{children:[e.jsx(F,{edge:"start",onClick:N,"aria-label":"back",sx:{color:r=>r.palette.primary.main},children:e.jsx(ce,{size:24})}),e.jsx(o,{variant:"h6",component:"div",sx:{flexGrow:1,fontWeight:600,backgroundImage:"linear-gradient(90deg, #9333EA, #754AB4)",backgroundClip:"text",color:"transparent"},children:"模型组合"})]})}),e.jsxs(l,{sx:{flexGrow:1,overflow:"auto",px:s?1:2,py:s?1:2,mt:8},children:[a.length>0&&e.jsxs(l,{sx:{mb:s?2:4},children:[e.jsx(o,{variant:s?"subtitle1":"h6",sx:{mb:s?1:2,fontWeight:600,fontSize:s?"1.1rem":void 0},children:"预设模板"}),e.jsx(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:c?"1fr":"repeat(2, 1fr)",md:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:s?1:2},children:a.map(r=>e.jsx(l,{children:e.jsxs(L,{sx:{height:"100%",display:"flex",flexDirection:"column",border:"1px solid",borderColor:"divider","&:hover":{borderColor:"primary.main",transform:s?"none":"translateY(-2px)",boxShadow:s?1:2},transition:"all 0.2s ease-in-out"},children:[e.jsxs(H,{sx:{flexGrow:1,p:s?1.5:2,"&:last-child":{pb:s?1.5:2}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:s?.5:1},children:[e.jsx(l,{sx:{mr:1,fontSize:s?"1.2rem":"1.5rem"},children:r.icon}),e.jsx(o,{variant:s?"subtitle1":"h6",component:"div",sx:{fontWeight:600,fontSize:s?"1rem":void 0},children:r.name})]}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:s?1:2,fontSize:s?"0.8rem":void 0,lineHeight:s?1.3:void 0},children:r.description}),e.jsx(G,{icon:D(r.strategy),label:W(r.strategy),size:"small",sx:{bgcolor:q(T(r.strategy),.1),color:T(r.strategy),fontSize:s?"0.7rem":void 0,height:s?24:void 0,"& .MuiChip-icon":{fontSize:s?"0.9rem":void 0}}})]}),e.jsx(U,{sx:{p:s?1:2,pt:0},children:e.jsx(p,{size:"small",startIcon:e.jsx(E,{size:16}),onClick:()=>d(r),sx:{ml:"auto",fontSize:s?"0.75rem":void 0,px:s?1:void 0},children:"使用模板"})})]})},r.id))})]}),e.jsxs(l,{children:[e.jsx(o,{variant:s?"subtitle1":"h6",sx:{mb:s?1:2,fontWeight:600,fontSize:s?"1.1rem":void 0},children:"我的组合"}),m.length===0?e.jsxs(xe,{sx:{p:s?2:4,textAlign:"center",border:"2px dashed",borderColor:"divider"},children:[e.jsx(O,{size:s?36:48,color:"currentColor",style:{color:"var(--mui-palette-text-secondary)",marginBottom:s?8:16}}),e.jsx(o,{variant:s?"subtitle1":"h6",color:"text.secondary",gutterBottom:!0,sx:{fontSize:s?"1rem":void 0},children:"还没有创建任何模型组合"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:s?2:3,fontSize:s?"0.8rem":void 0},children:"创建模型组合来实现智能路由、模型集成等高级功能"}),e.jsx(p,{variant:"contained",startIcon:e.jsx(E,{size:16}),onClick:A,size:s?"small":"medium",sx:{fontSize:s?"0.8rem":void 0},children:"创建第一个组合"})]}):e.jsx(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:c?"1fr":"repeat(2, 1fr)",md:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:s?1:2},children:m.map(r=>e.jsx(l,{children:e.jsxs(L,{sx:{height:"100%",display:"flex",flexDirection:"column",border:"1px solid",borderColor:r.enabled?"success.main":"divider",opacity:r.enabled?1:.7},children:[e.jsxs(H,{sx:{flexGrow:1,p:s?1.5:2,"&:last-child":{pb:s?1.5:2}},children:[e.jsx(o,{variant:s?"subtitle1":"h6",component:"div",sx:{fontWeight:600,mb:s?.5:1,fontSize:s?"1rem":void 0},children:r.name}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:s?1:2,fontSize:s?"0.8rem":void 0,lineHeight:s?1.3:void 0},children:r.description}),e.jsx(G,{icon:D(r.strategy),label:W(r.strategy),size:"small",sx:{bgcolor:q(T(r.strategy),.1),color:T(r.strategy),mb:s?.5:1,fontSize:s?"0.7rem":void 0,height:s?24:void 0,"& .MuiChip-icon":{fontSize:s?"0.9rem":void 0}}}),e.jsxs(o,{variant:"caption",display:"block",color:"text.secondary",sx:{fontSize:s?"0.7rem":void 0},children:[r.models.length," 个模型"]})]}),e.jsxs(U,{sx:{p:s?1:2,pt:0,minHeight:s?"auto":void 0},children:[e.jsx(F,{size:"small",onClick:()=>B(r),color:"primary",sx:{p:s?.5:void 0},children:e.jsx(ue,{size:s?16:20})}),e.jsx(F,{size:"small",onClick:()=>t(r),color:"error",sx:{p:s?.5:void 0},children:e.jsx(se,{size:s?16:20})})]})]})},r.id))})]})]}),e.jsx(he,{color:"primary","aria-label":"add",size:s?"medium":"large",sx:{position:"fixed",bottom:s?12:16,right:s?12:16,width:s?48:void 0,height:s?48:void 0},onClick:A,children:e.jsx(E,{size:s?20:24})}),e.jsx(Ce,{open:V,onClose:()=>j(!1),onSave:n,combo:b,templates:a}),e.jsxs(X,{open:R,onClose:()=>v(!1),children:[e.jsx(Z,{children:"确认删除"}),e.jsx($,{children:e.jsxs(o,{children:['确定要删除模型组合 "',k?.name,'" 吗？此操作无法撤销。']})}),e.jsxs(ee,{children:[e.jsx(p,{onClick:()=>v(!1),children:"取消"}),e.jsx(p,{onClick:i,color:"error",variant:"contained",children:"删除"})]})]})]})};export{qe as default};
