import{u as N,U as k,V as w,r as d,j as e,B as l,a as j,A as S,T,I as A,b as F,d as a,P as R,D,bG as m,E as B,af as E,ag as P,G as c,f as K,C as z,bH as L,g as f,e as G,$ as W}from"./index-Bp4oiTTd.js";import{K as $,n as O,N as U}from"./notionApiUtils-TpZoD0fd.js";import"./index-DTxJt4jI.js";const M=()=>{const y=N(),v=k(),h=w(s=>s.settings.notion)||{enabled:!1,apiKey:"",databaseId:"",pageTitleField:"Name",dateField:""},[b,p]=d.useState(!1),[o,i]=d.useState(null),[t,g]=d.useState(h);d.useEffect(()=>{g(h)},[h]);const I=()=>{y("/settings")},n=(s,r)=>{const x={...t,[s]:r};g(x),v(W({notion:x})),o&&i(null)},C=async()=>{if(!t.apiKey||!t.databaseId){i({success:!1,message:"请先填写API密钥和数据库ID"});return}p(!0),i(null);try{const s=await O(`/v1/databases/${t.databaseId}`,{method:"GET",apiKey:t.apiKey}),r=s.properties||{},x=Object.keys(r).some(u=>u===t.pageTitleField&&r[u].type==="title");i(x?{success:!0,message:`连接成功！数据库"${s.title?.[0]?.plain_text||"未命名"}"已就绪`}:{success:!1,message:`数据库中未找到标题字段"${t.pageTitleField}"，请检查字段名称是否正确`})}catch(s){console.error("测试Notion连接失败:",s);const r=s instanceof U?s.getUserFriendlyMessage():s instanceof Error?s.message:"未知错误";i({success:!1,message:`连接失败: ${r}`})}finally{p(!1)}};return e.jsxs(l,{sx:{flexGrow:1,display:"flex",flexDirection:"column",height:"100vh",bgcolor:s=>s.palette.mode==="light"?j(s.palette.primary.main,.02):j(s.palette.background.default,.9)},children:[e.jsx(S,{position:"fixed",elevation:0,sx:{zIndex:s=>s.zIndex.drawer+1,bgcolor:"background.paper",color:"text.primary",borderBottom:1,borderColor:"divider",backdropFilter:"blur(8px)"},children:e.jsxs(T,{children:[e.jsx(A,{edge:"start",color:"inherit",onClick:I,"aria-label":"back",sx:{color:s=>s.palette.primary.main},children:e.jsx(F,{size:20})}),e.jsx(a,{variant:"h6",component:"div",sx:{flexGrow:1,fontWeight:600,backgroundImage:"linear-gradient(90deg, #9333EA, #754AB4)",backgroundClip:"text",color:"transparent"},children:"Notion 集成设置"})]})}),e.jsx(l,{sx:{flexGrow:1,overflowY:"auto",p:{xs:1,sm:2},mt:8,"&::-webkit-scrollbar":{width:{xs:"4px",sm:"6px"}},"&::-webkit-scrollbar-thumb":{backgroundColor:"rgba(0,0,0,0.1)",borderRadius:"3px"}},children:e.jsxs(R,{elevation:0,sx:{p:3,mb:3,border:"1px solid",borderColor:"divider",borderRadius:2},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(D,{size:20,style:{marginRight:8}}),e.jsx(a,{variant:"h6",component:"h3",children:"Notion 集成配置"})]}),e.jsxs(a,{variant:"body2",color:"text.secondary",sx:{mb:3},children:["配置Notion集成，将对话导出到您的Notion数据库。",e.jsxs(m,{href:"https://docs.cherry-ai.com/data-settings/notion",target:"_blank",sx:{ml:1,display:"inline-flex",alignItems:"center"},children:["查看配置教程",e.jsx(B,{size:14,style:{marginLeft:4}})]})]}),e.jsx(E,{control:e.jsx(P,{checked:t.enabled,onChange:s=>n("enabled",s.target.checked)}),label:"启用Notion导出",sx:{mb:3}}),e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2,opacity:t.enabled?1:.5},children:[e.jsx(c,{label:"Notion API 密钥",type:"password",value:t.apiKey,onChange:s=>n("apiKey",s.target.value),disabled:!t.enabled,placeholder:"secret_xxxxxxxxxxxxxxxxxxxxx",helperText:"在 https://www.notion.so/my-integrations 创建集成并获取API密钥",InputProps:{startAdornment:e.jsx($,{size:16,style:{marginRight:8,color:"#666"}})},fullWidth:!0}),e.jsx(c,{label:"数据库 ID",value:t.databaseId,onChange:s=>n("databaseId",s.target.value),disabled:!t.enabled,placeholder:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",helperText:"从Notion数据库URL中提取的ID部分",fullWidth:!0}),e.jsx(c,{label:"页面标题字段名",value:t.pageTitleField,onChange:s=>n("pageTitleField",s.target.value),disabled:!t.enabled,placeholder:"Name",helperText:"数据库中用作标题的字段名称，通常是 'Name' 或 '名称'",fullWidth:!0}),e.jsx(c,{label:"创建日期字段名（可选）",value:t.dateField||"",onChange:s=>n("dateField",s.target.value),disabled:!t.enabled,placeholder:"创建日期",helperText:"如果数据库中有日期字段，填入字段名称；留空则不添加日期信息",fullWidth:!0}),e.jsx(K,{variant:"outlined",onClick:C,disabled:!t.enabled||b||!t.apiKey||!t.databaseId,startIcon:b?e.jsx(z,{size:16}):e.jsx(L,{size:16}),sx:{alignSelf:"flex-start",mt:1},children:b?"测试中...":"测试连接"}),o&&e.jsx(f,{severity:o.success?"success":"error",sx:{mt:1},children:o.message}),e.jsx(f,{severity:"info",sx:{mt:2},children:e.jsxs(a,{variant:"body2",children:[e.jsx("strong",{children:"关于跨域问题："}),e.jsx("br",{}),"Web端开发环境下已配置代理，可直接使用。移动端应用已配置 CORS 绕过插件。",e.jsx("br",{}),"生产环境下如遇到跨域错误，建议：",e.jsx("br",{}),"1. 使用移动应用版本（自动绕过CORS）",e.jsx("br",{}),"2. 部署时配置服务器代理",e.jsx("br",{}),"3. 使用支持CORS的环境",e.jsx("br",{}),e.jsx("strong",{children:"注意："}),"请重启开发服务器以使代理配置生效。"]})})]}),e.jsx(G,{sx:{my:3}}),e.jsxs(l,{children:[e.jsx(a,{variant:"subtitle2",gutterBottom:!0,children:"配置步骤："}),e.jsxs(l,{component:"ol",sx:{pl:2,"& li":{mb:1}},children:[e.jsx("li",{children:e.jsxs(a,{variant:"body2",children:["访问 ",e.jsx(m,{href:"https://www.notion.so/my-integrations",target:"_blank",children:"Notion Integrations"})," 创建一个新的集成"]})}),e.jsx("li",{children:e.jsx(a,{variant:"body2",children:'复制生成的API密钥并填入上方的"Notion API 密钥"字段'})}),e.jsx("li",{children:e.jsx(a,{variant:"body2",children:"在Notion中创建一个数据库，并将集成连接到该数据库"})}),e.jsx("li",{children:e.jsx(a,{variant:"body2",children:'从数据库URL中复制数据库ID并填入"数据库 ID"字段'})}),e.jsx("li",{children:e.jsx(a,{variant:"body2",children:'确认数据库中标题字段的名称，通常是"Name"或"名称"'})}),e.jsx("li",{children:e.jsx(a,{variant:"body2",children:"（可选）如果需要添加创建日期，请填入数据库中日期字段的名称"})}),e.jsx("li",{children:e.jsx(a,{variant:"body2",children:'点击"测试连接"按钮验证配置是否正确'})})]})]})]})})]})};export{M as default};
