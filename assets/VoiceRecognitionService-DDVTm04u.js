const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-DJ5ec8gf.js","assets/index-BFQp9Otg.js","assets/index-ow1R_qFW.css"])))=>i.map(i=>d[i]);
import{b6 as m,b7 as w,ad as n,ae as b}from"./index-BFQp9Otg.js";const a=m("SpeechRecognition",{web:()=>w(()=>import("./web-DJ5ec8gf.js"),__vite__mapDeps([0,1,2])).then(p=>new p.SpeechRecognitionWeb)});class c{static instance;apiKey="";model="whisper-1";language;temperature=0;responseFormat="json";constructor(){}static getInstance(){return c.instance||(c.instance=new c),c.instance}setApiKey(e){this.apiKey=e}setModel(e){this.model=e}setLanguage(e){this.language=e}setTemperature(e){this.temperature=e}setResponseFormat(e){this.responseFormat=e}async transcribeAudio(e){if(!this.apiKey)throw new Error("API密钥未设置，请先设置API密钥");const t=new FormData;t.append("file",e,"recording.webm"),t.append("model",this.model),this.language&&t.append("language",this.language),t.append("temperature",this.temperature.toString()),t.append("response_format",this.responseFormat);const i=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`},body:t});if(!i.ok){const s=await i.json();throw new Error(`OpenAI API错误: ${s.error?.message||i.statusText}`)}return await i.json()}async recordAndTranscribe(e=5e3){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new MediaRecorder(t),r=[];return i.addEventListener("dataavailable",s=>{r.push(s.data)}),i.start(),console.log("开始录制音频..."),await new Promise(s=>setTimeout(s,e)),new Promise((s,d)=>{i.addEventListener("stop",async()=>{try{t.getTracks().forEach(u=>u.stop());const h=new Blob(r,{type:"audio/webm"}),g=await this.transcribeAudio(h);s(g)}catch(h){d(h)}}),i.stop()})}catch(t){throw console.error("录制或转录失败:",t),t}}getAvailableModels(){return["whisper-1"]}}const o=c.getInstance();class l{static instance;isListening=!1;partialResultsCallback=null;errorCallback=null;listeningStateCallback=null;provider="capacitor";recordingDuration=5e3;recordingTimeoutId=null;recordingStream=null;mediaRecorder=null;audioChunks=[];isWebEnvironment=!1;webSpeechRecognition=null;constructor(){const t=typeof window<"u"&&typeof navigator<"u"&&!!navigator.userAgent;if(this.isWebEnvironment=t,this.isWebEnvironment&&(window.SpeechRecognition||window.webkitSpeechRecognition)){const i=window.SpeechRecognition||window.webkitSpeechRecognition;this.webSpeechRecognition=new i,this.webSpeechRecognition&&(this.webSpeechRecognition.continuous=!0,this.webSpeechRecognition.interimResults=!0,this.webSpeechRecognition.onresult=r=>{if(this.provider!=="capacitor")return;const s=r.results[r.results.length-1];s.isFinal&&this.partialResultsCallback?this.partialResultsCallback(s[0].transcript):this.partialResultsCallback&&this.partialResultsCallback(s[0].transcript)},this.webSpeechRecognition.onend=()=>{this.provider==="capacitor"&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"))},this.webSpeechRecognition.onerror=r=>{this.provider==="capacitor"&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"),this.errorCallback&&this.errorCallback(new Error(`语音识别错误: ${r.error}`)))})}this.loadProvider(),this.isWebEnvironment||a.addListener("partialResults",i=>{this.provider==="capacitor"&&i.matches&&i.matches.length>0&&this.partialResultsCallback&&this.partialResultsCallback(i.matches[0])})}async loadProvider(){try{const e=await n("speech_recognition_provider");(e==="openai"||e==="capacitor")&&(this.provider=e)}catch{}}static getInstance(){return l.instance||(l.instance=new l),l.instance}async setProvider(e){this.isListening&&await this.stopRecognition(),this.provider=e,await b("speech_recognition_provider",e)}getProvider(){return this.provider}async checkPermissions(){if(this.provider==="capacitor")if(this.isWebEnvironment)try{if("permissions"in navigator)try{const e=await navigator.permissions.query({name:"microphone"});return e.state==="granted"?{speechRecognition:"granted"}:e.state==="denied"?{speechRecognition:"denied"}:{speechRecognition:"prompt"}}catch{return{speechRecognition:"unknown"}}else return{speechRecognition:"unknown"}}catch{return{speechRecognition:"unknown"}}else try{return await a.checkPermissions()}catch{return{speechRecognition:"unknown"}}else try{if("permissions"in navigator){const e=await navigator.permissions.query({name:"microphone"});return e.state==="granted"?{speechRecognition:"granted"}:e.state==="denied"?{speechRecognition:"denied"}:{speechRecognition:"prompt"}}else return{speechRecognition:"unknown"}}catch{return{speechRecognition:"unknown"}}}async requestPermissions(){if(this.provider==="capacitor")if(this.isWebEnvironment)try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),{speechRecognition:"granted"}}catch(e){return e instanceof DOMException&&e.name==="NotAllowedError"?{speechRecognition:"denied"}:{speechRecognition:"denied"}}else try{return await a.requestPermissions()}catch{return{speechRecognition:"denied"}}else try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),{speechRecognition:"granted"}}catch(e){return e instanceof DOMException&&e.name==="NotAllowedError"?{speechRecognition:"denied"}:{speechRecognition:"denied"}}}isVoiceRecognitionAvailable(){if(this.provider==="capacitor")if(this.isWebEnvironment){const e=!!(window.SpeechRecognition||window.webkitSpeechRecognition),t=window.isSecureContext||window.location.protocol==="https:"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";return e&&t&&!!this.webSpeechRecognition}else return!0;else return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}async startRecognition(e){if(this.isListening)try{await this.stopRecognition(),await new Promise(t=>setTimeout(t,300))}catch{}if(!this.isVoiceRecognitionAvailable()){const t=new Error("语音识别在当前环境下不可用");throw this.errorCallback&&this.errorCallback(t),t}try{if(this.isListening=!0,this.listeningStateCallback&&this.listeningStateCallback("started"),this.provider==="capacitor")if(this.isWebEnvironment&&this.webSpeechRecognition){this.webSpeechRecognition.onend=()=>{this.isListening&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"))},this.webSpeechRecognition.onerror=t=>{this.isListening&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped")),this.errorCallback&&this.errorCallback(new Error(`语音识别错误: ${t.error}`))},this.webSpeechRecognition.lang=e?.language||"zh-CN";try{this.webSpeechRecognition.start()}catch(t){throw this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"),t}}else await a.start({language:e?.language||"zh-CN",maxResults:e?.maxResults||5,partialResults:e?.partialResults!==!1,popup:e?.popup||!1});else await this.startWhisperRecognition()}catch(t){throw this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"),this.errorCallback&&this.errorCallback(t),t}}async startWhisperRecognition(){try{this.recordingStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.recordingStream),this.audioChunks=[],this.mediaRecorder.addEventListener("dataavailable",e=>{this.audioChunks.push(e.data)}),this.mediaRecorder.addEventListener("stop",async()=>{try{const e=new Blob(this.audioChunks,{type:"audio/webm"});this.recordingStream&&(this.recordingStream.getTracks().forEach(i=>i.stop()),this.recordingStream=null),await this.loadWhisperSettings();const t=await o.transcribeAudio(e);this.partialResultsCallback&&t.text&&this.partialResultsCallback(t.text)}catch(e){this.errorCallback&&this.errorCallback(e)}finally{this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"),this.mediaRecorder=null}}),this.mediaRecorder.start(),this.recordingTimeoutId=window.setTimeout(()=>{this.stopWhisperRecording()},this.recordingDuration)}catch(e){throw this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"),this.errorCallback&&this.errorCallback(e),e}}stopWhisperRecording(){this.recordingTimeoutId&&(clearTimeout(this.recordingTimeoutId),this.recordingTimeoutId=null),this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop()}async loadWhisperSettings(){try{const e=await n("whisper_api_key")||"",t=await n("whisper_model")||"whisper-1",i=await n("whisper_language"),r=Number(await n("whisper_temperature")||"0"),s=await n("whisper_response_format")||"json";o.setApiKey(e),o.setModel(t),i&&o.setLanguage(i),o.setTemperature(r),o.setResponseFormat(s)}catch{}}async stopRecognition(){if(this.isListening)try{if(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback("stopped"),this.provider==="capacitor")if(this.isWebEnvironment&&this.webSpeechRecognition)try{this.webSpeechRecognition.stop()}catch{}else await a.stop().catch(()=>{});else this.stopWhisperRecording()}catch(e){this.errorCallback&&this.errorCallback(e)}}setPartialResultsCallback(e){this.partialResultsCallback=e}setListeningStateCallback(e){this.listeningStateCallback=e}setErrorCallback(e){this.errorCallback=e}getIsListening(){return this.isListening}async getSupportedLanguages(){if(this.provider==="capacitor"){if(this.isWebEnvironment)return["zh-CN","en-US","fr-FR","de-DE","ja-JP","ko-KR","es-ES","it-IT","pt-BR","ru-RU"];try{return(await a.getSupportedLanguages()).languages||[]}catch{return[]}}else return["zh","en","ja","ko","fr","de","es","ru","pt","it","nl","tr","pl","ar","hi","id","fi","vi","he","uk","el","ms","cs","ro","da","hu","ta","no","th","ur","hr","bg","lt","la","mi","ml","cy","sk","te","fa","lv","bn","sr","az","sl","kn","et","mk","br","eu","is","hy","ne","mn","bs","kk","sq","sw","gl","mr","pa","si","km","sn","yo","so","af","oc","ka","be","tg","sd","gu","am","yi","lo","uz","fo","ht","ps","tk","nn","mt","sa","lb","my","bo","tl","mg","as","tt","haw","ln","ha","ba","jw","su"]}setRecordingDuration(e){this.recordingDuration=e}}const R=l.getInstance();export{o,R as v};
