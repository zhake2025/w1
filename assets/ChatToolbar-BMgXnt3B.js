const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-5OteHtpV.js","assets/index-BFujkyoP.css"])))=>i.map(i=>d[i]);
import{r as s,dk as Fs,db as As,b8 as Bs,dq as Yr,bd as Ds,bc as ps,j as e,de as Ue,be as $s,bi as Ms,ff as Ls,c as jt,V as se,a0 as $e,a1 as Qt,b7 as rr,k as ht,m as xt,B as C,d as K,I as ne,a3 as Ve,n as gt,aj as Te,i as _t,f as Ie,ac as tt,X as et,Y as qe,a4 as ye,Z as we,aO as Ws,o as sr,er as Tr,K as De,e as Ye,W as hs,fg as mr,b6 as Rr,dn as Zt,fh as Qr,p as rt,fi as Os,eg as Zr,e4 as _s,bH as Us,es as Hs,O as Ut,Q as yt,R as Xt,t as Se,fj as Pr,C as dt,u as nr,g as Tt,G as Ot,H as xs,J as Ks,S as Ns,af as Jt,_ as Xr,a_ as Pt,fk as Vs,bo as qs,bp as Jr,b0 as Ys,P as Gr,b as gs,fl as Er,aZ as Ne,D as ms,ah as Fr,b4 as ut,ag as Gt,eH as Lt,a2 as Qs,a5 as fs,a as Fe,U as or,fm as Zs,bu as kr,fn as Xs,aw as Sr,M as Js,fo as Gs,fp as en,fq as fr,fr as br,fs as es,ft as tn,eb as rn,fu as sn,fv as nn,fw as on,dF as Ar,av as an,$ as ln}from"./index-5OteHtpV.js";import{P as st}from"./plus-CNFnFWu4.js";import{S as ar}from"./square-BA8MCZc2.js";import{I as pt}from"./image-XaM80MAg.js";import{S as Br}from"./search-Dw_6t9R9.js";import{S as er}from"./send-ASWz93zC.js";import{u as ir}from"./useVoiceRecognition-DXvl9yRD.js";import"./VoiceRecognitionService-CIHxMX2o.js";import{M as Dr}from"./mic-CkhU9HLo.js";import{K as bs}from"./keyboard-DoE1mW-b.js";import{C as $r}from"./camera-A3JZVv3e.js";import{B as wt}from"./book-open-Cm9GWHwk.js";import{A as tr}from"./arrow-left-right-Bp9AMgzL.js";import{C as ze}from"./CustomIcon-BWD6VzSA.js";import{F as Rt}from"./file-text-B6fJWyRt.js";import{V as lr}from"./video-Uqjr7cI6.js";import{F as ts}from"./folder-open-CoOuwxCz.js";import{P as cn}from"./play-DO-IE5Ji.js";import{Q as Nt}from"./QuickPhraseService-mk4ya-4R.js";import{L as Yt}from"./ListItemButton-B_D_P2EP.js";import{C as rs}from"./check-xghfeBSR.js";import{T as yr}from"./index-BFM3Spdl.js";import{G as ss}from"./grip-vertical-B-eGjNfY.js";import{F as dn}from"./file-JP01FXBa.js";import{I as ns}from"./InputAdornment-a3_xDuZj.js";import{C as un}from"./chevron-left-B7_jnj4n.js";const ys=n=>{const t=s.useRef({});return s.useEffect(()=>{t.current=n}),t.current};function pn(n){const{badgeContent:t,invisible:o=!1,max:a=99,showZero:r=!1}=n,i=ys({badgeContent:t,max:a});let d=o;o===!1&&t===0&&!r&&(d=!0);const{badgeContent:l,max:x=a}=d?i:n,b=l&&Number(l)>x?`${x}+`:l;return{badgeContent:l,invisible:d,max:x,displayValue:b}}function hn(n){return As("MuiBadge",n)}const lt=Fs("MuiBadge",["root","badge","dot","standard","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft","invisible","colorError","colorInfo","colorPrimary","colorSecondary","colorSuccess","colorWarning","overlapRectangular","overlapCircular","anchorOriginTopLeftCircular","anchorOriginTopLeftRectangular","anchorOriginTopRightCircular","anchorOriginTopRightRectangular","anchorOriginBottomLeftCircular","anchorOriginBottomLeftRectangular","anchorOriginBottomRightCircular","anchorOriginBottomRightRectangular"]),wr=10,jr=4,xn=n=>{const{color:t,anchorOrigin:o,invisible:a,overlap:r,variant:i,classes:d={}}=n,l={root:["root"],badge:["badge",i,a&&"invisible",`anchorOrigin${Ue(o.vertical)}${Ue(o.horizontal)}`,`anchorOrigin${Ue(o.vertical)}${Ue(o.horizontal)}${Ue(r)}`,`overlap${Ue(r)}`,t!=="default"&&`color${Ue(t)}`]};return $s(l,hn,d)},gn=ps("span",{name:"MuiBadge",slot:"Root"})({position:"relative",display:"inline-flex",verticalAlign:"middle",flexShrink:0}),mn=ps("span",{name:"MuiBadge",slot:"Badge",overridesResolver:(n,t)=>{const{ownerState:o}=n;return[t.badge,t[o.variant],t[`anchorOrigin${Ue(o.anchorOrigin.vertical)}${Ue(o.anchorOrigin.horizontal)}${Ue(o.overlap)}`],o.color!=="default"&&t[`color${Ue(o.color)}`],o.invisible&&t.invisible]}})(Ms(({theme:n})=>({display:"flex",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",alignContent:"center",alignItems:"center",position:"absolute",boxSizing:"border-box",fontFamily:n.typography.fontFamily,fontWeight:n.typography.fontWeightMedium,fontSize:n.typography.pxToRem(12),minWidth:wr*2,lineHeight:1,padding:"0 6px",height:wr*2,borderRadius:wr,zIndex:1,transition:n.transitions.create("transform",{easing:n.transitions.easing.easeInOut,duration:n.transitions.duration.enteringScreen}),variants:[...Object.entries(n.palette).filter(Ls(["contrastText"])).map(([t])=>({props:{color:t},style:{backgroundColor:(n.vars||n).palette[t].main,color:(n.vars||n).palette[t].contrastText}})),{props:{variant:"dot"},style:{borderRadius:jr,height:jr*2,minWidth:jr*2,padding:0}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="top"&&t.anchorOrigin.horizontal==="right"&&t.overlap==="rectangular",style:{top:0,right:0,transform:"scale(1) translate(50%, -50%)",transformOrigin:"100% 0%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(50%, -50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="bottom"&&t.anchorOrigin.horizontal==="right"&&t.overlap==="rectangular",style:{bottom:0,right:0,transform:"scale(1) translate(50%, 50%)",transformOrigin:"100% 100%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(50%, 50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="top"&&t.anchorOrigin.horizontal==="left"&&t.overlap==="rectangular",style:{top:0,left:0,transform:"scale(1) translate(-50%, -50%)",transformOrigin:"0% 0%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(-50%, -50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="bottom"&&t.anchorOrigin.horizontal==="left"&&t.overlap==="rectangular",style:{bottom:0,left:0,transform:"scale(1) translate(-50%, 50%)",transformOrigin:"0% 100%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(-50%, 50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="top"&&t.anchorOrigin.horizontal==="right"&&t.overlap==="circular",style:{top:"14%",right:"14%",transform:"scale(1) translate(50%, -50%)",transformOrigin:"100% 0%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(50%, -50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="bottom"&&t.anchorOrigin.horizontal==="right"&&t.overlap==="circular",style:{bottom:"14%",right:"14%",transform:"scale(1) translate(50%, 50%)",transformOrigin:"100% 100%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(50%, 50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="top"&&t.anchorOrigin.horizontal==="left"&&t.overlap==="circular",style:{top:"14%",left:"14%",transform:"scale(1) translate(-50%, -50%)",transformOrigin:"0% 0%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(-50%, -50%)"}}},{props:({ownerState:t})=>t.anchorOrigin.vertical==="bottom"&&t.anchorOrigin.horizontal==="left"&&t.overlap==="circular",style:{bottom:"14%",left:"14%",transform:"scale(1) translate(-50%, 50%)",transformOrigin:"0% 100%",[`&.${lt.invisible}`]:{transform:"scale(0) translate(-50%, 50%)"}}},{props:{invisible:!0},style:{transition:n.transitions.create("transform",{easing:n.transitions.easing.easeInOut,duration:n.transitions.duration.leavingScreen})}}]})));function os(n){return{vertical:n?.vertical??"top",horizontal:n?.horizontal??"right"}}const ws=s.forwardRef(function(t,o){const a=Bs({props:t,name:"MuiBadge"}),{anchorOrigin:r,className:i,classes:d,component:l,components:x={},componentsProps:b={},children:p,overlap:y="rectangular",color:g="default",invisible:m=!1,max:v=99,badgeContent:S,slots:I,slotProps:E,showZero:F=!1,variant:h="standard",...A}=a,{badgeContent:z,invisible:P,max:W,displayValue:u}=pn({max:v,invisible:m,badgeContent:S,showZero:F}),f=ys({anchorOrigin:os(r),color:g,overlap:y,variant:h,badgeContent:S}),M=P||z==null&&h!=="dot",{color:$=g,overlap:B=y,anchorOrigin:D,variant:c=h}=M?f:a,k=os(D),w=c!=="dot"?u:void 0,T={...a,badgeContent:z,invisible:M,max:W,displayValue:w,showZero:F,anchorOrigin:k,color:$,overlap:B,variant:c},R=xn(T),U={slots:{root:I?.root??x.Root,badge:I?.badge??x.Badge},slotProps:{root:E?.root??b.root,badge:E?.badge??b.badge}},[N,Y]=Yr("root",{elementType:gn,externalForwardedProps:{...U,...A},ownerState:T,className:Ds(R.root,i),ref:o,additionalProps:{as:l}}),[J,ee]=Yr("badge",{elementType:mn,externalForwardedProps:U,ownerState:T,className:R.badge});return e.jsxs(N,{...Y,children:[p,e.jsx(J,{...ee,children:w})]})});/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fn=[["path",{d:"M12 6V2H8",key:"1155em"}],["path",{d:"m8 18-4 4V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2Z",key:"w2lp3e"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M9 11v2",key:"1ueba0"}],["path",{d:"M15 11v2",key:"i11awn"}],["path",{d:"M20 12h2",key:"1q8mjw"}]],as=jt("bot-message-square",fn);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bn=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],is=jt("history",bn);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yn=[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],wn=jt("mic-off",yn);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jn=[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]],vn=jt("music",jn);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cn=[["path",{d:"M13.234 20.252 21 12.3",key:"1cbrk9"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486",key:"1pkts6"}]],js=jt("paperclip",Cn);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kn=[["path",{d:"M21 10.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.5",key:"1uzm8b"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Sn=jt("square-check-big",kn);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const In=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]],zn=jt("volume-x",In),Mr=({onSendMessage:n,onSendImagePrompt:t,isLoading:o=!1,allowConsecutiveMessages:a=!0,imageGenerationMode:r=!1,videoGenerationMode:i=!1,toolsEnabled:d=!0,images:l,files:x,setImages:b,setFiles:p,enableTextareaResize:y=!1,enableCompositionHandling:g=!1,enableCharacterCount:m=!1})=>{const[v,S]=s.useState(""),I=s.useRef(null),E=se(H=>H.settings.sendWithEnter),F=se(H=>H.settings.mobileInputMethodEnterAsNewline),h=$e(),A=h.palette.mode==="dark",z=Qt(h.breakpoints.down("sm")),P=Qt(h.breakpoints.between("sm","md")),[W,u]=s.useState(y?z?32:P?36:34:40),[f,M]=s.useState(!1),[$,B]=s.useState(!1),[D,c]=s.useState(!1),[k,w]=s.useState(!1),T=s.useCallback(()=>(v.trim()||l.length>0||x.length>0)&&(a||!o),[v,l.length,x.length,a,o]),R=s.useRef(null),U=s.useCallback(H=>{y&&(R.current&&clearTimeout(R.current),R.current=setTimeout(()=>{H.style.height="auto";const le=Math.max(z?32:P?36:34,Math.min(H.scrollHeight,120));u(le),H.style.height=`${le}px`},16))},[y,z,P]),N=s.useCallback(async()=>{if(!v.trim()&&l.length===0&&x.length===0||o&&!a)return;let H=v.trim();if(r&&t){if(t(H),S(""),y){const V=z?24:28;u(V),I.current&&(I.current.style.height=`${V}px`)}return}if(i&&t){if(t(H),S(""),y){const V=z?24:28;u(V),I.current&&(I.current.style.height=`${V}px`)}return}const le=[...l,...x.filter(V=>V.mimeType.startsWith("image/")).map(V=>({base64Data:V.base64Data,url:V.url||"",width:V.width,height:V.height}))],de=await Promise.all(le.map(async V=>{let oe=V.base64Data||V.url;if(V.url&&V.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/)){const ie=V.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/);if(ie&&ie[1])try{const Q=ie[1],{dexieStorage:L}=await rr(async()=>{const{dexieStorage:Z}=await import("./index-5OteHtpV.js").then(pe=>pe.hx);return{dexieStorage:Z}},__vite__mapDeps([0,1])),X=await L.getImageBlob(Q);X&&(oe=await new Promise(pe=>{const O=new FileReader;O.onload=()=>pe(O.result),O.readAsDataURL(X)}))}catch(Q){console.error("加载图片引用失败:",Q)}}return{type:"image_url",image_url:{url:oe}}})),te=x.filter(V=>!V.mimeType.startsWith("image/"));if(n(H,de.length>0?de:void 0,d,te),s.startTransition(()=>{S(""),b([]),p([]),c(!1),w(!1),B(!1)}),y){const V=z?24:28;u(V),I.current&&(I.current.style.height=`${V}px`)}},[v,l,x,o,a,r,i,t,y,z,n,d,S,b,p,u]),Y=s.useCallback(H=>{if(g&&(H.ctrlKey||H.metaKey)&&H.key,H.key==="Enter"&&!H.shiftKey&&(!g||!f)){if(z&&F)return;E&&(H.preventDefault(),N())}},[g,f,N,E,z,F]),J=s.useCallback(()=>{g&&M(!0)},[g]),ee=s.useCallback(H=>{g&&(M(!1),U(H.target))},[g,U]),me=s.useCallback(H=>{const le=H.target.value,de=le.length;S(le),s.startTransition(()=>{const te=de>5e3;c(te);const V=de>1e4;w(V),m&&B(de>500)}),y&&(de>5e3,U(H.target))},[m,y,U]);return s.useEffect(()=>{m&&v.length<=500&&s.startTransition(()=>{B(!1)})},[v,m]),s.useEffect(()=>()=>{R.current&&clearTimeout(R.current)},[]),{message:v,setMessage:S,textareaRef:I,canSendMessage:T,handleSubmit:N,handleKeyDown:Y,handleChange:me,textareaHeight:W,isComposing:f,showCharCount:$,adjustTextareaHeight:U,handleCompositionStart:J,handleCompositionEnd:ee,isLargeText:D,performanceWarning:k,isDarkMode:A,isMobile:z,isTablet:P}},cr=()=>{const t=$e().palette.mode==="dark",o=se(r=>r.settings.inputBoxStyle||"default");return{styles:s.useMemo(()=>{const r={inputBg:"transparent",iconBg:t?"rgba(40, 40, 40, 0.8)":"rgba(248, 250, 252, 0.8)",border:t?"1px solid rgba(60, 60, 60, 0.8)":"1px solid rgba(230, 230, 230, 0.8)",borderRadius:"8px",boxShadow:t?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.1)"};switch(o){case"modern":return{...r,inputBg:"transparent",borderRadius:"12px",boxShadow:t?"0 4px 16px rgba(0,0,0,0.4)":"0 4px 16px rgba(0,0,0,0.15)"};case"minimal":return{...r,inputBg:"transparent",border:t?"1px solid rgba(255, 255, 255, 0.1)":"1px solid rgba(0, 0, 0, 0.1)",borderRadius:"6px",boxShadow:"none"};default:return r}},[t,o]),isDarkMode:t,inputBoxStyle:o}},Lr=({open:n,onClose:t,availableModels:o,onConfirm:a,maxSelection:r=5})=>{const i=$e(),d=Qt(i.breakpoints.down("sm")),[l,x]=s.useState([]),b=se(f=>f.settings.providers||[]),p=s.useMemo(()=>{const f=new Map;return b.forEach(M=>{f.set(M.id,M.name)}),f},[b]),y="multiModelSelector_lastSelection",g=s.useCallback(()=>{try{const f=localStorage.getItem(y);if(f)return JSON.parse(f).filter(B=>o.some(D=>v(D)===B))}catch(f){console.warn("加载上次多模型选择失败:",f)}return[]},[o]),m=s.useCallback(f=>{try{localStorage.setItem(y,JSON.stringify(f))}catch(M){console.warn("保存多模型选择失败:",M)}},[]);s.useEffect(()=>{if(n&&l.length===0){const f=g();f.length>0&&x(f)}},[n,g,l.length]);const v=s.useCallback(f=>`${f.provider||f.providerType||"unknown"}:${f.id}`,[]),S=s.useCallback(f=>{const M=v(f);x($=>$.includes(M)?$.filter(B=>B!==M):$.length>=r?$:[...$,M])},[r,v]),I=s.useCallback(()=>{const f=o.slice(0,r).map(M=>v(M));x(f)},[o,r,v]),E=s.useCallback(()=>{x([])},[]),F=s.useCallback(()=>{const f=g();f.length>0&&x(f)},[g]),h=s.useCallback(()=>{if(l.length>0){m(l);const f=l.map(M=>o.find($=>v($)===M)).filter(Boolean);a(f),x([]),t()}},[l,o,v,a,t,m]),A=s.useCallback(()=>{x([]),t()},[t]),z=s.useCallback(f=>f.name||f.id,[]),P=s.useCallback(f=>p.get(f)||f,[p]),W=s.useCallback(f=>b.find(M=>M.id===f),[b]),u=s.useMemo(()=>{const f={};o.forEach($=>{const B=$.provider||$.providerType||"unknown";f[B]||(f[B]=[]),f[B].push($)});const M=Object.keys(f).sort(($,B)=>{const D=b.findIndex(T=>T.id===$),c=b.findIndex(T=>T.id===B);if(D!==-1&&c!==-1)return D-c;if(D!==-1)return-1;if(c!==-1)return 1;const k=P($),w=P(B);return k.localeCompare(w)});return{groups:f,sortedGroups:M}},[o,P,b]);return e.jsxs(ht,{open:n,onClose:A,fullScreen:d,maxWidth:"sm",fullWidth:!0,slotProps:{paper:{sx:{borderRadius:d?0:2,maxHeight:"80vh"}}},children:[e.jsxs(xt,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",pb:1},children:[e.jsxs(C,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(tr,{size:20,style:{marginRight:8,color:i.palette.primary.main}}),e.jsx(K,{variant:"h6",children:"选择多个模型"})]}),e.jsx(ne,{onClick:A,size:"small",children:e.jsx(Ve,{size:20})})]}),e.jsxs(gt,{sx:{px:1,py:1},children:[e.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,px:2},children:[e.jsxs(K,{variant:"body2",color:"text.secondary",children:["已选择 ",l.length," / ",r," 个模型"]}),e.jsxs(C,{children:[e.jsx(Te,{title:"选择上次的模型",children:e.jsx(ne,{size:"small",onClick:F,disabled:g().length===0,sx:{color:g().length>0?i.palette.primary.main:"inherit"},children:e.jsx(is,{size:16})})}),e.jsx(Te,{title:"全选",children:e.jsx(ne,{size:"small",onClick:I,disabled:o.length===0,children:e.jsx(Sn,{size:16})})}),e.jsx(Te,{title:"清空",children:e.jsx(ne,{size:"small",onClick:E,disabled:l.length===0,children:e.jsx(_t,{size:16})})})]})]}),g().length>0&&l.length===0&&e.jsx(C,{sx:{mb:2,px:2},children:e.jsxs(Ie,{variant:"outlined",size:"small",startIcon:e.jsx(is,{size:16}),onClick:F,sx:{borderColor:i.palette.primary.main,color:i.palette.primary.main,"&:hover":{backgroundColor:i.palette.primary.main+"10"}},children:["快速选择上次的 ",g().length," 个模型"]})}),l.length>0&&e.jsxs(C,{sx:{mb:2,px:2},children:[e.jsx(K,{variant:"caption",color:"text.secondary",sx:{mb:1,display:"block"},children:"已选择的模型："}),e.jsx(C,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:l.map(f=>{const M=o.find($=>v($)===f);return M?e.jsx(tt,{label:`${P(M.provider||M.providerType||"未知")} / ${z(M)}`,size:"small",onDelete:()=>S(M),color:"primary",variant:"outlined"},f):null})})]}),e.jsx(et,{sx:{pt:0},children:u.sortedGroups.flatMap(f=>{const M=P(f),$=W(f),B=u.groups[f];return[e.jsxs(qe,{sx:{bgcolor:i.palette.mode==="dark"?"#3A3A3A":"#F5F5F5",fontWeight:600,fontSize:"0.8rem",py:.75,px:2,minHeight:32,position:"sticky",top:0,zIndex:10,borderBottom:`1px solid ${i.palette.mode==="dark"?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"}`,"&:not(:first-of-type)":{borderTop:`1px solid ${i.palette.mode==="dark"?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"}`}},children:[e.jsx(ye,{sx:{minWidth:32},children:e.jsx(C,{sx:{width:16,height:16,borderRadius:"50%",bgcolor:$?.color||i.palette.primary.main,color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.65rem",fontWeight:"bold"},children:$?.avatar||M[0]})}),e.jsx(we,{primary:M,slotProps:{primary:{fontSize:"0.8rem",fontWeight:600}}})]},`header-${f}`),...B.map(D=>{const c=v(D),k=l.includes(c),w=!k&&l.length>=r;return e.jsxs(qe,{component:"div",onClick:()=>!w&&S(D),sx:{borderRadius:1,mb:.5,ml:2,opacity:w?.5:1,cursor:w?"not-allowed":"pointer","&:hover":{backgroundColor:w?"transparent":i.palette.action.hover}},children:[e.jsx(ye,{children:e.jsx(Ws,{checked:k,disabled:w,color:"primary",onChange:()=>!w&&S(D)})}),e.jsx(we,{primary:`${z(D)}`,secondary:D.description||`${D.id}`,slotProps:{primary:{fontWeight:k?600:400},secondary:{fontSize:"0.75rem"}}})]},c)})].filter(Boolean)})}),o.length===0&&e.jsx(C,{sx:{textAlign:"center",py:4},children:e.jsx(K,{variant:"body2",color:"text.secondary",children:"没有可用的模型"})})]}),e.jsxs(sr,{sx:{px:3,pb:2},children:[e.jsx(Ie,{onClick:A,color:"inherit",children:"取消"}),e.jsxs(Ie,{onClick:h,variant:"contained",disabled:l.length===0,startIcon:e.jsx(tr,{size:16}),children:["发送到 ",l.length," 个模型"]})]})]})},vs=({anchorEl:n,open:t,onClose:o,onImageUpload:a,onFileUpload:r,onMultiModelSend:i,showMultiModel:d=!1,onAIDebate:l,showAIDebate:x=!1,isDebating:b=!1,onQuickPhrase:p,showQuickPhrase:y=!1})=>e.jsxs(Tr,{anchorEl:n,open:t,onClose:o,disableAutoFocus:!0,disableRestoreFocus:!0,disableEnforceFocus:!0,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"},slotProps:{paper:{sx:{minWidth:"200px",borderRadius:"12px",boxShadow:"0 4px 20px rgba(0,0,0,0.15)"}},root:{slotProps:{backdrop:{invisible:!1,sx:{backgroundColor:"transparent"}}}}},sx:{"& .MuiList-root":{"&:focus":{outline:"none"}}},children:[e.jsxs(De,{onClick:()=>{a("photos"),o()},sx:{py:1.5},children:[e.jsx(ye,{children:e.jsx(pt,{size:20,color:"#1976d2"})}),e.jsx(we,{primary:"从相册选择图片"})]}),e.jsxs(De,{onClick:()=>{a("camera"),o()},sx:{py:1.5},children:[e.jsx(ye,{children:e.jsx($r,{size:20,color:"#9c27b0"})}),e.jsx(we,{primary:"拍摄照片"})]}),e.jsxs(De,{onClick:()=>{r(),o()},sx:{py:1.5},children:[e.jsx(ye,{children:e.jsx(Rt,{size:20,color:"#4caf50"})}),e.jsx(we,{primary:"上传文件"})]}),x&&l&&[e.jsx(Ye,{sx:{my:.5}},"ai-debate-divider"),e.jsxs(De,{onClick:()=>{l(),o()},sx:{py:1.5},children:[e.jsx(ye,{children:e.jsx(ze,{name:"aiDebate",size:20,color:"currentColor"})}),e.jsx(we,{primary:b?"停止AI辩论":"开始AI辩论",secondary:b?"结束当前辩论":"多AI角色辩论功能",sx:{"& .MuiListItemText-secondary":{fontSize:"0.75rem",color:"text.secondary"}}})]},"ai-debate-item")],y&&p&&[e.jsx(Ye,{sx:{my:.5}},"quick-phrase-divider"),e.jsxs(De,{onClick:()=>{p(),o()},sx:{py:1.5},children:[e.jsx(ye,{children:e.jsx(ze,{name:"quickPhrase",size:20,color:"currentColor"})}),e.jsx(we,{primary:"快捷短语",secondary:"插入预设的文本短语",sx:{"& .MuiListItemText-secondary":{fontSize:"0.75rem",color:"text.secondary"}}})]},"quick-phrase-item")],d&&i&&[e.jsx(Ye,{sx:{my:.5}},"multi-model-divider"),e.jsxs(De,{onClick:()=>{i(),o()},sx:{py:1.5},children:[e.jsx(ye,{children:e.jsx(tr,{size:20})}),e.jsx(we,{primary:"发送到多个模型",secondary:"同时向多个AI模型发送消息",sx:{"& .MuiListItemText-secondary":{fontSize:"0.75rem",color:"text.secondary"}}})]},"multi-model-item")]]});var ct;(function(n){n.Prompt="PROMPT",n.Camera="CAMERA",n.Photos="PHOTOS"})(ct||(ct={}));var Wt;(function(n){n.Rear="REAR",n.Front="FRONT"})(Wt||(Wt={}));var Ir;(function(n){n.Uri="uri",n.Base64="base64",n.DataUrl="dataUrl"})(Ir||(Ir={}));class Tn extends hs{async getPhoto(t){return new Promise(async(o,a)=>{if(t.webUseInput||t.source===ct.Photos)this.fileInputExperience(t,o,a);else if(t.source===ct.Prompt){let r=document.querySelector("pwa-action-sheet");r||(r=document.createElement("pwa-action-sheet"),document.body.appendChild(r)),r.header=t.promptLabelHeader||"Photo",r.cancelable=!1,r.options=[{title:t.promptLabelPhoto||"From Photos"},{title:t.promptLabelPicture||"Take Picture"}],r.addEventListener("onSelection",async i=>{i.detail===0?this.fileInputExperience(t,o,a):this.cameraExperience(t,o,a)})}else this.cameraExperience(t,o,a)})}async pickImages(t){return new Promise(async(o,a)=>{this.multipleFileInputExperience(o,a)})}async cameraExperience(t,o,a){if(customElements.get("pwa-camera-modal")){const r=document.createElement("pwa-camera-modal");r.facingMode=t.direction===Wt.Front?"user":"environment",document.body.appendChild(r);try{await r.componentOnReady(),r.addEventListener("onPhoto",async i=>{const d=i.detail;d===null?a(new mr("User cancelled photos app")):d instanceof Error?a(d):o(await this._getCameraPhoto(d,t)),r.dismiss(),document.body.removeChild(r)}),r.present()}catch{this.fileInputExperience(t,o,a)}}else console.error("Unable to load PWA Element 'pwa-camera-modal'. See the docs: https://capacitorjs.com/docs/web/pwa-elements."),this.fileInputExperience(t,o,a)}fileInputExperience(t,o,a){let r=document.querySelector("#_capacitor-camera-input");const i=()=>{var d;(d=r.parentNode)===null||d===void 0||d.removeChild(r)};r||(r=document.createElement("input"),r.id="_capacitor-camera-input",r.type="file",r.hidden=!0,document.body.appendChild(r),r.addEventListener("change",d=>{const l=r.files[0];let x="jpeg";if(l.type==="image/png"?x="png":l.type==="image/gif"&&(x="gif"),t.resultType==="dataUrl"||t.resultType==="base64"){const b=new FileReader;b.addEventListener("load",()=>{if(t.resultType==="dataUrl")o({dataUrl:b.result,format:x});else if(t.resultType==="base64"){const p=b.result.split(",")[1];o({base64String:p,format:x})}i()}),b.readAsDataURL(l)}else o({webPath:URL.createObjectURL(l),format:x}),i()}),r.addEventListener("cancel",d=>{a(new mr("User cancelled photos app")),i()})),r.accept="image/*",r.capture=!0,t.source===ct.Photos||t.source===ct.Prompt?r.removeAttribute("capture"):t.direction===Wt.Front?r.capture="user":t.direction===Wt.Rear&&(r.capture="environment"),r.click()}multipleFileInputExperience(t,o){let a=document.querySelector("#_capacitor-camera-input-multiple");const r=()=>{var i;(i=a.parentNode)===null||i===void 0||i.removeChild(a)};a||(a=document.createElement("input"),a.id="_capacitor-camera-input-multiple",a.type="file",a.hidden=!0,a.multiple=!0,document.body.appendChild(a),a.addEventListener("change",i=>{const d=[];for(let l=0;l<a.files.length;l++){const x=a.files[l];let b="jpeg";x.type==="image/png"?b="png":x.type==="image/gif"&&(b="gif"),d.push({webPath:URL.createObjectURL(x),format:b})}t({photos:d}),r()}),a.addEventListener("cancel",i=>{o(new mr("User cancelled photos app")),r()})),a.accept="image/*",a.click()}_getCameraPhoto(t,o){return new Promise((a,r)=>{const i=new FileReader,d=t.type.split("/")[1];o.resultType==="uri"?a({webPath:URL.createObjectURL(t),format:d,saved:!1}):(i.readAsDataURL(t),i.onloadend=()=>{const l=i.result;o.resultType==="dataUrl"?a({dataUrl:l,format:d,saved:!1}):a({base64String:l.split(",")[1],format:d,saved:!1})},i.onerror=l=>{r(l)})})}async checkPermissions(){if(typeof navigator>"u"||!navigator.permissions)throw this.unavailable("Permissions API not available in this browser");try{return{camera:(await window.navigator.permissions.query({name:"camera"})).state,photos:"granted"}}catch{throw this.unavailable("Camera permissions are not available in this browser")}}async requestPermissions(){throw this.unimplemented("Not implemented on web.")}async pickLimitedLibraryPhotos(){throw this.unavailable("Not implemented on web.")}async getLimitedLibraryPhotos(){throw this.unavailable("Not implemented on web.")}}const Vt=Rr("Camera",{web:()=>new Tn}),vr={async selectImages(n="photos"){try{if(Zt.isNativePlatform()){const o=n==="camera"?ct.Camera:ct.Photos,a=await Vt.checkPermissions();if(a.photos!=="granted"&&n==="photos"){if((await Vt.requestPermissions({permissions:["photos"]})).photos!=="granted")throw new Error("需要相册访问权限")}else if(a.camera!=="granted"&&n==="camera"&&(await Vt.requestPermissions({permissions:["camera"]})).camera!=="granted")throw new Error("需要相机访问权限");const r=await Vt.getPhoto({quality:75,allowEditing:!1,resultType:Ir.Base64,source:o,width:1024,height:1024,correctOrientation:!0});if(!r||!r.base64String)throw new Error("获取图片失败");let i=r.format?`image/${r.format.toLowerCase()}`:"image/jpeg";return[{url:"",base64Data:`data:${i};base64,${r.base64String}`,mimeType:i}]}else return new Promise((o,a)=>{const r=document.createElement("input");r.type="file",r.accept="image/*",r.multiple=!0;let i=!1;r.onchange=async l=>{if(i)return;i=!0;const x=l.target.files;if(!x||x.length===0){o([]);return}try{const b=await Promise.all(Array.from(x).map(p=>this.processFile(p)));o(b)}catch(b){a(b)}},r.oncancel=()=>{i||(i=!0,o([]))};const d=()=>{setTimeout(()=>{!i&&(!r.files||r.files.length===0)&&(i=!0,o([])),window.removeEventListener("focus",d)},300)};window.addEventListener("focus",d),r.click()})}catch(t){throw console.error("选择图片失败:",t),t}},async processFile(n){return new Promise((t,o)=>{try{const a=new FileReader;a.onload=r=>{if(!r.target||!r.target.result){o(new Error("读取文件失败"));return}const i=r.target.result,d=new Image;d.onload=()=>{const l={url:"",base64Data:i,mimeType:n.type,width:d.width,height:d.height,size:n.size};t(l)},d.onerror=()=>{o(new Error("图片加载失败"))},d.src=i},a.onerror=()=>{o(new Error("读取文件失败"))},a.readAsDataURL(n)}catch(a){o(a)}})},async compressImage(n,t=1024){return new Promise((o,a)=>{try{if(!n.base64Data){o(n);return}const r=new Image;r.onload=()=>{const i=Math.round((n.base64Data?.length||0)*.75/1024);if(i<=t){o({...n,width:r.width,height:r.height});return}const d=document.createElement("canvas"),l=d.getContext("2d");if(!l){a(new Error("无法创建Canvas上下文"));return}const x=2048,b=56;let p=r.width,y=r.height;(p>x||y>x)&&(p>y?(y=Math.round(y*x/p),p=x):(p=Math.round(p*x/y),y=x)),p<b&&(p=b),y<b&&(y=b),d.width=p,d.height=y,l.clearRect(0,0,p,y),l.drawImage(r,0,0,p,y);let g=.85;i>t*2?g=.7:i>t*5&&(g=.5);let m=d.toDataURL("image/jpeg",g),v=Math.round(m.length*.75/1024),S=0;for(;v>t&&S<5;)S++,g*=.8,m=d.toDataURL("image/jpeg",g),v=Math.round(m.length*.75/1024);console.log(`图片压缩：原始大小=${i}KB, 压缩后=${v}KB, 质量=${g}, 尺寸=${p}x${y}`),o({...n,base64Data:m,mimeType:"image/jpeg",width:p,height:y,size:v*1024})},r.onerror=()=>{a(new Error("图片加载失败"))},r.src=n.base64Data}catch(r){a(r)}})},ensureCorrectFormat(n){if(!n.base64Data)return n;if(!n.base64Data.startsWith("data:")){const t=n.mimeType||"image/jpeg";return{...n,base64Data:`data:${t};base64,${n.base64Data}`}}if((!n.width||!n.height)&&n.base64Data){const t=new Image;t.onload=()=>{console.log(`获取到图片尺寸: ${t.width}x${t.height}`)},t.src=n.base64Data}return n},base64ToUint8Array(n){const t=n.split(",")[1],o=atob(t),a=new Uint8Array(o.length);for(let r=0;r<o.length;r++)a[r]=o.charCodeAt(r);return a}};class Rn extends hs{constructor(){super(...arguments),this.ERROR_PICK_FILE_CANCELED="pickFiles canceled."}async checkPermissions(){throw this.unimplemented("Not implemented on web.")}async convertHeicToJpeg(t){throw this.unimplemented("Not implemented on web.")}async copyFile(t){throw this.unimplemented("Not implemented on web.")}async pickFiles(t){const o=await this.openFilePicker(t);if(!o)throw new Error(this.ERROR_PICK_FILE_CANCELED);const a={files:[]};for(const r of o){const i={blob:r,modifiedAt:r.lastModified,mimeType:this.getMimeTypeFromUrl(r),name:this.getNameFromUrl(r),path:void 0,size:this.getSizeFromUrl(r)};t?.readData&&(i.data=await this.getDataFromFile(r)),a.files.push(i)}return a}async pickDirectory(){throw this.unimplemented("Not implemented on web.")}async pickImages(t){return this.pickFiles(Object.assign({types:["image/*"]},t))}async pickMedia(t){return this.pickFiles(Object.assign({types:["image/*","video/*"]},t))}async pickVideos(t){return this.pickFiles(Object.assign({types:["video/*"]},t))}async requestPermissions(t){throw this.unimplemented("Not implemented on web.")}async openFilePicker(t){var o;const a=((o=t?.types)===null||o===void 0?void 0:o.join(","))||"",r=t?.limit===void 0?0:t.limit;return new Promise(i=>{let d=!1;const l=document.createElement("input");l.type="file",l.accept=a,l.multiple=r===0,l.addEventListener("change",()=>{d=!0;const x=Array.from(l.files||[]);i(x)},{once:!0}),window.addEventListener("focus",async()=>{await this.wait(1e3),!d&&i(void 0)},{once:!0}),l.click()})}async getDataFromFile(t){return new Promise((o,a)=>{const r=new FileReader;r.readAsDataURL(t),r.onload=()=>{const l=(typeof r.result=="string"?r.result:"").split("base64,")[1]||"";o(l)},r.onerror=i=>{a(i)}})}getNameFromUrl(t){return t.name}getMimeTypeFromUrl(t){return t.type}getSizeFromUrl(t){return t.size}async wait(t){return new Promise(o=>setTimeout(o,t))}}const Pn=Rr("FilePicker",{web:()=>new Rn}),ls=50*1024*1024,zr={async selectFiles(){try{if(Zt.isNativePlatform()){const t=await Pn.pickFiles({readData:!0});if(!t||!t.files||t.files.length===0)return[];const o=[];for(const a of t.files){if(a.size>ls){await yr.show({text:`文件 ${a.name} 太大，最大允许50MB`,duration:"long"});continue}try{const r=await Qr.uploadFile({name:a.name,mimeType:a.mimeType,size:a.size,base64Data:a.data?`data:${a.mimeType};base64,${a.data}`:""}),i={name:a.name,mimeType:a.mimeType,extension:a.name.split(".").pop()||"",size:a.size,base64Data:r.base64Data?`data:${a.mimeType};base64,${r.base64Data}`:void 0,url:"",fileId:r.id,fileRecord:r};if(a.mimeType.startsWith("image/")&&r.base64Data)try{const d=await this.getImageDimensions(`data:${a.mimeType};base64,${r.base64Data}`);i.width=d.width,i.height=d.height}catch(d){console.warn("获取图片尺寸失败:",d)}o.push(i)}catch(r){console.error("文件上传失败:",r),await yr.show({text:`文件 ${a.name} 上传失败: ${r instanceof Error?r.message:"未知错误"}`,duration:"long"})}}return o}else return new Promise((t,o)=>{const a=document.createElement("input");a.type="file",a.multiple=!0;let r=!1;a.onchange=async d=>{if(r)return;r=!0;const l=d.target.files;if(!l||l.length===0){t([]);return}try{const x=Array.from(l).filter(p=>p.size>ls?(alert(`文件 ${p.name} 太大，最大允许50MB`),!1):!0);if(x.length===0){t([]);return}const b=[];for(const p of x)try{const y=await Qr.uploadFile({name:p.name,mimeType:p.type,size:p.size,base64Data:await this.readFileAsBase64(p)}),g={name:p.name,mimeType:p.type,extension:p.name.split(".").pop()||"",size:p.size,base64Data:y.base64Data?`data:${p.type};base64,${y.base64Data}`:void 0,url:"",fileId:y.id,fileRecord:y};if(p.type.startsWith("image/")&&y.base64Data)try{const m=await this.getImageDimensions(`data:${p.type};base64,${y.base64Data}`);g.width=m.width,g.height=m.height}catch(m){console.warn("获取图片尺寸失败:",m)}b.push(g)}catch(y){console.error("文件上传失败:",y),alert(`文件 ${p.name} 上传失败: ${y instanceof Error?y.message:"未知错误"}`)}t(b)}catch(x){o(x)}},a.oncancel=()=>{r||(r=!0,t([]))};const i=()=>{setTimeout(()=>{!r&&(!a.files||a.files.length===0)&&(r=!0,t([])),window.removeEventListener("focus",i)},300)};window.addEventListener("focus",i),a.click()})}catch(n){throw console.error("选择文件失败:",n),await yr.show({text:"选择文件失败: "+(n instanceof Error?n.message:String(n)),duration:"long"}),n}},getFileIconByMimeType(n){return n.startsWith("image/")?"image":n.startsWith("video/")?"video":n.startsWith("audio/")?"audio":n.includes("pdf")?"picture_as_pdf":n.includes("word")||n.includes("document")?"description":n.includes("spreadsheet")||n.includes("excel")?"table_chart":n.includes("presentation")||n.includes("powerpoint")?"slideshow":n.includes("text/")?"text_snippet":"insert_drive_file"},async readFileAsBase64(n){return new Promise((t,o)=>{const a=new FileReader;a.onload=r=>{if(!r.target||!r.target.result){o(new Error("读取文件失败"));return}t(r.target.result)},a.onerror=()=>{o(new Error("读取文件失败"))},a.readAsDataURL(n)})},async getImageDimensions(n){return new Promise((t,o)=>{const a=new Image;a.onload=()=>{t({width:a.width,height:a.height})},a.onerror=()=>{o(new Error("图片加载失败"))},a.src=n})},formatFileSize(n){if(n===0)return"0 B";const t=["B","KB","MB","GB","TB"],o=Math.floor(Math.log(n)/Math.log(1024));return(n/Math.pow(1024,o)).toFixed(2)+" "+t[o]}},Cs=({currentTopicState:n,setUploadingMedia:t})=>({handleImageUpload:async(r="photos")=>{try{t(!0);const i=await vr.selectImages(r);if(i.length===0)return t(!1),[];const d=i.length;let l=0;const x=(y=1)=>{l+=y,console.log(`处理图片进度: ${l}/${d}`)},p=(await Promise.all(i.map(async(y,g)=>{try{const m=await vr.compressImage(y,1024);if(x(.5),n)try{const v=await rt.saveBase64Image(m.base64Data||"",{mimeType:m.mimeType,width:m.width,height:m.height,size:m.size,topicId:n.id});return x(.5),{url:`[图片:${v}]`,mimeType:m.mimeType,width:m.width,height:m.height}}catch(v){return console.warn("数据库存储图片失败，使用内存中的图片:",v),x(.5),m}else{const v=vr.ensureCorrectFormat(m);return x(.5),v}}catch(m){return console.error(`处理第 ${g+1} 张图片时出错:`,m),x(1),null}}))).filter(y=>y!==null);return t(!1),p}catch(i){throw console.error("图片上传失败:",i),t(!1),i}},handleFileUpload:async()=>{try{t(!0);const r=await zr.selectFiles();return r.length===0?(t(!1),[]):(t(!1),r)}catch(r){throw console.error("文件上传失败:",r),t(!1),r}}}),cs=({file:n,onRemove:t,status:o="success",progress:a=0,error:r,compact:i=!1,draggable:d=!1,onDragStart:l,onDragEnd:x})=>{const b=$e(),[p,y]=s.useState(!1),g=Os(n.name),m=()=>{const F=n.mimeType.toLowerCase(),h=i?16:24;return F.startsWith("image/")?e.jsx(pt,{size:h,color:"#2196f3"}):F.startsWith("video/")?e.jsx(lr,{size:h,color:"#f44336"}):F.startsWith("audio/")?e.jsx(vn,{size:h,color:"#4caf50"}):F.includes("pdf")?e.jsx(Rt,{size:h,color:"#e53935"}):F.includes("word")||F.includes("document")?e.jsx(Rt,{size:h,color:"#1565c0"}):g==="code"?e.jsx(Hs,{size:h,color:"#ff9800"}):F.includes("text/")?e.jsx(Rt,{size:h,color:"#757575"}):e.jsx(dn,{size:h,color:"#9e9e9e"})},v=()=>{switch(o){case"success":return e.jsx(Us,{size:16,color:"#4caf50"});case"error":return e.jsx(_s,{size:16,color:"#f44336"});case"uploading":case"validating":return null;default:return null}},S=()=>{switch(g){case"image":return"#2196f3";case"video":return"#f44336";case"audio":return"#4caf50";case"code":return"#ff9800";case"text":return"#757575";case"document":return"#9c27b0";default:return"#607d8b"}},I=F=>{y(!0),l?.(F)},E=F=>{y(!1),x?.(F)};return i?e.jsx(Te,{title:r||`${n.name} (${zr.formatFileSize(n.size)})`,children:e.jsxs(C,{draggable:d,onDragStart:I,onDragEnd:E,sx:{display:"inline-flex",alignItems:"center",padding:"4px 8px",margin:"2px",borderRadius:"16px",backgroundColor:o==="error"?"rgba(244, 67, 54, 0.1)":"rgba(0, 0, 0, 0.08)",border:o==="error"?"1px solid rgba(244, 67, 54, 0.3)":"none",position:"relative",cursor:d?"grab":"default",opacity:p?.5:1,transition:"all 0.2s ease",maxWidth:"200px","&:hover":{backgroundColor:o==="error"?"rgba(244, 67, 54, 0.15)":"rgba(0, 0, 0, 0.12)"}},children:[d&&e.jsx(ss,{size:12,color:"rgba(0, 0, 0, 0.4)",style:{marginRight:"4px"}}),e.jsx(C,{sx:{marginRight:"6px",display:"flex",alignItems:"center"},children:m()}),e.jsx(K,{variant:"caption",sx:{fontWeight:500,textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap",maxWidth:"100px",marginRight:"6px"},children:n.name}),v(),e.jsx(ne,{size:"small",onClick:t,sx:{marginLeft:"4px",padding:"2px",width:"16px",height:"16px",color:"rgba(0, 0, 0, 0.6)","&:hover":{color:"#f44336",backgroundColor:"rgba(244, 67, 54, 0.1)"}},children:e.jsx(Ve,{size:12})}),(o==="uploading"||o==="validating")&&e.jsx(Zr,{variant:a>0?"determinate":"indeterminate",value:a,sx:{position:"absolute",bottom:0,left:0,right:0,height:"2px",borderRadius:"0 0 16px 16px"}})]})}):e.jsxs(C,{draggable:d,onDragStart:I,onDragEnd:E,sx:{display:"flex",alignItems:"center",padding:"12px",borderRadius:"12px",backgroundColor:o==="error"?"rgba(244, 67, 54, 0.05)":b.palette.mode==="dark"?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.03)",border:o==="error"?"1px solid rgba(244, 67, 54, 0.3)":"1px solid rgba(0, 0, 0, 0.08)",position:"relative",margin:"8px 0",maxWidth:"100%",cursor:d?"grab":"default",opacity:p?.5:1,transition:"all 0.2s ease","&:hover":{backgroundColor:o==="error"?"rgba(244, 67, 54, 0.08)":b.palette.mode==="dark"?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.06)"}},children:[d&&e.jsx(C,{sx:{marginRight:"8px",display:"flex",alignItems:"center"},children:e.jsx(ss,{size:20,color:"rgba(0, 0, 0, 0.4)"})}),e.jsx(C,{sx:{marginRight:"12px",display:"flex",alignItems:"center"},children:m()}),e.jsxs(C,{sx:{flexGrow:1,overflow:"hidden",marginRight:"12px"},children:[e.jsxs(C,{sx:{display:"flex",alignItems:"center",marginBottom:"4px"},children:[e.jsx(K,{variant:"body2",sx:{fontWeight:500,textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap",maxWidth:"250px",marginRight:"8px"},children:n.name}),e.jsx(tt,{label:g.toUpperCase(),size:"small",sx:{height:"20px",fontSize:"10px",fontWeight:"bold",backgroundColor:S(),color:"white","& .MuiChip-label":{padding:"0 6px"}}})]}),e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(K,{variant:"caption",color:"textSecondary",children:zr.formatFileSize(n.size)}),o==="uploading"&&e.jsxs(K,{variant:"caption",color:"primary",children:["上传中... ",a>0&&`${Math.round(a)}%`]}),o==="validating"&&e.jsx(K,{variant:"caption",color:"warning.main",children:"验证中..."}),o==="error"&&r&&e.jsx(K,{variant:"caption",color:"error",children:r}),o==="success"&&e.jsx(K,{variant:"caption",color:"success.main",children:"就绪"})]})]}),e.jsx(C,{sx:{marginRight:"8px"},children:v()}),e.jsx(ne,{size:"small",onClick:t,sx:{color:"rgba(0, 0, 0, 0.6)","&:hover":{color:"#f44336",backgroundColor:"rgba(244, 67, 54, 0.1)"}},children:e.jsx(Ve,{size:20})}),(o==="uploading"||o==="validating")&&e.jsx(Zr,{variant:a>0?"determinate":"indeterminate",value:a,sx:{position:"absolute",bottom:0,left:0,right:0,height:"3px",borderRadius:"0 0 12px 12px"}})]})},En=({files:n,images:t,onRemoveFile:o,onRemoveImage:a,fileStatuses:r={},compact:i=!0,maxVisibleItems:d=3})=>{const l=$e(),[x,b]=s.useState(!1),[p,y]=s.useState({});s.useEffect(()=>{y(h=>{const A={};return t.forEach((z,P)=>{const W=P.toString();h[W]&&(A[W]=h[W])}),A})},[t.length]);const g=s.useCallback(async(h,A)=>{try{const z=`img_cache_${h}`,P=sessionStorage.getItem(z);if(P){y(f=>({...f,[A]:P}));return}const W=await rt.getImageBlob(h);if(!W){console.warn("图片不存在:",h);return}const u=URL.createObjectURL(W);sessionStorage.setItem(z,u),y(f=>({...f,[A]:u}))}catch(z){console.error("加载图片引用失败:",z)}},[]),m=s.useCallback((h,A)=>{if(h.base64Data)return h.base64Data;if(h.url){const z=h.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/);if(z&&z[1]){const P=z[1];return p[A]?p[A]:(g(P,A),"")}return h.url}return""},[p,g]),v=n.length+t.length,S=v>0,I=v>d,E=x?n:n.slice(0,Math.max(0,d-t.length)),F=x?t:t.slice(0,d);return S?e.jsxs(C,{sx:{width:"100%",marginBottom:"8px",borderRadius:"12px",backgroundColor:l.palette.background.paper,border:`1px solid ${l.palette.divider}`,overflow:"hidden",transition:"all 0.3s ease"},children:[e.jsxs(C,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 12px",backgroundColor:l.palette.action.hover,borderBottom:`1px solid ${l.palette.divider}`},children:[e.jsxs(K,{variant:"caption",color:"textSecondary",sx:{fontWeight:500},children:[v," 个文件已选择"]}),I&&e.jsx(ne,{size:"small",onClick:()=>b(!x),sx:{padding:"2px",color:l.palette.text.secondary,"&:hover":{backgroundColor:l.palette.action.hover}},children:x?e.jsx(Ut,{fontSize:"small"}):e.jsx(yt,{fontSize:"small"})})]}),e.jsxs(C,{sx:{padding:"8px"},children:[F.length>0&&e.jsx(C,{sx:{display:"flex",flexWrap:"wrap",gap:"6px",marginBottom:E.length>0?"8px":0},children:F.map((h,A)=>{const z=h.id||`image-${A}-${h.name||"unnamed"}-${h.size||Date.now()}`,P=m(h,A);return e.jsxs(C,{sx:{position:"relative",width:"48px",height:"48px",borderRadius:"8px",overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.1)",backgroundColor:P?"transparent":"rgba(0, 0, 0, 0.05)"},children:[P?e.jsx("img",{src:P,alt:`预览 ${A+1}`,style:{width:"100%",height:"100%",objectFit:"cover"},onError:W=>{console.warn("图片加载失败:",h),W.currentTarget.style.display="none"}}):e.jsx(C,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",color:"rgba(0, 0, 0, 0.5)"},children:"加载中..."}),e.jsx(ne,{size:"small",onClick:()=>a(A),sx:{position:"absolute",top:-6,right:-6,backgroundColor:"rgba(0, 0, 0, 0.7)",color:"white",padding:"2px",width:"16px",height:"16px","&:hover":{backgroundColor:"rgba(244, 67, 54, 0.8)"}},children:e.jsx(yt,{size:10,style:{transform:"rotate(45deg)"}})})]},z)})}),E.length>0&&e.jsx(C,{sx:{display:"flex",flexWrap:"wrap",gap:"4px"},children:E.map((h,A)=>{const z=`${h.name}-${h.size}`,P=r[z],W=h.id||`file-${A}-${h.name}-${h.size||Date.now()}`;return e.jsx(cs,{file:h,onRemove:()=>o(A),compact:i,status:P?.status,progress:P?.progress,error:P?.error,draggable:!1},W)})}),e.jsx(Xt,{in:x,children:e.jsxs(C,{sx:{marginTop:"8px"},children:[t.length>d&&e.jsx(C,{sx:{display:"flex",flexWrap:"wrap",gap:"6px",marginBottom:"8px"},children:t.slice(d).map((h,A)=>{const z=d+A,P=h.id?`extra-${h.id}`:`extra-image-${z}-${h.name||"unnamed"}-${h.size||Date.now()}`,W=m(h,z);return e.jsxs(C,{sx:{position:"relative",width:"48px",height:"48px",borderRadius:"8px",overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.1)",backgroundColor:W?"transparent":"rgba(0, 0, 0, 0.05)"},children:[W?e.jsx("img",{src:W,alt:`预览 ${z+1}`,style:{width:"100%",height:"100%",objectFit:"cover"},onError:u=>{console.warn("图片加载失败:",h),u.currentTarget.style.display="none"}}):e.jsx(C,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",color:"rgba(0, 0, 0, 0.5)"},children:"加载中..."}),e.jsx(ne,{size:"small",onClick:()=>a(z),sx:{position:"absolute",top:-6,right:-6,backgroundColor:"rgba(0, 0, 0, 0.7)",color:"white",padding:"2px",width:"16px",height:"16px","&:hover":{backgroundColor:"rgba(244, 67, 54, 0.8)"}},children:e.jsx(yt,{size:10,style:{transform:"rotate(45deg)"}})})]},P)})}),n.length>Math.max(0,d-t.length)&&e.jsx(C,{sx:{display:"flex",flexWrap:"wrap",gap:"4px"},children:n.slice(Math.max(0,d-t.length)).map((h,A)=>{const z=`${h.name}-${h.size}`,P=r[z],W=Math.max(0,d-t.length)+A,u=h.id?`extra-${h.id}`:`extra-file-${W}-${h.name}-${h.size||Date.now()}`;return e.jsx(cs,{file:h,onRemove:()=>o(W),compact:i,status:P?.status,progress:P?.progress,error:P?.error,draggable:!1},u)})})]})})]})]}):null},Wr=s.forwardRef(({images:n,files:t,setImages:o,setFiles:a,setUploadingMedia:r,fileStatuses:i,setFileStatuses:d,isDarkMode:l,isMobile:x,borderRadius:b},p)=>{const[y,g]=s.useState(!1),[m,v]=s.useState(0),S=se(c=>c.messages.currentTopicId),[I,E]=s.useState(null),F=se(c=>c.settings),{handleImageUpload:h,handleFileUpload:A}=Cs({currentTopicState:I,setUploadingMedia:r});s.useEffect(()=>{(async()=>{if(S)try{const k=await rt.getTopic(S);k&&E(k)}catch(k){console.error("加载话题信息失败:",k)}})()},[S]);const z=async(c="photos")=>{try{const k=await h(c);k&&k.length>0&&o(w=>[...w,...k])}catch(k){console.error("图片上传失败:",k),r(!1)}},P=async()=>{try{const c=await A();c&&c.length>0&&a(k=>[...k,...c])}catch(c){console.error("文件上传失败:",c),r(!1)}};s.useImperativeHandle(p,()=>({handleImageUpload:z,handleFileUpload:P,handlePaste:D}),[]);const W=c=>{o(k=>k.filter((w,T)=>T!==c))},u=c=>{const k=t[c];if(k){const w=`${k.name}-${k.size}`;d(T=>{const R={...T};return delete R[w],R})}a(w=>w.filter((T,R)=>R!==c))},f=c=>{c.preventDefault(),c.stopPropagation(),v(k=>k+1),c.dataTransfer.items&&c.dataTransfer.items.length>0&&g(!0)},M=c=>{c.preventDefault(),c.stopPropagation(),v(k=>k-1),m<=1&&g(!1)},$=c=>{c.preventDefault(),c.stopPropagation()},B=async c=>{c.preventDefault(),c.stopPropagation(),g(!1),v(0);const k=Array.from(c.dataTransfer.files);if(k.length!==0)try{r(!0);for(const w of k)if(w.type.startsWith("image/")){const T=new FileReader;T.onload=R=>{const U=R.target?.result,Y={id:`img-${Date.now()}-${Math.random().toString(36).substring(2,11)}-${w.name.replace(/[^a-zA-Z0-9]/g,"")}`,url:U,base64Data:U,mimeType:w.type,name:w.name,size:w.size};o(J=>[...J,Y])},T.readAsDataURL(w)}else{const T=new FileReader;T.onload=R=>{const U=R.target?.result,Y={id:`file-${Date.now()}-${Math.random().toString(36).substring(2,11)}-${w.name.replace(/[^a-zA-Z0-9]/g,"")}`,name:w.name,mimeType:w.type,extension:w.name&&typeof w.name=="string"&&w.name.split(".").pop()||"",size:w.size,base64Data:U,url:""};a(J=>[...J,Y])},T.readAsDataURL(w)}Se.show({message:`成功添加 ${k.length} 个文件`,type:"success",duration:3e3})}catch(w){console.error("拖拽文件处理失败:",w),Se.show({message:"文件处理失败，请重试",type:"error",duration:3e3})}finally{r(!1)}},D=async c=>{const k=c.clipboardData;if(!k)return;const w=F.pasteLongTextAsFile??!1,T=F.pasteLongTextThreshold??1500,R=k.getData("text");if(R&&w&&R.length>T){c.preventDefault();try{r(!0);const{MobileFileStorageService:Y}=await rr(async()=>{const{MobileFileStorageService:oe}=await import("./index-5OteHtpV.js").then(ie=>ie.hD);return{MobileFileStorageService:oe}},__vite__mapDeps([0,1])),J=Y.getInstance(),ee=`粘贴的文本_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.txt`,H=new TextEncoder().encode(R),le=btoa(String.fromCharCode(...H)),de={name:ee,size:new Blob([R],{type:"text/plain"}).size,mimeType:"text/plain",base64Data:`data:text/plain;base64,${le}`},te=await J.uploadFile(de),V={name:te.origin_name,mimeType:te.mimeType||"text/plain",extension:te.ext||".txt",size:te.size,base64Data:te.base64Data,url:te.path||"",fileId:te.id,fileRecord:te};a(oe=>[...oe,V]),Se.show({message:`长文本已转换为文件: ${ee}`,type:"success",duration:3e3})}catch(Y){console.error("长文本转文件失败:",Y),Se.show({message:"长文本转文件失败，请重试",type:"error",duration:3e3})}finally{r(!1)}return}const N=Array.from(k.items).filter(Y=>Y.type.startsWith("image/"));if(N.length!==0){c.preventDefault();try{r(!0);for(const Y of N){const J=Y.getAsFile();if(J){const ee=new FileReader;ee.onload=me=>{const H=me.target?.result,le=Date.now(),te={id:`paste-img-${le}-${Math.random().toString(36).substring(2,11)}`,url:H,base64Data:H,mimeType:J.type,name:`粘贴的图片_${le}.${J.type&&typeof J.type=="string"&&J.type.includes("/")&&J.type.split("/")[1]||"png"}`,size:J.size};o(V=>[...V,te])},ee.readAsDataURL(J)}}Se.show({message:`成功粘贴 ${N.length} 张图片`,type:"success",duration:3e3})}catch(Y){console.error("粘贴图片处理失败:",Y),Se.show({message:"粘贴图片失败，请重试",type:"error",duration:3e3})}finally{r(!1)}}};return e.jsxs("div",{style:{position:"relative",width:"100%"},onDragEnter:f,onDragLeave:M,onDragOver:$,onDrop:B,children:[e.jsx(En,{files:t,images:n,onRemoveFile:u,onRemoveImage:W,fileStatuses:i,compact:!0,maxVisibleItems:x?2:3}),y&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:l?"rgba(33, 150, 243, 0.1)":"rgba(33, 150, 243, 0.05)",border:`2px dashed ${l?"#2196F3":"#1976D2"}`,borderRadius:b,display:"flex",alignItems:"center",justifyContent:"center",zIndex:1002,pointerEvents:"none"},children:e.jsx("div",{style:{color:l?"#2196F3":"#1976D2",fontSize:"16px",fontWeight:500,textAlign:"center",padding:"20px"},children:"📁 拖拽文件到这里上传"})})]})});Wr.displayName="FileUploadManager";const Fn=n=>{const t="custom-thin-scrollbar-styles";if(document.getElementById(t))return;const o=document.createElement("style");o.id=t,o.textContent=`
    .custom-thin-scrollbar::-webkit-scrollbar {
      width: 1px;
    }

    .custom-thin-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-thin-scrollbar::-webkit-scrollbar-thumb {
      background: ${n?"#555":"#ccc"};
      border-radius: 0px;
    }

    .custom-thin-scrollbar::-webkit-scrollbar-thumb:hover {
      background: ${n?"#666":"#999"};
    }
  `,document.head.appendChild(o)},ks=({message:n,textareaRef:t,textareaHeight:o,showCharCount:a,handleChange:r,handleKeyDown:i,handleCompositionStart:d,handleCompositionEnd:l,onPaste:x,isLoading:b,allowConsecutiveMessages:p,imageGenerationMode:y,videoGenerationMode:g,webSearchActive:m,isMobile:v,isTablet:S,isDarkMode:I,shouldHideVoiceButton:E,expanded:F,expandedHeight:h,onExpandToggle:A,isPageTransitioning:z,shouldHandleFocus:P})=>{const[W,u]=s.useState(!1),f=$e(),M=se(w=>w.settings.themeStyle),$=Pr(f,M);s.useEffect(()=>{const w=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&"ontouchend"in document;u(w)},[]),s.useEffect(()=>{Fn(I)},[I]);const B=s.useCallback(w=>{i(w),w.key==="Enter"&&(w.ctrlKey||w.metaKey)&&(w.preventDefault(),A())},[i,A]);s.useEffect(()=>{const w=t.current;if(!w||w.dataset.initialized==="true")return;const T=setTimeout(()=>{if(w&&w.dataset.initialized!=="true"){const N=v?32:S?36:34;w.style.height=`${N}px`,w.dataset.initialized="true"}},100),R=()=>{P()&&W&&t.current&&setTimeout(()=>{if(!t.current)return;t.current.scrollIntoView({behavior:"smooth",block:"center"}),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});const N=window.innerHeight,Y=N*.4,ee=t.current.getBoundingClientRect().bottom;if(ee>N-Y){const me=ee-(N-Y)+20;window.scrollBy({top:me,behavior:"smooth"})}},300)},U=()=>{};return w&&(w.addEventListener("focus",R),w.addEventListener("blur",U)),()=>{clearTimeout(T),w&&(w.removeEventListener("focus",R),w.removeEventListener("blur",U))}},[]);const D=$.textPrimary,c=s.useMemo(()=>({flexGrow:1,margin:E?S?"0 12px 0 4px":"0 8px 0 2px":S?"0 12px":"0 8px",position:"relative",transition:"margin 0.25s ease-in-out"}),[E,S]),k=s.useMemo(()=>y?"输入图像生成提示词... (Ctrl+Enter 展开)":g?"输入视频生成提示词... (Ctrl+Enter 展开)":m?"输入网络搜索内容... (Ctrl+Enter 展开)":"和ai助手说点什么... (Ctrl+Enter 展开)",[y,g,m]);return e.jsxs("div",{style:c,children:[e.jsx("textarea",{ref:t,className:"custom-thin-scrollbar",style:{fontSize:S?"17px":"16px",padding:S?"10px 0":"8px 0",border:"none",outline:"none",width:"100%",backgroundColor:"transparent",lineHeight:"1.4",fontFamily:"inherit",resize:"none",overflow:n.trim().length>0?"auto":"hidden",minHeight:F?`${h}px`:`${v?32:S?36:34}px`,height:F?`${h}px`:`${o}px`,maxHeight:F?`${h}px`:`${v?200:250}px`,color:D,transition:"height 0.3s ease-out, min-height 0.3s ease-out, max-height 0.3s ease",scrollbarWidth:"thin",scrollbarColor:`${I?"#555":"#ccc"} transparent`},placeholder:k,value:n,onChange:r,onKeyDown:B,onCompositionStart:d,onCompositionEnd:l,onPaste:x,disabled:b&&!p,rows:1}),a&&e.jsxs("div",{style:{position:"absolute",bottom:"-20px",right:"0",fontSize:"12px",color:n.length>1e3?"#f44336":I?"#888":"#666",opacity:.8,transition:"all 0.2s ease"},children:[n.length,n.length>1e3?" (过长)":""]})]})},An=n=>{const{uploadingMedia:t,isLoading:o,allowConsecutiveMessages:a,isStreaming:r,imageGenerationMode:i,webSearchActive:d,images:l,files:x,isDarkMode:b,isTablet:p,disabledColor:y,handleOpenUploadMenu:g,handleSubmit:m,onStopResponse:v,canSendMessage:S}=n,I=o&&!a;return e.jsxs(e.Fragment,{children:[e.jsx(Te,{title:"添加图片或文件",children:e.jsx("span",{children:e.jsx(ne,{size:p?"large":"medium",onClick:g,disabled:t||o&&!a,style:{color:t?y:b?"#ffffff":"#000000",padding:p?"10px":"8px",position:"relative",marginRight:p?"4px":"0"},children:t?e.jsx(dt,{size:p?28:24}):e.jsx(ws,{badgeContent:l.length+x.length,color:"primary",max:9,invisible:l.length+x.length===0,children:e.jsx(st,{size:p?28:24})})})})}),e.jsx(Te,{title:r?"停止生成":i?"生成图像":d?"搜索网络":"发送消息",children:e.jsx("span",{children:e.jsx(ne,{onClick:r&&v?v:m,disabled:!r&&(!S()||o&&!a),size:p?"large":"medium",style:{color:r?"#ff4d4f":!S()||o&&!a?y:i?"#9C27B0":d?"#3b82f6":b?"#4CAF50":"#09bb07",padding:p?"10px":"8px"},children:r?e.jsx(ar,{size:p?20:18}):I?e.jsx(dt,{size:p?28:24,color:"inherit"}):i?e.jsx(pt,{size:p?20:18}):d?e.jsx(Br,{size:p?20:18}):e.jsx(er,{size:p?20:18})})})})]})},Be={MAX_ROUNDS:5,MODERATOR_ENABLED:!0,SUMMARY_ENABLED:!0},Or=({onStartDebate:n,onStopDebate:t,isDebating:o=!1,disabled:a=!1,question:r=""})=>{const i=nr(),[d,l]=s.useState(!1),[x,b]=s.useState(null),[p,y]=s.useState(""),[g,m]=s.useState({maxRounds:Be.MAX_ROUNDS,enableModerator:Be.MODERATOR_ENABLED,enableSummary:Be.SUMMARY_ENABLED}),[v,S]=s.useState([]),[I,E]=s.useState(""),[F,h]=s.useState(!1),A=[{category:"科技与社会",topics:["人工智能是否会取代大部分人类工作？","社交媒体对青少年的影响是利大于弊还是弊大于利？","自动驾驶汽车是否应该全面推广？","远程工作是否应该成为未来工作的主流模式？","虚拟现实技术是否会改变人类的社交方式？"]},{category:"教育与成长",topics:["在线教育是否能够完全替代传统课堂教育？","学生是否应该从小学开始学习编程？","考试制度是否是评估学生能力的最佳方式？","家长是否应该限制孩子使用电子设备的时间？","大学教育是否对每个人都是必需的？"]},{category:"环境与可持续发展",topics:["个人行为改变是否足以应对气候变化？","核能是否是解决能源危机的最佳方案？","电动汽车是否真的比燃油汽车更环保？","是否应该禁止使用一次性塑料制品？","城市化发展是否有利于环境保护？"]},{category:"经济与商业",topics:["基本收入制度是否应该在全球推行？","加密货币是否会取代传统货币？","共享经济模式是否可持续发展？","企业是否应该承担更多的社会责任？","全球化是否对发展中国家有利？"]},{category:"健康与生活",topics:["素食主义是否比杂食更健康？","运动是否是保持健康的最重要因素？","心理健康是否应该得到与身体健康同等的重视？","基因编辑技术是否应该用于人类？","传统医学是否有科学依据？"]},{category:"社会与文化",topics:["社会应该追求绝对平等还是机会平等？","传统文化是否应该在现代社会中保持不变？","个人隐私权是否应该让位于公共安全？","言论自由是否应该有边界？","多元文化主义是否有利于社会和谐？"]}];s.useEffect(()=>{(()=>{try{const D=localStorage.getItem("aiDebateConfig");if(D){const k=JSON.parse(D);b(k),m({maxRounds:k.maxRounds||Be.MAX_ROUNDS,enableModerator:k.moderatorEnabled??Be.MODERATOR_ENABLED,enableSummary:k.summaryEnabled??Be.SUMMARY_ENABLED})}const c=localStorage.getItem("aiDebateConfigGroups");if(c){const k=JSON.parse(c);S(k)}}catch(D){console.error("加载AI辩论配置失败:",D)}})()},[]),s.useEffect(()=>{r&&y(r)},[r]);const z=()=>{o?t?.():(l(!0),r&&y(r))},P=()=>{if(!x||!p.trim())return;const B={...x,maxRounds:g.maxRounds,moderatorEnabled:g.enableModerator,summaryEnabled:g.enableSummary};n?.(p.trim(),B),l(!1)},W=()=>{l(!1),i("/settings/ai-debate")},u=B=>{if(E(B),B){const D=v.find(c=>c.id===B);D&&(b(D.config),m({maxRounds:D.config.maxRounds||Be.MAX_ROUNDS,enableModerator:D.config.moderatorEnabled??Be.MODERATOR_ENABLED,enableSummary:D.config.summaryEnabled??Be.SUMMARY_ENABLED}))}else{const D=localStorage.getItem("aiDebateConfig");if(D){const c=JSON.parse(D);b(c),m({maxRounds:c.maxRounds||Be.MAX_ROUNDS,enableModerator:c.moderatorEnabled??Be.MODERATOR_ENABLED,enableSummary:c.summaryEnabled??Be.SUMMARY_ENABLED})}}},f=x&&x.enabled&&x.roles.length>=2,$=o?{color:"error",icon:e.jsx(ar,{size:20}),tooltip:"停止AI辩论"}:{color:f?"primary":"default",icon:e.jsx(ze,{name:"aiDebate",size:20,color:"currentColor"}),tooltip:f?"开始AI辩论":"AI辩论功能未配置"};return e.jsxs(e.Fragment,{children:[e.jsx(Te,{title:$.tooltip,children:e.jsx("span",{children:e.jsx(ne,{onClick:z,disabled:a||!f&&!o,color:$.color,size:"small",children:$.icon})})}),e.jsxs(ht,{open:d,onClose:()=>l(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(xt,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ze,{name:"aiDebate",size:20,color:"currentColor",style:{marginRight:8}}),"AI辩论设置"]}),e.jsxs(gt,{children:[f?e.jsxs(Tt,{severity:"info",sx:{mb:2},children:["已配置 ",x?.roles.length," 个辩论角色，准备开始辩论。"]}):e.jsx(Tt,{severity:"warning",sx:{mb:2},children:"AI辩论功能未正确配置。请先配置至少2个辩论角色。"}),e.jsxs(C,{sx:{mb:2},children:[e.jsx(K,{variant:"subtitle2",sx:{mb:1},children:"辩论主题/问题"}),e.jsx(Ot,{value:p,onChange:B=>y(B.target.value),multiline:!0,rows:3,fullWidth:!0,placeholder:"请输入要辩论的主题或问题，或从下方选择预设主题...",disabled:!f}),e.jsxs(C,{sx:{mt:2},children:[e.jsx(Ie,{onClick:()=>h(!F),startIcon:F?e.jsx(Ut,{size:16}):e.jsx(yt,{size:16}),sx:{textTransform:"none",color:"text.secondary",fontSize:"0.875rem",p:.5,minWidth:"auto","&:hover":{bgcolor:"action.hover"}},children:"💡 快速选择预设主题"}),e.jsx(Xt,{in:F,children:e.jsx(C,{sx:{mt:1,maxHeight:200,overflow:"auto",border:1,borderColor:"divider",borderRadius:1,p:1},children:A.map((B,D)=>e.jsxs(C,{sx:{mb:1},children:[e.jsx(K,{variant:"caption",sx:{fontWeight:600,color:"primary.main",display:"block",mb:.5},children:B.category}),e.jsx(C,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:B.topics.map((c,k)=>e.jsx(tt,{label:c,size:"small",variant:"outlined",onClick:()=>y(c),sx:{fontSize:"0.7rem",height:24,cursor:"pointer","&:hover":{bgcolor:"primary.main",color:"white"}},disabled:!f},k))})]},D))})})]})]}),v.length>0&&e.jsx(C,{sx:{mb:2},children:e.jsxs(xs,{fullWidth:!0,size:"small",children:[e.jsx(Ks,{children:"选择配置分组"}),e.jsxs(Ns,{value:I,onChange:B=>u(B.target.value),label:"选择配置分组",children:[e.jsx(De,{value:"",children:e.jsxs(C,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ts,{size:16,style:{marginRight:8}}),"当前配置"]})}),v.map(B=>e.jsx(De,{value:B.id,children:e.jsxs(C,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ts,{size:16,style:{marginRight:8}}),B.name,e.jsxs(K,{variant:"caption",color:"text.secondary",sx:{ml:1},children:["(",B.config.roles.length," 个角色)"]})]})},B.id))]})]})}),f&&e.jsxs(C,{sx:{mb:2},children:[e.jsx(K,{variant:"subtitle2",sx:{mb:1},children:"参与辩论的角色："}),e.jsx(C,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:x?.roles.map(B=>e.jsx(tt,{label:B.name,size:"small",sx:{bgcolor:B.color,color:"white","& .MuiChip-label":{fontWeight:500}}},B.id))})]}),e.jsx(Ye,{sx:{my:2}}),e.jsx(K,{variant:"subtitle2",sx:{mb:1},children:"辩论设置："}),e.jsxs(C,{sx:{display:"grid",gap:2},children:[e.jsx(Ot,{label:"最大辩论轮数",value:g.maxRounds,onChange:B=>{const D=B.target.value;if(D==="")m({...g,maxRounds:0});else{const c=parseInt(D);isNaN(c)||m({...g,maxRounds:c})}},size:"small",disabled:!f,helperText:"输入数字，建议1-20轮"}),e.jsx(Jt,{control:e.jsx(Xr,{checked:g.enableModerator,onChange:B=>m({...g,enableModerator:B.target.checked}),disabled:!f}),label:"启用主持人"}),e.jsx(Jt,{control:e.jsx(Xr,{checked:g.enableSummary,onChange:B=>m({...g,enableSummary:B.target.checked}),disabled:!f}),label:"生成辩论总结"})]})]}),e.jsxs(sr,{children:[e.jsx(Ie,{onClick:W,startIcon:e.jsx(Pt,{size:16}),children:"配置角色"}),e.jsx(Ie,{onClick:()=>l(!1),children:"取消"}),e.jsx(Ie,{onClick:P,variant:"contained",startIcon:e.jsx(cn,{size:16}),disabled:!f||!p.trim(),children:"开始辩论"})]})]})]})},_r=({onInsertPhrase:n,assistant:t,disabled:o=!1,size:a="medium"})=>{const r=$e(),[i,d]=s.useState(null),[l,x]=s.useState([]),[b,p]=s.useState([]),[y,g]=s.useState(!1),[m,v]=s.useState({title:"",content:"",location:"global"}),S=s.useCallback(async()=>{try{const u=await Nt.getAll();if(x(u),t){const f=Nt.getAssistantPhrases(t);p(f)}}catch(u){console.error("加载快捷短语失败:",u)}},[t]);s.useEffect(()=>{S()},[S]);const I=u=>{d(u.currentTarget)},E=()=>{d(null)},F=u=>{n(u.content),E()},h=()=>{g(!0),E()},A=()=>{g(!1),v({title:"",content:"",location:"global"})},z=async()=>{if(!(!m.title.trim()||!m.content.trim()))try{m.location==="global"?await Nt.add({title:m.title,content:m.content}):m.location==="assistant"&&t&&await Nt.addAssistantPhrase(t,{title:m.title,content:m.content},async u=>{await rt.saveAssistant(u),window.dispatchEvent(new CustomEvent("assistantUpdated",{detail:{assistant:u}}))}),A(),await S()}catch(u){console.error("保存快捷短语失败:",u)}},P=s.useMemo(()=>[...b,...l],[b,l]),W=a==="large"?28:a==="small"?20:24;return e.jsxs(e.Fragment,{children:[e.jsx(Te,{title:"快捷短语",children:e.jsx("span",{children:e.jsx(ne,{onClick:I,disabled:o,size:a,style:{color:r.palette.mode==="dark"?"#fff":"#666",padding:a==="large"?"10px":a==="small"?"6px":"8px"},children:e.jsx(ze,{name:"quickPhrase",size:W,color:"currentColor"})})})}),e.jsxs(Tr,{anchorEl:i,open:!!i,onClose:E,disableAutoFocus:!0,disableRestoreFocus:!0,PaperProps:{style:{maxHeight:400,minWidth:250,maxWidth:350}},children:[P.length>0&&[...b.map(u=>e.jsxs(De,{onClick:()=>F(u),style:{paddingRight:16},children:[e.jsx(ye,{children:e.jsx(as,{size:18})}),e.jsx(we,{primary:u.title,secondary:u.content.length>50?u.content.substring(0,50)+"...":u.content,secondaryTypographyProps:{style:{fontSize:"0.75rem",opacity:.7}}})]},u.id)),...b.length>0&&l.length>0?[e.jsx(Ye,{},"divider-1")]:[],...l.map(u=>e.jsxs(De,{onClick:()=>F(u),style:{paddingRight:16},children:[e.jsx(ye,{children:e.jsx(ze,{name:"quickPhrase",size:18,color:"currentColor"})}),e.jsx(we,{primary:u.title,secondary:u.content.length>50?u.content.substring(0,50)+"...":u.content,secondaryTypographyProps:{style:{fontSize:"0.75rem",opacity:.7}}})]},u.id)),e.jsx(Ye,{},"divider-2")],e.jsxs(De,{onClick:h,children:[e.jsx(ye,{children:e.jsx(st,{size:18})}),e.jsx(we,{primary:"添加快捷短语..."})]})]}),e.jsxs(ht,{open:y,onClose:A,maxWidth:"sm",fullWidth:!0,children:[e.jsx(xt,{children:"添加快捷短语"}),e.jsx(gt,{children:e.jsxs(C,{sx:{display:"flex",flexDirection:"column",gap:2,pt:1},children:[e.jsx(Ot,{label:"标题",value:m.title,onChange:u=>v({...m,title:u.target.value}),fullWidth:!0,size:"small"}),e.jsx(Ot,{label:"内容",value:m.content,onChange:u=>v({...m,content:u.target.value}),multiline:!0,rows:4,fullWidth:!0,size:"small"}),e.jsxs(xs,{component:"fieldset",children:[e.jsx(Vs,{component:"legend",children:"添加位置"}),e.jsxs(qs,{value:m.location,onChange:u=>v({...m,location:u.target.value}),row:!0,children:[e.jsx(Jt,{value:"global",control:e.jsx(Jr,{size:"small"}),label:e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ze,{name:"quickPhrase",size:16,color:"currentColor"}),e.jsx(K,{variant:"body2",children:"全局快捷短语"})]})}),t&&e.jsx(Jt,{value:"assistant",control:e.jsx(Jr,{size:"small"}),label:e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(as,{size:16}),e.jsx(K,{variant:"body2",children:"助手提示词"})]})})]})]})]})}),e.jsxs(sr,{children:[e.jsx(Ie,{onClick:A,children:"取消"}),e.jsx(Ie,{onClick:z,variant:"contained",disabled:!m.title.trim()||!m.content.trim(),children:"保存"})]})]})]})};var ds;(function(n){n.Dark="DARK",n.Light="LIGHT",n.Default="DEFAULT"})(ds||(ds={}));var us;(function(n){n.Body="body",n.Ionic="ionic",n.Native="native",n.None="none"})(us||(us={}));const Cr=Rr("Keyboard"),Ur=()=>{const[n,t]=s.useState(!1),[o,a]=s.useState(!1),r=Ys(),i=s.useRef(r.pathname),d=s.useRef(null);return s.useEffect(()=>{let p=null,y=null;return(async()=>{if(Zt.isNativePlatform())try{p=await Cr.addListener("keyboardWillShow",()=>{console.log("[KeyboardManager] 键盘将要显示"),t(!0),setTimeout(()=>{a(!1)},100)}),y=await Cr.addListener("keyboardDidHide",()=>{console.log("[KeyboardManager] 键盘已隐藏"),t(!1)}),console.log("[KeyboardManager] 键盘事件监听器设置成功")}catch(m){console.warn("[KeyboardManager] 键盘事件监听器设置失败:",m)}else console.log("[KeyboardManager] Web 平台，跳过 Capacitor 键盘监听器设置")})(),()=>{p&&p.remove(),y&&y.remove()}},[]),s.useEffect(()=>{const p=r.pathname,y=i.current;if(p!==y){console.log("[KeyboardManager] 检测到路由变化:",y,"->",p),a(!0),d.current&&clearTimeout(d.current);const g=p==="/chat"?300:200;d.current=setTimeout(()=>{a(!1),console.log("[KeyboardManager] 页面切换状态结束")},g),i.current=p}return()=>{d.current&&clearTimeout(d.current)}},[r.pathname]),{isKeyboardVisible:n,isPageTransitioning:o,hideKeyboard:async()=>{if(Zt.isNativePlatform())try{await Cr.hide(),console.log("[KeyboardManager] 手动隐藏键盘")}catch(p){console.warn("[KeyboardManager] 隐藏键盘失败:",p)}else console.log("[KeyboardManager] Web 平台，跳过键盘隐藏操作")},shouldHandleFocus:()=>!o,setPageTransitioning:p=>{console.log("[KeyboardManager] 手动设置页面切换状态:",p),a(p)}}},Bn=`
  @keyframes shake {
    0%, 100% { transform: rotate(0); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
  }
`,Dn=({isVoiceMode:n,isDisabled:t=!1,onToggleVoiceMode:o,size:a="medium",color:r="default",tooltip:i,className:d})=>{const l=()=>{switch(a){case"small":return 20;case"large":return 28;default:return 24}},x=e.jsxs(ne,{onClick:o,disabled:t,className:d,color:n?"error":r,size:a,sx:{position:"relative",transition:"all 0.25s ease-in-out",backgroundColor:n?"rgba(211, 47, 47, 0.15)":"transparent","&:hover":{transform:t?"none":"scale(1.08)",backgroundColor:n?"rgba(211, 47, 47, 0.25)":"rgba(0, 0, 0, 0.08)"},"&.Mui-disabled":{opacity:.5},"&:active":{backgroundColor:n?"rgba(211, 47, 47, 0.3)":"rgba(0, 0, 0, 0.15)",transform:"scale(0.95)"}},"aria-label":n?"退出语音输入模式":"切换到语音输入模式",children:[n&&e.jsx(C,{sx:{position:"absolute",top:"50%",left:"50%",width:"85%",height:"85%",borderRadius:"50%",transform:"translate(-50%, -50%)",backgroundColor:"rgba(211, 47, 47, 0.15)",animation:"pulse 2s infinite","@keyframes pulse":{"0%":{transform:"translate(-50%, -50%) scale(0.9)",opacity:.7},"50%":{transform:"translate(-50%, -50%) scale(1.2)",opacity:.3},"100%":{transform:"translate(-50%, -50%) scale(0.9)",opacity:.7}}}}),e.jsx("style",{children:Bn}),n?e.jsx(wn,{size:l(),color:"#f44336",style:{transition:"color 0.2s ease-in-out, transform 0.2s ease-in-out",animation:"shake 1s ease-in-out"}}):e.jsx(Dr,{size:l(),style:{transition:"color 0.2s ease-in-out"}})]}),p=i||(n?"点击退出语音输入模式":"点击启用语音输入");return e.jsx(Te,{title:p,arrow:!0,placement:"top",children:x})},Hr=({isDarkMode:n=!1,onInsertText:t,onClose:o,startRecognition:a,currentMessage:r})=>{const{isListening:i,recognitionText:d,error:l,stopRecognition:x,permissionStatus:b}=ir(),[p]=s.useState(50),[y,g]=s.useState(!1),[m,v]=s.useState(0),[S,I]=s.useState(!1),[E,F]=s.useState(null),[h,A]=s.useState(!1),[z,P]=s.useState(0),[W,u]=s.useState("");s.useEffect(()=>{if(d&&i){const T=W+(W&&d?" ":"")+d;t(T)}},[d,i,t,W]),s.useEffect(()=>()=>{E&&clearTimeout(E),i&&x()},[i,x,E]);const f=s.useCallback(()=>{E&&(clearTimeout(E),F(null)),P(0)},[E]),M=s.useCallback(async()=>{if(!h)try{u(r),A(!0),await a({language:"zh-CN",partialResults:!0})}catch(T){console.error("启动录音失败:",T),A(!1)}},[h,a,r]),$=s.useCallback(T=>{T.preventDefault();const R=T.touches[0];g(!0),v(R.clientY),I(!1),f();const U=setTimeout(()=>{M()},300);F(U);const N=setInterval(()=>{P(Y=>Y>=100?(clearInterval(N),100):Y+100/30)},10);setTimeout(()=>{clearInterval(N)},300)},[f,M]),B=s.useCallback(T=>{if(!y)return;T.preventDefault();const R=T.touches[0],U=m-R.clientY;I(U>100)},[y,m]),D=s.useCallback(async T=>{if(T.preventDefault(),!!y){if(g(!1),f(),!h){o();return}if(S)try{await x(),o()}catch(R){console.error("取消录音失败:",R),o()}else try{await x(),o()}catch(R){console.error("发送录音失败:",R),o()}I(!1),v(0),A(!1),P(0)}},[y,S,x,o,f,h]),c=s.useCallback(T=>{T.preventDefault(),g(!0),v(T.clientY),I(!1),f();const R=setTimeout(()=>{M()},300);F(R);const U=setInterval(()=>{P(N=>N>=100?(clearInterval(U),100):N+100/30)},10);setTimeout(()=>{clearInterval(U)},300)},[f,M]),k=s.useCallback(T=>{if(!y)return;T.preventDefault();const R=m-T.clientY;I(R>100)},[y,m]),w=s.useCallback(async T=>{if(T.preventDefault(),!!y){if(g(!1),f(),!h){o();return}if(S)try{await x(),o()}catch(R){console.error("取消录音失败:",R),o()}else try{await x(),o()}catch(R){console.error("发送录音失败:",R),o()}I(!1),v(0),A(!1),P(0)}},[y,S,x,o,f,h]);return b==="denied"?e.jsxs(Gr,{elevation:1,sx:{height:80,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",backgroundColor:n?"#2a2a2a":"#fff",borderRadius:2,p:2,border:`1px solid ${n?"#444":"#e0e0e0"}`},children:[e.jsx(zn,{size:24,color:"#f44336",style:{marginBottom:8}}),e.jsx(K,{variant:"caption",color:"text.secondary",textAlign:"center",children:"需要麦克风权限"})]}):e.jsxs(C,{sx:{width:"100%",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTouchCallout:"none",WebkitTapHighlightColor:"transparent"},children:[e.jsx(C,{sx:{display:"flex",justifyContent:"flex-start",mb:1},children:e.jsx(Te,{title:"返回文字输入",children:e.jsx(ne,{onClick:o,size:"small",sx:{color:n?"rgba(255,255,255,0.7)":"rgba(0,0,0,0.7)","&:hover":{backgroundColor:n?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}},children:e.jsx(gs,{size:20})})})}),l&&e.jsx(C,{sx:{mb:1},children:e.jsxs(K,{variant:"caption",color:"error",sx:{fontSize:"0.75rem",userSelect:"none"},children:["错误: ",l.message]})}),e.jsx(C,{sx:{display:"flex",justifyContent:"center",mb:1,transform:S?"translateY(-10px)":"translateY(0)",transition:"transform 0.2s ease"},children:e.jsx(C,{sx:{backgroundColor:S?"#f44336":h?"#4caf50":n?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",borderRadius:"20px",px:2,py:.5,transition:"background-color 0.2s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none"},children:e.jsx(K,{variant:"body2",fontWeight:500,color:S||h?"#ffffff":n?"rgba(255,255,255,0.8)":"rgba(0,0,0,0.6)",sx:{fontSize:"0.8rem",textAlign:"center",transition:"color 0.2s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none"},children:S?"松开取消录音":h?"正在录音...":"长按开始录音"})})}),e.jsxs(Gr,{elevation:3,onTouchStart:$,onTouchMove:B,onTouchEnd:D,onMouseDown:c,onMouseMove:k,onMouseUp:w,onMouseLeave:w,sx:{height:80,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:n?"#2a2a2a":"#fff",borderRadius:2,border:S?"2px solid #f44336":h?"2px solid #4caf50":"2px solid #6366f1",position:"relative",overflow:"hidden",transition:"all 0.2s ease",px:2,cursor:"pointer",transform:S?"scale(0.95)":"scale(1)",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTouchCallout:"none",WebkitTapHighlightColor:"transparent"},children:[!h&&z>0&&e.jsx(C,{sx:{position:"absolute",top:0,left:0,height:"100%",width:`${z}%`,backgroundColor:"rgba(99, 102, 241, 0.3)",borderRadius:2,transition:"width 0.1s ease",zIndex:1}}),h&&e.jsx(C,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(135deg, #4caf50 0%, #66bb6a 50%, #81c784 100%)",borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",zIndex:2},children:e.jsx(C,{sx:{display:"flex",alignItems:"center",gap:"2px",height:"40%"},children:Array.from({length:20},(T,R)=>e.jsx(C,{sx:{width:"3px",backgroundColor:"rgba(255, 255, 255, 0.8)",borderRadius:"2px",animation:`wave-${R%4} 1.2s ease-in-out infinite`,animationDelay:`${R*.1}s`,height:`${20+p/100*60+Math.sin(R*.5)*20}%`,minHeight:"20%",maxHeight:"100%",transition:"height 0.1s ease","@keyframes wave-0":{"0%, 100%":{transform:"scaleY(0.3)"},"50%":{transform:"scaleY(1)"}},"@keyframes wave-1":{"0%, 100%":{transform:"scaleY(0.5)"},"50%":{transform:"scaleY(0.8)"}},"@keyframes wave-2":{"0%, 100%":{transform:"scaleY(0.7)"},"50%":{transform:"scaleY(1.2)"}},"@keyframes wave-3":{"0%, 100%":{transform:"scaleY(0.4)"},"50%":{transform:"scaleY(0.9)"}}}},R))})}),!h&&e.jsx(C,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",zIndex:2},children:e.jsx(K,{variant:"body2",color:n?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.6)",sx:{fontSize:"0.9rem",fontWeight:500,userSelect:"none"},children:"长按开始录音"})})]})]})},yo=({onSendMessage:n,onSendMultiModelMessage:t,onStartDebate:o,onStopDebate:a,isLoading:r=!1,allowConsecutiveMessages:i=!0,imageGenerationMode:d=!1,videoGenerationMode:l=!1,onSendImagePrompt:x,webSearchActive:b=!1,onStopResponse:p,isStreaming:y=!1,isDebating:g=!1,toolsEnabled:m=!0,availableModels:v=[]})=>{const[S,I]=s.useState(null),[E,F]=s.useState(!1);s.useEffect(()=>()=>{I(null)},[]);const[h,A]=s.useState(!1),[z,P]=s.useState("normal"),[W,u]=s.useState(!1),[f,M]=s.useState(!1),[$,B]=s.useState(Math.floor(window.innerHeight*.7)),[D,c]=s.useState(!1),[k,w]=s.useState([]),[T,R]=s.useState([]),[U,N]=s.useState(!1),[Y,J]=s.useState({}),[ee,me]=s.useState([]),H=s.useRef(null),le=se(q=>q.assistants.currentAssistant),{styles:de,isDarkMode:te,inputBoxStyle:V}=cr(),oe=$e(),ie=se(q=>q.settings.themeStyle),Q=Pr(oe,ie),L=se(q=>q.settings.showAIDebateButton??!0),X=se(q=>q.settings.showQuickPhraseButton??!0),{message:Z,setMessage:pe,textareaRef:O,canSendMessage:ue,handleSubmit:G,handleKeyDown:fe,handleChange:ke,textareaHeight:vt,showCharCount:Et,handleCompositionStart:Ft,handleCompositionEnd:At,isMobile:Re,isTablet:be}=Mr({onSendMessage:n,onSendImagePrompt:x,isLoading:r,allowConsecutiveMessages:i,imageGenerationMode:d,videoGenerationMode:l,toolsEnabled:m,images:k,files:T,setImages:w,setFiles:R,enableTextareaResize:!0,enableCompositionHandling:!0,enableCharacterCount:!0}),{isListening:Bt,startRecognition:mt,stopRecognition:ge}=ir(),{isKeyboardVisible:Qe,isPageTransitioning:je,shouldHandleFocus:nt}=Ur();s.useEffect(()=>Se.subscribe(me),[]);const{border:Ct,borderRadius:kt,boxShadow:St}=de,It=Q.iconColor,Dt=Q.isDark?"#555":"#ccc";s.useEffect(()=>{const q=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&"ontouchend"in document;A(q)},[]);const Ze=async q=>{if(!Z.trim()&&k.length===0&&T.length===0||!t)return;let Ee=Z.trim();const We=[...k,...T.filter(xe=>xe.mimeType.startsWith("image/")).map(xe=>({base64Data:xe.base64Data,url:xe.url||"",width:xe.width,height:xe.height}))],Oe=await Promise.all(We.map(async xe=>{let _e=xe.base64Data||xe.url;if(xe.url&&xe.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/)){const Je=xe.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/);if(Je&&Je[1])try{const at=Je[1],$t=await rt.getImageBlob(at);$t&&(_e=await new Promise(_=>{const re=new FileReader;re.onload=()=>_(re.result),re.readAsDataURL($t)}))}catch(at){console.error("加载图片引用失败:",at)}}return{type:"image_url",image_url:{url:_e}}})),he=T.filter(xe=>!xe.mimeType.startsWith("image/"));console.log("发送多模型消息:",{message:Ee,models:q.map(xe=>`${xe.provider||xe.providerType}:${xe.id}`),images:Oe.length,files:T.length,toolsEnabled:m}),t(Ee,q,Oe.length>0?Oe:void 0,m,he),pe(""),w([]),R([]),N(!1)};s.useEffect(()=>{const q=()=>{B(Math.floor(window.innerHeight*.7))};return window.addEventListener("resize",q),()=>window.removeEventListener("resize",q)},[]);const He=s.useCallback(()=>{const q=Z.length,We=Math.floor((Re?280:be?400:500)/(be?17:16)),Oe=(Z.match(/\n/g)||[]).length,he=Math.ceil(q/We)+Oe;u(he>3),c(f?!0:he>4)},[Z,Re,be,f]);s.useEffect(()=>{He()},[Z,He]),s.useEffect(()=>{setTimeout(He,100)},[f,He]);const ae=s.useCallback(q=>{ke(q),setTimeout(He,100)},[ke,He]),Ce=s.useCallback(()=>{M(!f)},[f]),ce=q=>{I(q.currentTarget)},Pe=()=>{I(null)},Me=async(q="photos")=>{H.current&&await H.current.handleImageUpload(q)},Le=async()=>{H.current&&await H.current.handleFileUpload()},Xe=s.useCallback(q=>{if(!O.current)return;const Ee=O.current,We=Ee.selectionStart,Oe=Ee.selectionEnd,he=Z,xe=he.slice(0,We)+q+he.slice(Oe);pe(xe),setTimeout(()=>{if(Ee){const _e=We+q.length;Ee.focus(),Ee.setSelectionRange(_e,_e)}},10)},[Z,pe]),zt=s.useRef(null),ft=s.useRef(null),bt=s.useCallback(()=>{if(g)a?.();else if(zt.current){const q=zt.current.querySelector("button");q&&q.click()}},[g,a]),Ht=s.useCallback(()=>{if(ft.current){const q=ft.current.querySelector("button");q&&q.click()}},[]),ot=()=>{z==="normal"?P("recording"):z==="recording"&&(Bt&&ge().catch(q=>console.error("停止语音识别出错:",q)),P("normal"))},dr=async q=>{if(q&&q.trim()){const Ee=[...k,...T.filter(he=>he.mimeType.startsWith("image/")).map(he=>({base64Data:he.base64Data,url:he.url||"",width:he.width,height:he.height}))],We=await Promise.all(Ee.map(async he=>{let xe=he.base64Data||he.url;if(he.url&&he.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/)){const _e=he.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/);if(_e&&_e[1])try{const Je=_e[1],at=await rt.getImageBlob(Je);at&&(xe=await new Promise(j=>{const _=new FileReader;_.onload=()=>j(_.result),_.readAsDataURL(at)}))}catch(Je){console.error("加载图片引用失败:",Je)}}return{type:"image_url",image_url:{url:xe}}})),Oe=T.filter(he=>!he.mimeType.startsWith("image/"));if(n(q.trim(),We.length>0?We:void 0,m,Oe),w([]),R([]),N(!1),P("normal"),"navigator"in window&&"vibrate"in navigator)try{navigator.vibrate(50)}catch{}}},ur=Re?{paddingTop:"0px",paddingBottom:h?"34px":"4px",maxWidth:"100%",marginTop:"0",marginLeft:"0",marginRight:"0",paddingLeft:"8px",paddingRight:"8px"}:be?{paddingTop:"0px",paddingBottom:h?"34px":"4px",maxWidth:"calc(100% - 40px)",marginTop:"0",marginLeft:"auto",marginRight:"auto"}:{paddingTop:"0px",paddingBottom:h?"34px":"6px",maxWidth:"calc(100% - 32px)",marginTop:"0",marginLeft:"auto",marginRight:"auto"};return e.jsxs("div",{style:{backgroundColor:"transparent",...ur,width:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:1e3,boxShadow:"none",transition:"all 0.3s ease",marginBottom:"0",paddingBottom:Qe&&Re?"env(safe-area-inset-bottom)":h?"34px":"0",border:"none",position:"relative"},children:[e.jsx(Wr,{ref:H,images:k,files:T,setImages:w,setFiles:R,setUploadingMedia:N,fileStatuses:Y,setFileStatuses:J,isDarkMode:te,isMobile:Re,borderRadius:kt}),e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:be?"6px 12px":"5px 8px",borderRadius:kt,background:Q.paper,border:Ct,minHeight:be?"56px":Re?"48px":"50px",boxShadow:St,width:"100%",maxWidth:"100%",backdropFilter:V==="modern"?"blur(10px)":"none",WebkitBackdropFilter:V==="modern"?"blur(10px)":"none",transition:"all 0.3s ease",position:"relative",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTouchCallout:"none",WebkitTapHighlightColor:"transparent"},children:[D&&e.jsx("div",{style:{position:"absolute",top:"4px",right:"4px",zIndex:10},children:e.jsx(Te,{title:f?"收起输入框":"展开输入框",children:e.jsx(ne,{onClick:Ce,size:"small",style:{color:f?"#2196F3":It,padding:"2px",width:"20px",height:"20px",minWidth:"20px",backgroundColor:te?"rgba(42, 42, 42, 0.9)":"rgba(255, 255, 255, 0.9)",backdropFilter:"blur(4px)",borderRadius:"6px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transition:"all 0.2s ease"},children:f?e.jsx(yt,{size:14}):e.jsx(Ut,{size:14})})})}),!W&&e.jsx(Te,{title:z==="normal"?"切换到语音输入模式":"退出语音输入模式",children:e.jsx("span",{children:e.jsx(ne,{onClick:ot,disabled:U||r&&!i,size:be?"large":"medium",style:{color:z!=="normal"?"#f44336":te?"#ffffff":"#000000",padding:be?"10px":"8px",backgroundColor:z!=="normal"?"rgba(211, 47, 47, 0.15)":"transparent",transition:"all 0.25s ease-in-out"},children:z==="normal"?e.jsx(Dr,{size:be?28:24}):e.jsx(bs,{size:be?28:24})})})}),z==="recording"?e.jsx("div",{style:{flexGrow:1,margin:be?"0 12px":"0 8px",position:"relative"},children:e.jsx(Hr,{isDarkMode:te,onClose:()=>P("normal"),onSendMessage:dr,onInsertText:q=>{pe(q)},startRecognition:mt,currentMessage:Z})}):e.jsx(ks,{message:Z,textareaRef:O,textareaHeight:vt,showCharCount:Et,handleChange:ae,handleKeyDown:fe,handleCompositionStart:Ft,handleCompositionEnd:At,onPaste:q=>{H.current&&H.current.handlePaste(q)},isLoading:r,allowConsecutiveMessages:i,imageGenerationMode:d,videoGenerationMode:l,webSearchActive:b,isMobile:Re,isTablet:be,isDarkMode:te,shouldHideVoiceButton:W,expanded:f,expandedHeight:$,onExpandToggle:Ce,isPageTransitioning:je,shouldHandleFocus:nt}),z!=="recording"&&e.jsx(An,{uploadingMedia:U,isLoading:r,allowConsecutiveMessages:i,isStreaming:y,imageGenerationMode:d,webSearchActive:b,images:k,files:T,isDarkMode:te,isTablet:be,disabledColor:Dt,handleOpenUploadMenu:ce,handleSubmit:G,onStopResponse:p,canSendMessage:ue})]}),e.jsx(vs,{anchorEl:S,open:!!S,onClose:Pe,onImageUpload:Me,onFileUpload:Le,onMultiModelSend:()=>F(!0),showMultiModel:!!(t&&v.length>1&&!y&&ue()),onAIDebate:bt,showAIDebate:L,isDebating:g,onQuickPhrase:Ht,showQuickPhrase:X}),e.jsx(Lr,{open:E,onClose:()=>F(!1),availableModels:v,onConfirm:Ze,maxSelection:5}),e.jsx(Er,{messages:ee,onClose:q=>Se.remove(q),maxVisible:3}),e.jsx("div",{style:{position:"absolute",left:"-9999px",top:"-9999px"},ref:zt,children:e.jsx(Or,{onStartDebate:o,onStopDebate:a,isDebating:g,disabled:!1,question:Z})}),e.jsx("div",{ref:ft,style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:-1,opacity:0,pointerEvents:"none"},children:e.jsx(_r,{onInsertPhrase:Xe,assistant:le,disabled:!1,size:"medium"})})]})},$n=()=>{const n=s.useCallback(async(o,a,r)=>{try{o?Ne.hasSavedActiveServers()&&(await Ne.restoreSavedActiveServers(),a?.(),console.log("[MCP] 总开关开启，已恢复之前的活跃服务器状态")):(await Ne.stopAllActiveServers(),a?.(),console.log("[MCP] 总开关关闭，已停止所有活跃服务器")),r?.(o)}catch(i){console.error(`[MCP] ${o?"恢复服务器状态":"停止服务器"}失败:`,i),r?.(o)}},[]),t=s.useCallback((o,a)=>r=>n(r,o,a),[n]);return{handleMCPToggle:n,createMCPToggleHandler:t}},qt={httpStream:{icon:Fr,color:"#9c27b0",label:"HTTP Stream"},inMemory:{icon:ms,color:"#4CAF50",label:"In Memory"},default:{icon:Pt,color:"#9e9e9e",label:"Default"}},Ss=({toolsEnabled:n=!0,onToolsEnabledChange:t})=>{const o=nr(),r=$e().palette.mode==="dark",[i,d]=s.useState(!1),[l,x]=s.useState([]),[b,p]=s.useState({}),[y,g]=s.useState(null),[m,v]=s.useState(!0),{createMCPToggleHandler:S}=$n(),I=se(c=>c.settings?.toolbarDisplayStyle||"both"),E=se(c=>c.settings?.toolbarStyle||"glassmorphism"),F=s.useMemo(()=>l.filter(c=>c.isActive),[l]),h=s.useMemo(()=>E==="glassmorphism"?zs(r):Ts(r),[E,r]),A=s.useCallback(()=>{try{const c=Ne.getServers();x(c),g(null)}catch(c){console.error("加载服务器列表失败:",c),g("加载服务器列表失败")}finally{v(!1)}},[]);s.useEffect(()=>{A()},[A]);const z=s.useCallback(()=>{d(!0),A()},[A]),P=s.useCallback(()=>{d(!1),g(null)},[]),W=s.useCallback(async(c,k)=>{p(w=>({...w,[c]:!0})),g(null);try{if(await Ne.toggleServer(c,k),A(),t){const w=Ne.getActiveServers();k&&!n?(console.log("[MCP] 开启服务器，自动启用MCP工具总开关"),t(!0)):!k&&w.length===0&&n&&(console.log("[MCP] 所有服务器已关闭，自动禁用MCP工具总开关"),t(!1))}}catch(w){console.error("切换服务器状态失败:",w),g(`切换服务器状态失败: ${w instanceof Error?w.message:"未知错误"}`)}finally{p(w=>{const{[c]:T,...R}=w;return R})}},[A,t,n]),u=s.useCallback(()=>{d(!1),o("/settings/mcp-server")},[o]),f=s.useCallback(c=>S(A,t)(c),[S,A,t]),M=s.useCallback(c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),z())},[z]),$=s.useCallback(c=>{const w=(qt[c]||qt.default).icon;return e.jsx(w,{size:16})},[]),B=s.useCallback(c=>(qt[c]||qt.default).color,[]),D=F.length>0;return e.jsxs(e.Fragment,{children:[e.jsxs(C,{role:"button",tabIndex:0,"aria-label":"打开 MCP 工具管理",onClick:z,onKeyDown:M,sx:{...h.button,...D&&E==="glassmorphism"&&{background:r?"rgba(16, 185, 129, 0.15)":"rgba(16, 185, 129, 0.2)",border:r?"1px solid rgba(16, 185, 129, 0.25)":"1px solid rgba(16, 185, 129, 0.35)",boxShadow:r?"0 4px 16px rgba(16, 185, 129, 0.1), 0 1px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(16, 185, 129, 0.2)":"0 4px 16px rgba(16, 185, 129, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(16, 185, 129, 0.3)"},...D&&E==="transparent"&&{background:r?"rgba(16, 185, 129, 0.08)":"rgba(16, 185, 129, 0.05)"},margin:E==="glassmorphism"?"0 4px":"0 2px","&:hover":{...h.buttonHover,...D&&E==="glassmorphism"&&{background:r?"rgba(16, 185, 129, 0.2)":"rgba(16, 185, 129, 0.25)",border:r?"1px solid rgba(16, 185, 129, 0.3)":"1px solid rgba(16, 185, 129, 0.4)",boxShadow:r?"0 6px 24px rgba(16, 185, 129, 0.15), 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(16, 185, 129, 0.25)":"0 6px 24px rgba(16, 185, 129, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(16, 185, 129, 0.4)"},...D&&E==="transparent"&&{background:r?"rgba(16, 185, 129, 0.12)":"rgba(16, 185, 129, 0.08)"}},"&:active":{...h.buttonActive},"&:focus":{outline:`2px solid ${r?"rgba(16, 185, 129, 0.8)":"rgba(16, 185, 129, 0.6)"}`,outlineOffset:"2px"}},title:"MCP 工具",children:[I!=="text"&&e.jsx(ut,{size:16,color:D?r?"rgba(16, 185, 129, 0.9)":"rgba(16, 185, 129, 0.8)":r?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.75)"}),I!=="icon"&&e.jsx(K,{variant:"body2",sx:{fontWeight:600,fontSize:"13px",color:D?r?"rgba(16, 185, 129, 0.95)":"rgba(16, 185, 129, 0.9)":r?"rgba(255, 255, 255, 0.9)":"rgba(0, 0, 0, 0.8)",textShadow:r?"0 1px 2px rgba(0, 0, 0, 0.3)":"0 1px 2px rgba(255, 255, 255, 0.8)",letterSpacing:"0.01em",ml:I==="both"?.5:0},children:"工具"})]}),e.jsxs(ht,{open:i,onClose:P,maxWidth:"sm",fullWidth:!0,slotProps:{paper:{sx:{borderRadius:2,maxHeight:"80vh"}}},children:[e.jsx(xt,{sx:{pb:1},children:e.jsxs(C,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ut,{size:20,color:"#10b981"}),e.jsx(K,{variant:"h6",fontWeight:600,children:"MCP 工具服务器"}),D&&e.jsx(tt,{label:`${F.length} 个运行中`,size:"small",color:"success",variant:"outlined"})]}),t&&e.jsx(Gt,{checked:n,onChange:c=>f(c.target.checked)})]})}),e.jsxs(gt,{sx:{p:0},children:[y&&e.jsx(C,{sx:{p:2},children:e.jsx(Tt,{severity:"error",onClose:()=>g(null),children:y})}),m?e.jsx(et,{sx:{py:0},children:[1,2,3].map(c=>e.jsxs(qe,{sx:{py:2},children:[e.jsx(ye,{children:e.jsx(Lt,{variant:"circular",width:32,height:32})}),e.jsx(we,{primary:e.jsx(Lt,{variant:"text",width:"60%",height:24}),secondary:e.jsxs(C,{sx:{display:"flex",gap:1,mt:.5},children:[e.jsx(Lt,{variant:"rectangular",width:60,height:20,sx:{borderRadius:"10px"}}),e.jsx(Lt,{variant:"rectangular",width:50,height:20,sx:{borderRadius:"10px"}})]})}),e.jsx(C,{sx:{ml:"auto"},children:e.jsx(Lt,{variant:"rectangular",width:40,height:24,sx:{borderRadius:"12px"}})})]},c))}):l.length===0?e.jsxs(C,{sx:{p:3,textAlign:"center"},children:[e.jsx(ut,{size:48,color:"rgba(0,0,0,0.4)",style:{marginBottom:16}}),e.jsx(K,{variant:"h6",gutterBottom:!0,children:"还没有配置 MCP 服务器"}),e.jsx(K,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"MCP 服务器可以为 AI 提供额外的工具和功能"}),e.jsx(Ie,{variant:"contained",startIcon:e.jsx(st,{size:16}),onClick:u,sx:{bgcolor:"#10b981","&:hover":{bgcolor:"#059669"}},children:"添加服务器"})]}):e.jsxs(e.Fragment,{children:[e.jsx(et,{sx:{py:0},children:l.map((c,k)=>e.jsxs(Qs.Fragment,{children:[e.jsxs(qe,{sx:{py:2},secondaryAction:e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:1},children:[b[c.id]&&e.jsx(dt,{size:16}),e.jsx(Gt,{checked:c.isActive,onChange:w=>W(c.id,w.target.checked),disabled:b[c.id]||!1})]}),children:[e.jsx(ye,{children:e.jsx(fs,{sx:{bgcolor:Fe(B(c.type),.1),color:B(c.type),width:32,height:32},children:$(c.type)})}),e.jsx(we,{primary:e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{variant:"subtitle2",fontWeight:600,children:c.name}),c.isActive&&e.jsx(tt,{label:"运行中",size:"small",color:"success",variant:"outlined"})]}),secondary:e.jsxs(C,{component:"div",children:[c.description&&e.jsx(K,{variant:"body2",color:"text.secondary",component:"span",sx:{display:"block"},children:c.description}),c.baseUrl&&e.jsx(K,{variant:"caption",color:"text.secondary",component:"span",sx:{display:"block"},children:c.baseUrl})]}),slotProps:{secondary:{component:"div"}}})]}),k<l.length-1&&e.jsx(Ye,{})]},c.id))}),e.jsx(C,{sx:{p:2,borderTop:"1px solid",borderColor:"divider"},children:e.jsx(Ie,{fullWidth:!0,variant:"outlined",startIcon:e.jsx(Pt,{size:16}),onClick:u,size:"small",children:"管理 MCP 服务器"})})]})]})]})]})},Mn=[],Kr=({open:n,onClose:t,onProviderSelect:o})=>{const a=or(),r=nr(),i=se(I=>I.webSearch),d=i?.providers||Mn,l=i?.provider||"bing-free",x=i?.enabled||!1;if(!d||d.length===0)return e.jsxs(ht,{open:n,onClose:t,maxWidth:"sm",fullWidth:!0,children:[e.jsx(xt,{children:"加载中..."}),e.jsx(gt,{children:e.jsx(K,{children:"正在加载搜索提供商..."})})]});const b=I=>{a(Sr(I)),o?.(I),t()},p=()=>{a(Sr("custom")),o?.(""),t()},y=()=>{t(),r("/settings/web-search")},g=()=>{a(Xs())},m=I=>{switch(I){case"bing-free":return"🆓";case"tavily":return"🔍";case"bing":return"🔎";case"searxng":return"🌐";case"exa":return"🎯";case"bocha":return"🤖";case"firecrawl":return"";default:return"🔍"}},v=I=>I.id==="bing-free"||I.id==="bing"?{available:!0,label:"免费可用"}:I.apiKey&&I.apiKey.trim()?{available:!0,label:"API密钥"}:I.apiHost&&I.apiHost.trim()?{available:!0,label:"自托管"}:"basicAuthUsername"in I&&"basicAuthPassword"in I&&I.basicAuthUsername&&I.basicAuthPassword?{available:!0,label:"基础认证"}:{available:!1,label:"需要配置"},S=d;return e.jsxs(ht,{open:n,onClose:t,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:3,maxHeight:"80vh"}},children:[e.jsxs(xt,{sx:{display:"flex",alignItems:"center",gap:1,pb:1},children:[e.jsx(Fr,{color:"#1976d2"}),e.jsx(K,{variant:"h6",component:"span",children:"选择搜索提供商"}),e.jsx(C,{sx:{flexGrow:1}}),e.jsx(ne,{onClick:g,size:"small",title:"刷新提供商列表",children:e.jsx(Zs,{})}),e.jsx(ne,{onClick:t,size:"small",children:e.jsx(Ve,{})})]}),e.jsxs(gt,{sx:{px:0,pb:2},children:[e.jsx(et,{dense:!0,children:e.jsx(qe,{disablePadding:!0,children:e.jsxs(Yt,{onClick:p,selected:!x||!l,sx:{mx:2,borderRadius:2,mb:1},children:[e.jsx(ye,{children:e.jsx(C,{sx:{width:32,height:32,borderRadius:1,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:Fe("#666",.1),fontSize:"16px"},children:"🚫"})}),e.jsx(we,{primary:"不使用网络搜索",secondary:"禁用网络搜索功能"}),(!x||!l)&&e.jsx(kr,{children:e.jsx(rs,{color:"#1976d2"})})]})})}),e.jsx(Ye,{sx:{my:1}}),S.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(K,{variant:"subtitle2",color:"text.secondary",sx:{px:2,py:1},children:"搜索提供商"}),e.jsx(et,{dense:!0,children:S.map(I=>{const E=v(I),F=x&&l===I.id;return e.jsx(qe,{disablePadding:!0,children:e.jsxs(Yt,{onClick:()=>b(I.id),selected:F,sx:{mx:2,borderRadius:2,mb:.5},children:[e.jsx(ye,{children:e.jsx(C,{sx:{width:32,height:32,borderRadius:1,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:E.available?Fe("#3b82f6",.1):Fe("#666",.1),fontSize:"16px",opacity:E.available?1:.6},children:m(I.id)})}),e.jsx(we,{primary:I.name,secondary:E.available?`✓ ${E.label}`:`⚠️ ${E.label}`}),F&&e.jsx(kr,{children:e.jsx(rs,{color:"#1976d2"})})]})},I.id)})})]}),e.jsx(Ye,{sx:{my:1}}),e.jsx(et,{dense:!0,children:e.jsx(qe,{disablePadding:!0,children:e.jsxs(Yt,{onClick:y,sx:{mx:2,borderRadius:2},children:[e.jsx(ye,{children:e.jsx(Pt,{color:"#757575"})}),e.jsx(we,{primary:"搜索设置",secondary:"配置搜索提供商和选项"})]})})})]})]})},Nr=({open:n,onClose:t,onSelect:o,searchQuery:a=""})=>{const[r,i]=s.useState([]),[d,l]=s.useState(!1),[x,b]=s.useState(!1),[p,y]=s.useState(""),[g,m]=s.useState(a),[v,S]=s.useState([]),[I,E]=s.useState(""),F=s.useRef(!0),h=s.useRef(null);s.useEffect(()=>()=>{F.current=!1,h.current&&clearTimeout(h.current)},[]);const A=s.useCallback(async()=>{try{l(!0),E("");const c=await rt.knowledge_bases.toArray(),k=await Promise.all(c.map(async w=>{const T=await rt.knowledge_documents.where("knowledgeBaseId").equals(w.id).toArray();return{id:w.id,name:w.name,description:w.description,documentCount:T.length,createdAt:w.createdAt}}));F.current&&i(k)}catch(c){console.error("加载知识库失败:",c),F.current&&E("加载知识库失败，请重试")}finally{F.current&&l(!1)}},[]),z=s.useCallback(async()=>{if(!p||!g.trim()){S([]);return}try{b(!0),E("");const c=r.find(T=>T.id===p),k=Math.min(c?.documentCount||5,10),w=await Js.getInstance().searchKnowledge(p,g.trim(),k);F.current&&S(w||[])}catch(c){console.error("搜索知识库失败:",c),F.current&&(S([]),E("搜索失败，请重试"))}finally{F.current&&b(!1)}},[p,g,r]),P=s.useCallback(()=>{h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{z()},300)},[z]),W=s.useCallback(()=>{const c=r.find(k=>k.id===p);c&&(o(c,v),u())},[p,r,v,o]),u=s.useCallback(()=>{y(""),m(""),S([]),E(""),h.current&&clearTimeout(h.current),t()},[t]),f=s.useCallback(c=>{y(c),S([]),E(""),g.trim()&&P()},[g,P]),M=s.useCallback(c=>{o(c,[]),u()},[o,u]);s.useEffect(()=>{n&&(F.current=!0,A(),m(a))},[n,a,A]),s.useEffect(()=>{p&&g.trim()?P():(S([]),h.current&&clearTimeout(h.current))},[g,p,P]);const $=s.useCallback(c=>{m(c.target.value),E("")},[]),B=s.useMemo(()=>p&&g.trim(),[p,g]),D=s.useMemo(()=>d?"loading":I?"error":r.length===0?"empty":"loaded",[d,I,r.length]);return e.jsxs(ht,{open:n,onClose:u,maxWidth:"sm",fullWidth:!0,slotProps:{paper:{sx:{borderRadius:2,maxHeight:"80vh"}}},children:[e.jsxs(xt,{sx:{pb:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(C,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(wt,{color:"primary"}),e.jsx(K,{variant:"h6",children:"选择知识库"})]}),e.jsx(ne,{onClick:u,edge:"end",children:e.jsx(Ve,{})})]}),e.jsxs(gt,{sx:{px:3,py:2},children:[I&&e.jsx(Tt,{severity:"error",sx:{mb:2},children:I}),e.jsx(Ot,{fullWidth:!0,placeholder:"输入搜索内容...",value:g,onChange:$,slotProps:{input:{startAdornment:e.jsx(ns,{position:"start",children:e.jsx(Br,{})}),endAdornment:x&&e.jsx(ns,{position:"end",children:e.jsx(dt,{size:20})})}},sx:{mb:2}}),e.jsxs(K,{variant:"subtitle2",gutterBottom:!0,children:["选择知识库 (",r.length,")"]}),e.jsx(K,{variant:"caption",color:"text.secondary",sx:{mb:2,display:"block"},children:"单击选择，双击直接使用知识库"}),D==="loading"?e.jsx(C,{display:"flex",justifyContent:"center",py:3,children:e.jsx(dt,{})}):D==="empty"?e.jsx(Tt,{severity:"info",sx:{mb:2},children:"暂无知识库，请先创建知识库"}):e.jsx(et,{sx:{maxHeight:200,overflow:"auto",mb:2},children:r.map(c=>e.jsx(qe,{disablePadding:!0,children:e.jsxs(Yt,{selected:p===c.id,onClick:()=>f(c.id),onDoubleClick:()=>M(c),sx:{borderRadius:1,mb:.5,"&.Mui-selected":{backgroundColor:"primary.main",color:"primary.contrastText","&:hover":{backgroundColor:"primary.dark"}}},children:[e.jsx(ye,{children:e.jsx(wt,{color:p===c.id?"inherit":"primary"})}),e.jsx(we,{primary:c.name,secondary:e.jsxs("span",{style:{display:"block"},children:[c.description&&e.jsx("span",{style:{display:"block",fontSize:"0.75rem",lineHeight:1.2},children:c.description}),e.jsx("span",{style:{display:"inline-block",marginTop:"4px"},children:e.jsx(tt,{size:"small",label:`${c.documentCount} 个文档`,component:"span"})})]})})]})},c.id))}),B&&e.jsxs(e.Fragment,{children:[e.jsx(Ye,{sx:{my:2}}),e.jsxs(K,{variant:"subtitle2",gutterBottom:!0,children:["搜索结果 (",v.length,")"]}),x?e.jsx(C,{display:"flex",justifyContent:"center",py:2,children:e.jsx(dt,{size:24})}):v.length===0?e.jsx(Tt,{severity:"warning",children:"未找到相关内容，请尝试其他关键词"}):e.jsx(et,{sx:{maxHeight:150,overflow:"auto"},children:v.map((c,k)=>e.jsxs(qe,{sx:{py:1},children:[e.jsx(ye,{children:e.jsx(Rt,{size:16})}),e.jsx(we,{primary:e.jsx(K,{variant:"body2",noWrap:!0,children:c.title||`文档 ${k+1}`}),secondary:e.jsxs(K,{variant:"caption",color:"textSecondary",children:["相似度: ",(c.similarity*100).toFixed(1),"%"]})})]},`${c.documentId}-${k}`))})]})]}),e.jsxs(sr,{sx:{px:3,pb:2},children:[e.jsx(Ie,{onClick:u,startIcon:e.jsx(Ve,{}),children:"取消"}),e.jsx(Ie,{onClick:W,variant:"contained",disabled:!p,startIcon:e.jsx(wt,{}),children:"使用知识库"})]})]})},Ln=()=>{const n=s.useCallback(()=>{try{const i=window.sessionStorage.getItem("selectedKnowledgeBase");return i?JSON.parse(i):null}catch(i){return console.error("获取知识库上下文失败:",i),null}},[]),t=s.useCallback(()=>{try{window.sessionStorage.removeItem("selectedKnowledgeBase")}catch(i){console.error("清除知识库上下文失败:",i)}},[]),o=s.useCallback(async(i,d=!0)=>{const l=n();if(!l||!l.isSelected||!l.searchOnSend)return i;try{console.log("[useKnowledgeContext] 开始搜索知识库内容...");const{MobileKnowledgeService:x}=await rr(async()=>{const{MobileKnowledgeService:g}=await import("./index-5OteHtpV.js").then(m=>m.hC);return{MobileKnowledgeService:g}},__vite__mapDeps([0,1])),p=await x.getInstance().search({knowledgeBaseId:l.knowledgeBase.id,query:i.trim(),threshold:.6,limit:l.knowledgeBase.documentCount||5});if(console.log(`[useKnowledgeContext] 搜索到 ${p.length} 个相关内容`),p.length===0)return console.log("[useKnowledgeContext] 未找到相关内容"),i;const y=p.map((g,m)=>({id:m+1,content:g.content,type:"file",similarity:g.similarity,knowledgeBaseId:l.knowledgeBase.id,knowledgeBaseName:l.knowledgeBase.name,sourceUrl:`knowledge://${l.knowledgeBase.id}/${g.documentId||m}`}));if(d){const g=`\`\`\`json
${JSON.stringify(y,null,2)}
\`\`\``,m=Gs.replace("{question}",i).replace("{references}",g);return console.log("[useKnowledgeContext] 应用REFERENCE_PROMPT格式"),m}else{let g=`

--- 知识库参考内容 ---
`;return g+=`
[${l.knowledgeBase.name}]:
`,y.forEach((m,v)=>{const S=m.similarity?` (相似度: ${(m.similarity*100).toFixed(1)}%)`:"";g+=`${v+1}. ${m.content}${S}
`}),g+=`
--- 请基于以上知识库内容回答问题 ---
`,console.log("[useKnowledgeContext] 应用简单文本格式"),i+g}}catch(x){return console.error("搜索知识库失败:",x),i}},[n]),a=s.useCallback(()=>{const i=n();return!!(i&&i.isSelected&&i.searchOnSend)},[n]),r=s.useCallback(()=>{const i=n();return!i||!i.isSelected?null:`${i.knowledgeBase?.name||"未知知识库"} (将在发送时搜索)`},[n]);return{getStoredKnowledgeContext:n,clearStoredKnowledgeContext:t,applyKnowledgeContext:o,hasKnowledgeContext:a,getKnowledgeContextSummary:r}},Wn=({toolsEnabled:n,webSearchActive:t,imageGenerationMode:o,onNewTopic:a,onClearTopic:r,handleWebSearchClick:i,toggleImageGenerationMode:d})=>[{icon:e.jsx(ut,{size:20}),label:"工具",onClick:()=>{},color:n?"#4CAF50":"#9E9E9E",active:n},{icon:e.jsx(Br,{size:20}),label:"网络搜索",onClick:i,color:t?"#3b82f6":"#607D8B",active:t},{icon:e.jsx(pt,{size:20}),label:"生成图片",onClick:d||(()=>{}),color:o?"#9C27B0":"#FF9800",active:o},{icon:e.jsx(st,{size:20}),label:"新建话题",onClick:a||(()=>{}),color:"#2196F3"},{icon:e.jsx(_t,{size:20}),label:"清空内容",onClick:r||(()=>{}),color:"#f44336"}],On=({toolsEnabled:n,uploadingMedia:t,toggleToolsEnabled:o,handleImageUpload:a,handleFileUpload:r,handleKnowledgeClick:i})=>[{icon:e.jsx($r,{size:20}),label:"拍照上传",onClick:()=>a("camera"),color:"#FF9800",disabled:t},{icon:e.jsx(pt,{size:20}),label:"图片上传",onClick:()=>a("photos"),color:"#2196F3",disabled:t},{icon:e.jsx(js,{size:20}),label:"文件上传",onClick:r,color:"#9C27B0",disabled:t},{icon:e.jsx(wt,{size:20}),label:"知识库",onClick:i||(()=>{}),color:"#059669"},{icon:e.jsx(ut,{size:20}),label:"高级工具",onClick:o||(()=>{}),color:n?"#4CAF50":"#9E9E9E",active:n}],wo=({onSendMessage:n,onSendMultiModelMessage:t,onStartDebate:o,onStopDebate:a,isLoading:r=!1,allowConsecutiveMessages:i=!0,imageGenerationMode:d=!1,onSendImagePrompt:l,webSearchActive:x=!1,onStopResponse:b,isStreaming:p=!1,isDebating:y=!1,toolsEnabled:g=!0,availableModels:m=[],onClearTopic:v,onNewTopic:S,toggleImageGenerationMode:I,toggleWebSearch:E,toggleToolsEnabled:F})=>{const[h,A]=s.useState(!1),[z,P]=s.useState(!1),[W,u]=s.useState(!1),[f,M]=s.useState(!1),[$,B]=s.useState(!1),[D,c]=s.useState(Math.floor(window.innerHeight*.7)),[k,w]=s.useState(40),[T,R]=s.useState(!1),[U,N]=s.useState(!1),[Y,J]=s.useState(!1),[ee,me]=s.useState(!1),[H,le]=s.useState(!1),[de,te]=s.useState([]),[V,oe]=s.useState([]),[ie,Q]=s.useState([]),[L,X]=s.useState(!1),Z=se(j=>j.messages.currentTopicId),[pe,O]=s.useState(null),{styles:ue,isDarkMode:G,inputBoxStyle:fe}=cr(),{hasKnowledgeContext:ke,getKnowledgeContextSummary:vt,clearStoredKnowledgeContext:Et}=Ln(),Ft=se(j=>j.settings.showAIDebateButton??!0),At=se(j=>j.settings.showQuickPhraseButton??!0),Re=se(j=>j.assistants.currentAssistant),be=se(j=>j.settings),{handleImageUpload:Bt,handleFileUpload:mt}=Cs({currentTopicState:pe,setUploadingMedia:X}),{message:ge,setMessage:Qe,textareaRef:je,canSendMessage:nt,handleSubmit:Ct,handleKeyDown:kt,handleChange:St,showCharCount:It,handleCompositionStart:Dt,handleCompositionEnd:Ze}=Mr({onSendMessage:n,onSendImagePrompt:l,isLoading:r,allowConsecutiveMessages:i,imageGenerationMode:d,toolsEnabled:g,images:V,files:ie,setImages:oe,setFiles:Q,enableTextareaResize:!0,enableCompositionHandling:!0,enableCharacterCount:!0}),{isListening:He,error:ae,startRecognition:Ce,stopRecognition:ce}=ir(),{shouldHandleFocus:Pe}=Ur();s.useEffect(()=>{},[ae]),s.useEffect(()=>Se.subscribe(te),[]),s.useEffect(()=>{(async()=>{if(Z)try{const _=await en.getTopic(Z);_&&O(_)}catch(_){console.error("加载话题信息失败:",_)}})()},[Z]),s.useEffect(()=>{const j=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&navigator.maxTouchPoints>1;J(j)},[]),s.useEffect(()=>{const j=()=>{c(Math.floor(window.innerHeight*.7))};return window.addEventListener("resize",j),()=>window.removeEventListener("resize",j)},[]);const Me=()=>{x?E?.():P(!0)},Le=j=>{j&&E&&E()},Xe=()=>{u(!0)},zt=(j,_)=>{console.log("选择了知识库:",j,"搜索结果:",_);const re={knowledgeBase:{id:j.id,name:j.name},isSelected:!0,searchOnSend:!0};console.log("[知识库选择] 准备保存到sessionStorage:",re),window.sessionStorage.setItem("selectedKnowledgeBase",JSON.stringify(re));const ve=window.sessionStorage.getItem("selectedKnowledgeBase");console.log("[知识库选择] sessionStorage保存验证:",ve),console.log(`[知识库选择] 已选择知识库: ${j.name}，将在发送消息时自动搜索相关内容`),u(!1)};s.useEffect(()=>{if(je.current){if(!U&&!ge.trim()){je.current.style.height="40px",w(56);return}je.current.style.height="auto";const j=je.current.scrollHeight,_=24,re=$?D:T?200:120;let ve=Math.max(_,Math.min(j,re));j>re&&(ve=re),$||(je.current.style.height=`${ve}px`);const Ae=$?D+16:ve+16;w(Ae)}},[ge,T,U,$,D]);const ft=()=>{console.log("[CompactChatInput] 输入框获得焦点, shouldHandleFocus:",Pe()),N(!0),Y&&je.current&&Pe()&&setTimeout(()=>{if(!je.current)return;je.current.scrollIntoView({behavior:"smooth",block:"center"}),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});const j=window.innerHeight,_=j*.4;if(je.current){const ve=je.current.getBoundingClientRect().bottom;if(ve>j-_){const Ae=ve-(j-_)+20;window.scrollBy({top:Ae,behavior:"smooth"})}}},400)},bt=()=>{!ge.trim()&&!r&&!p&&N(!1)},Ht=()=>{N(!0)},ot=s.useCallback(()=>{if($)M(!0);else{const j=ge.length,re=Math.floor(280/14),ve=(ge.match(/\n/g)||[]).length,Ae=Math.ceil(j/re)+ve;M(Ae>4)}},[$,ge]);s.useEffect(()=>{ot()},[ge,ot]),s.useEffect(()=>{setTimeout(ot,100)},[$,ot]);const dr=s.useCallback(j=>{St(j),j.target.value.trim()&&N(!0),setTimeout(ot,100)},[St,ot]),Vr=j=>{kt(j),j.key==="Enter"&&(j.ctrlKey||j.metaKey)&&(j.preventDefault(),R(!T))},ur=async(j="photos")=>{try{const _=await Bt(j);oe(re=>[...re,..._])}catch(_){console.error("图片上传失败:",_),alert("图片上传失败，请重试")}},q=async()=>{try{const j=await mt();Q(_=>[..._,...j])}catch(j){console.error("文件上传失败:",j),alert("文件上传失败，请重试")}},Ee=j=>{oe(_=>_.filter((re,ve)=>ve!==j))},We=j=>{Q(_=>_.filter((re,ve)=>ve!==j))},Oe=()=>{me(!ee),ee&&He&&ce()},he=j=>{if(j.trim()){const _=[...V,...ie.filter(re=>re.mimeType.startsWith("image/"))].map(re=>({type:"image_url",image_url:{url:re.base64Data||re.url}}));n(j.trim(),_.length>0?_:void 0,g,ie),oe([]),Q([]),X(!1),me(!1)}},xe=j=>{if(t&&ge.trim()){const _=[...V,...ie.filter(re=>re.mimeType.startsWith("image/"))].map(re=>({type:"image_url",image_url:{url:re.base64Data||re.url}}));t(ge.trim(),j,_.length>0?_:void 0,g,ie),Qe(""),oe([]),Q([]),X(!1),le(!1)}},_e=j=>{Qe(_=>_+j),N(!0)},Je=async j=>{const _=j.clipboardData;if(!_)return;const re=be.pasteLongTextAsFile??!1,ve=be.pasteLongTextThreshold??1500,Ae=_.getData("text");if(Ae&&re&&Ae.length>ve){j.preventDefault();try{X(!0);const{MobileFileStorageService:Ge}=await rr(async()=>{const{MobileFileStorageService:gr}=await import("./index-5OteHtpV.js").then(Es=>Es.hD);return{MobileFileStorageService:gr}},__vite__mapDeps([0,1])),Ke=Ge.getInstance(),Mt=`粘贴的文本_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.txt`,Kt=new TextEncoder().encode(Ae),hr=btoa(String.fromCharCode(...Kt)),xr={name:Mt,size:new Blob([Ae],{type:"text/plain"}).size,mimeType:"text/plain",base64Data:`data:text/plain;base64,${hr}`},it=await Ke.uploadFile(xr),Ps={name:it.origin_name,mimeType:it.mimeType||"text/plain",extension:it.ext||".txt",size:it.size,base64Data:it.base64Data,url:it.path||"",fileId:it.id,fileRecord:it};Q(gr=>[...gr,Ps]),Se.show({message:`长文本已转换为文件: ${Mt}`,type:"success",duration:3e3})}catch(Ge){console.error("长文本转文件失败:",Ge),Se.show({message:"长文本转文件失败，请重试",type:"error",duration:3e3})}finally{X(!1)}return}const pr=Array.from(_.items).filter(Ge=>Ge.type.startsWith("image/"));if(pr.length!==0){j.preventDefault();try{X(!0);for(const Ge of pr){const Ke=Ge.getAsFile();if(Ke){const Mt=new FileReader;Mt.onload=qr=>{const Kt=qr.target?.result,hr={id:`${Date.now()}-${Math.random()}`,url:Kt,base64Data:Kt,mimeType:Ke.type,name:`粘贴的图片_${Date.now()}.${Ke.type&&typeof Ke.type=="string"&&Ke.type.includes("/")?Ke.type.split("/")[1]:"png"}`,size:Ke.size};oe(xr=>[...xr,hr])},Mt.readAsDataURL(Ke)}}Se.show({message:`成功粘贴 ${pr.length} 张图片`,type:"success",duration:3e3})}catch(Ge){console.error("粘贴图片处理失败:",Ge),Se.show({message:"粘贴图片失败，请重试",type:"error",duration:3e3})}finally{X(!1)}}},at=Wn({toolsEnabled:g,webSearchActive:x,imageGenerationMode:d,onNewTopic:S,onClearTopic:v,handleWebSearchClick:Me,toggleImageGenerationMode:I}),$t=On({toolsEnabled:g,uploadingMedia:L,toggleToolsEnabled:F,handleImageUpload:ur,handleFileUpload:q,handleKnowledgeClick:Xe});return e.jsxs(C,{sx:{width:"100%",maxWidth:{xs:"100%",sm:"800px"},margin:{xs:"0",sm:"0 auto"},paddingLeft:{xs:"8px",sm:"0"},paddingRight:{xs:"8px",sm:"0"},"& textarea::-webkit-scrollbar":{width:"6px"},"& textarea::-webkit-scrollbar-track":{background:"transparent"},"& textarea::-webkit-scrollbar-thumb":{background:G?"#555":"#ccc",borderRadius:"3px"},"& textarea::-webkit-scrollbar-thumb:hover":{background:G?"#666":"#999"},...Y?{position:"relative",zIndex:1e3,marginBottom:"34px",paddingBottom:"10px"}:{}},children:[ke()&&e.jsx(C,{sx:{mb:1,px:1},children:e.jsx(tt,{label:`📚 ${vt()}`,onDelete:()=>Et(),size:"small",color:"primary",variant:"outlined",sx:{fontSize:"0.75rem",height:24,"& .MuiChip-label":{px:1}}})}),ee?e.jsx(Hr,{isDarkMode:G,onClose:()=>me(!1),onSendMessage:he,onInsertText:j=>{Qe(_=>_+j),me(!1)},startRecognition:Ce}):e.jsxs(C,{sx:{display:"flex",alignItems:"flex-end",background:G?"#2A2A2A":"#FFFFFF",border:ue.border,borderRadius:U||h||ge.trim().length>0?`${ue.borderRadius} ${ue.borderRadius} 0 0`:ue.borderRadius,boxShadow:ue.boxShadow,padding:"8px 12px",marginBottom:"0",borderBottom:U||h||ge.trim().length>0?"none":ue.border,minHeight:"40px",height:`${k}px`,transition:"all 0.2s ease",cursor:!U&&!ge.trim()?"pointer":"text",position:"relative","&:hover":!U&&!ge.trim()?{borderColor:G?"#555":"#ddd",boxShadow:`0 2px 8px ${G?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}`}:{}},onClick:U?void 0:Ht,children:[f&&e.jsx(C,{sx:{position:"absolute",top:"4px",right:"4px",zIndex:10},children:e.jsx(ne,{onClick:()=>B(!$),size:"small",sx:{color:$?"#2196F3":G?"#B0B0B0":"#555",padding:"2px",width:"20px",height:"20px",minWidth:"20px",backgroundColor:G?"rgba(42, 42, 42, 0.9)":"rgba(255, 255, 255, 0.9)",backdropFilter:"blur(4px)",borderRadius:"6px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transition:"all 0.2s ease"},children:$?e.jsx(yt,{size:14}):e.jsx(Ut,{size:14})})}),e.jsxs(C,{sx:{flex:1,marginRight:"8px","& textarea::placeholder":{userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",pointerEvents:"none"}},children:[e.jsx("textarea",{ref:je,className:"hide-scrollbar",style:{width:"100%",border:"none",outline:"none",backgroundColor:"transparent",resize:"none",fontSize:"14px",lineHeight:"1.4",fontFamily:"inherit",color:G?"#ffffff":"#000000",minHeight:$?`${D}px`:U?"24px":"40px",height:$?`${D}px`:"auto",maxHeight:$?`${D}px`:U?"120px":"40px",overflow:$||U?"auto":"hidden",padding:"0",transition:"all 0.3s ease"},placeholder:U?d?"输入图像生成提示词... (Ctrl+Enter 全展开)":x?"输入网络搜索内容... (Ctrl+Enter 全展开)":"和ai助手说点什么... (Ctrl+Enter 全展开)":"和ai助手说点什么...",value:ge,onChange:dr,onKeyDown:Vr,onCompositionStart:Dt,onCompositionEnd:Ze,onFocus:ft,onBlur:bt,onClick:Ht,onPaste:Je,disabled:r&&!i}),It&&e.jsxs("div",{style:{position:"absolute",bottom:"-20px",right:"0",fontSize:"12px",color:ge.length>1e3?"#f44336":G?"#888":"#666",opacity:.8,transition:"all 0.2s ease"},children:[ge.length,ge.length>1e3?" (过长)":""]})]}),e.jsxs(C,{sx:{display:"flex",gap:1,alignItems:"flex-end",paddingBottom:"4px"},children:[e.jsx(Dn,{isVoiceMode:ee,isDisabled:L||r&&!i,onToggleVoiceMode:Oe,size:"small",color:"default",tooltip:ee?"退出语音输入模式":"切换到语音输入模式"}),e.jsx(ne,{onClick:p&&b?b:Ct,disabled:!p&&(!nt()||r&&!i),sx:{backgroundColor:p?"#ff4d4f":!nt()||r&&!i?"rgba(0,0,0,0.1)":d?"#9C27B0":x?"#3b82f6":"#4CAF50",color:"white",width:32,height:32,"&:hover":{backgroundColor:p?"#ff7875":!nt()||r&&!i?"rgba(0,0,0,0.1)":d?"#AB47BC":x?"#1976d2":"#66BB6A"},"&:disabled":{backgroundColor:"rgba(0,0,0,0.1)",color:"rgba(0,0,0,0.3)"}},children:p?e.jsx(ar,{size:18}):e.jsx(er,{size:18})})]})]}),(V.length>0||ie.length>0)&&e.jsxs(C,{sx:{padding:"8px 12px",background:G?"#2A2A2A":"#FFFFFF",border:ue.border,borderTop:"none",borderBottom:"none",maxHeight:"120px",overflowY:"auto"},children:[V.length>0&&e.jsxs(C,{sx:{mb:1},children:[e.jsxs(K,{variant:"caption",sx:{color:"text.secondary",mb:1,display:"block"},children:["已选择 ",V.length," 张图片"]}),e.jsx(C,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:V.map((j,_)=>{const re=`image-${_}-${j.name||"unnamed"}-${j.size||Date.now()}`,ve=j.base64Data||(j.url?`${j.url}?t=${Date.now()}`:"");return e.jsxs(C,{sx:{position:"relative",width:60,height:60,borderRadius:1,overflow:"hidden",border:"1px solid",borderColor:"divider"},children:[e.jsx("img",{src:ve,alt:`预览 ${_+1}`,style:{width:"100%",height:"100%",objectFit:"cover"},onError:Ae=>{console.warn("图片加载失败:",j),Ae.currentTarget.style.display="none"}}),e.jsx(ne,{size:"small",onClick:()=>Ee(_),sx:{position:"absolute",top:-8,right:-8,backgroundColor:"error.main",color:"white",width:20,height:20,"&:hover":{backgroundColor:"error.dark"}},children:e.jsx(Ve,{size:12})})]},re)})})]}),ie.length>0&&e.jsxs(C,{sx:{mb:1},children:[e.jsxs(K,{variant:"caption",sx:{color:"text.secondary",mb:1,display:"block"},children:["已选择 ",ie.length," 个文件"]}),e.jsx(C,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:ie.map((j,_)=>{const re=`file-${_}-${j.name}-${j.size||Date.now()}`;return e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:1,p:1,bgcolor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsx(js,{size:16,style:{color:"text.secondary"}}),e.jsx(K,{variant:"caption",sx:{maxWidth:100,overflow:"hidden",textOverflow:"ellipsis"},children:j.name}),e.jsx(ne,{size:"small",onClick:()=>We(_),sx:{p:.5},children:e.jsx(Ve,{size:12})})]},re)})})]})]}),e.jsx(Xt,{in:U||h||ge.trim().length>0,children:e.jsxs(C,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 12px",background:G?"#2A2A2A":"#FFFFFF",border:ue.border,borderTop:"none",borderRadius:h?"none":`0 0 ${ue.borderRadius} ${ue.borderRadius}`,boxShadow:ue.boxShadow,minHeight:"40px",transition:"all 0.2s ease"},children:[at.map((j,_)=>j.label==="工具"?e.jsx(C,{sx:{display:"flex",alignItems:"center"},children:e.jsx(Ss,{})},_):e.jsx(ne,{onClick:j.onClick,size:"small",sx:{color:j.active?j.color:G?"#B0B0B0":"#555",backgroundColor:j.active?`${j.color}15`:"transparent",border:j.active?`1px solid ${j.color}30`:"1px solid transparent",width:34,height:34,borderRadius:"8px",transition:"all 0.2s ease","&:hover":{backgroundColor:`${j.color}20`,borderColor:`${j.color}50`,color:j.color,transform:"translateY(-1px)",boxShadow:`0 2px 8px ${j.color}20`}},children:j.icon},_)),Ft&&e.jsx(Or,{onStartDebate:o,onStopDebate:a,isDebating:y,disabled:L||r&&!i,question:ge}),At&&e.jsx(_r,{onInsertPhrase:_e,assistant:Re,disabled:L||r&&!i,size:"small"}),e.jsx(ne,{onClick:()=>A(!h),size:"small",sx:{color:h?"#2196F3":G?"#B0B0B0":"#555",backgroundColor:h?"#2196F315":"transparent",border:h?"1px solid #2196F330":"1px solid transparent",width:30,height:30,borderRadius:"8px",transition:"all 0.2s ease","&:hover":{backgroundColor:"#2196F320",borderColor:"#2196F350",color:"#2196F3",transform:"translateY(-1px)",boxShadow:"0 2px 8px #2196F320"}},children:h?e.jsx(Ve,{size:20}):e.jsx(st,{size:20})})]})}),e.jsx(Xt,{in:h,children:e.jsx(C,{sx:{marginTop:"0",padding:"8px 12px",background:G?"#2A2A2A":"#FFFFFF",border:ue.border,borderTop:"none",borderRadius:`0 0 ${ue.borderRadius} ${ue.borderRadius}`,boxShadow:ue.boxShadow,backdropFilter:fe==="modern"?"blur(10px)":"none",WebkitBackdropFilter:fe==="modern"?"blur(10px)":"none"},children:e.jsxs(C,{sx:{display:"flex",alignItems:"center",justifyContent:"flex-start",gap:2,flexWrap:"wrap"},children:[$t.map((j,_)=>e.jsxs(C,{onClick:j.disabled?void 0:j.onClick,sx:{display:"flex",alignItems:"center",gap:1,padding:"6px 12px",borderRadius:"12px",cursor:j.disabled?"not-allowed":"pointer",opacity:j.disabled?.5:1,backgroundColor:j.active?`${j.color}15`:G?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",border:j.active?`1px solid ${j.color}40`:`1px solid ${G?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}`,transition:"all 0.2s ease",minWidth:"fit-content","&:hover":j.disabled?{}:{backgroundColor:`${j.color}20`,borderColor:`${j.color}60`,transform:"translateY(-1px)",boxShadow:`0 2px 8px ${j.color}20`}},children:[e.jsx(C,{sx:{width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",color:j.active?j.color:G?"#B0B0B0":"#666","& svg":{fontSize:"18px"}},children:j.icon}),e.jsx(K,{variant:"body2",sx:{color:j.active?j.color:G?"#B0B0B0":"#666",fontSize:"12px",fontWeight:j.active?500:400,whiteSpace:"nowrap"},children:j.label})]},_)),t&&m.length>1&&e.jsxs(C,{onClick:()=>le(!0),sx:{display:"flex",alignItems:"center",gap:1,padding:"6px 12px",borderRadius:"12px",cursor:"pointer",backgroundColor:G?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",border:`1px solid ${G?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}`,transition:"all 0.2s ease",minWidth:"fit-content","&:hover":{backgroundColor:"#FF980020",borderColor:"#FF980060",transform:"translateY(-1px)",boxShadow:"0 2px 8px #FF980020"}},children:[e.jsx(C,{sx:{width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",color:G?"#B0B0B0":"#666","& svg":{fontSize:"18px"}},children:e.jsx(er,{size:18})}),e.jsx(K,{variant:"body2",sx:{color:G?"#B0B0B0":"#666",fontSize:"12px",fontWeight:400,whiteSpace:"nowrap"},children:"多模型"})]}),e.jsx(K,{variant:"caption",sx:{color:G?"#666":"#999",fontSize:"11px",fontStyle:"italic",marginLeft:"auto"},children:"更多功能即将推出..."})]})})}),e.jsx(Kr,{open:z,onClose:()=>P(!1),onProviderSelect:Le}),e.jsx(Nr,{open:W,onClose:()=>u(!1),onSelect:zt,searchQuery:ge}),e.jsx(Lr,{open:H,onClose:()=>le(!1),availableModels:m,onConfirm:xe,maxSelection:5}),e.jsx(Er,{messages:de,onClose:j=>Se.remove(j),maxVisible:3})]})},_n=({message:n,setMessage:t,isDarkMode:o,isLoading:a,allowConsecutiveMessages:r,uploadingMedia:i,files:d,setImages:l,setFiles:x,setUploadingMedia:b,processImages:p,onSendMessage:y,toolsEnabled:g,iconColor:m})=>{const[v,S]=s.useState("normal"),{isListening:I,startRecognition:E,stopRecognition:F}=ir(),h=s.useCallback(()=>{v==="normal"?S("recording"):v==="recording"&&(I&&F().catch(W=>console.error("停止语音识别出错:",W)),S("normal"))},[v,I,F]),A=s.useCallback(async W=>{if(W&&W.trim()){const u=await p(),f=d.filter(M=>!M.mimeType.startsWith("image/"));if(y(W.trim(),u.length>0?u:void 0,g,f),l([]),x([]),b(!1),S("normal"),"navigator"in window&&"vibrate"in navigator)try{navigator.vibrate(50)}catch{}}},[p,d,y,g,l,x,b]),z=s.useCallback(()=>({id:"voice",icon:v!=="normal"?e.jsx(bs,{size:20}):e.jsx(Dr,{size:20}),tooltip:v!=="normal"?"退出语音输入模式":"切换到语音输入模式",onClick:h,color:v!=="normal"?"#f44336":m,disabled:i||a&&!r,isActive:v!=="normal"}),[v,h,m,i,a,r]),P=s.useCallback(()=>v!=="recording"?null:e.jsx("div",{style:{flexGrow:1,position:"relative"},children:e.jsx(Hr,{isDarkMode:o,onClose:()=>S("normal"),onSendMessage:A,onInsertText:W=>{t(W)},startRecognition:E,currentMessage:n})}),[v,o,A,t,E,n]);return{voiceState:v,getVoiceButtonConfig:z,renderVoiceInput:P,isVoiceRecording:v==="recording"}},Is=()=>{const n=or(),t=s.useRef(!1);return{handleCreateTopic:async()=>{if(t.current)return console.log("[useTopicManagement] 正在创建话题，跳过重复请求"),null;t.current=!0;try{console.log("[useTopicManagement] 开始创建话题 - Cherry Studio模式"),fr.emit(br.ADD_NEW_TOPIC);const a=await es.getCurrentAssistant();if(!a)return null;const r=tn(a.id);return console.log("[useTopicManagement] 立即更新Redux和选择新话题:",r.id),rn.dispatch(sn({assistantId:a.id,topic:r})),n(nn.setCurrentTopicId(r.id)),fr.emit(br.SHOW_TOPIC_SIDEBAR),fr.emit(br.TOPIC_CREATED,{topic:r,assistantId:a.id,type:"create"}),Promise.resolve().then(async()=>{try{await on.saveTopic(r),await es.addAssistantMessagesToTopic({assistant:a,topic:r}),console.log("[useTopicManagement] 异步保存完成")}catch(i){console.error("[useTopicManagement] 异步保存话题失败:",i)}}),console.log("[useTopicManagement] 话题创建完成，UI已立即更新"),r}catch(a){return console.error("[useTopicManagement] 创建话题失败:",a),null}finally{setTimeout(()=>{t.current=!1},500)}}}},Un=({anchorEl:n,open:t,onClose:o,onClearTopic:a,imageGenerationMode:r=!1,toggleImageGenerationMode:i,videoGenerationMode:d=!1,toggleVideoGenerationMode:l,webSearchActive:x=!1,toggleWebSearch:b,toolsEnabled:p=!0,onToolsEnabledChange:y})=>{const[g,m]=s.useState(!1),[v,S]=s.useState(!1),[I,E]=s.useState(!1),[F,h]=s.useState(!1),[A,z]=s.useState([]),[P,W]=s.useState([]),u=$e(),f=Qt(u.breakpoints.down("sm"));cr();const M=nr(),{handleCreateTopic:$}=Is(),B=se(L=>L.webSearch),D=B?.enabled||!1,c=B?.provider,k=se(L=>L.settings.toolbarButtons||{order:["mcp-tools","new-topic","clear-topic","generate-image","generate-video","knowledge","web-search"],visibility:{"mcp-tools":!0,"new-topic":!0,"clear-topic":!0,"generate-image":!0,"generate-video":!0,knowledge:!0,"web-search":!0}}),w=s.useRef(void 0);s.useEffect(()=>()=>{w.current&&clearTimeout(w.current)},[]);const T=async()=>{await $(),o()},R=()=>{v?(a?.(),S(!1),o()):(S(!0),w.current&&clearTimeout(w.current),w.current=window.setTimeout(()=>S(!1),3e3))},U=()=>{E(!0)},N=(L,X)=>{console.log("选择了知识库:",L,"搜索结果:",X);const Z={knowledgeBase:{id:L.id,name:L.name},isSelected:!0,searchOnSend:!0};console.log("[ToolsMenu] 保存知识库选择到sessionStorage:",Z),window.sessionStorage.setItem("selectedKnowledgeBase",JSON.stringify(Z));const pe=window.sessionStorage.getItem("selectedKnowledgeBase");console.log("[ToolsMenu] sessionStorage保存验证:",pe),E(!1)},Y=()=>{m(!0)},J=L=>{L&&b&&b(),o()},ee=()=>{const L=Ne.getServers(),X=Ne.getActiveServers();z(L),W(X)},me=()=>{h(!0),ee()},H=()=>{h(!1)},le=async(L,X)=>{try{if(await Ne.toggleServer(L,X),ee(),y){const Z=Ne.getActiveServers();X&&!p?(console.log("[MCP] 开启服务器，自动启用MCP工具总开关"),y(!0)):!X&&Z.length===0&&p&&(console.log("[MCP] 所有服务器已关闭，自动禁用MCP工具总开关"),y(!1))}}catch(Z){console.error("切换服务器状态失败:",Z)}},de=()=>{h(!1),M("/settings/mcp-server")},te=L=>{y&&y(L),ee()},V=L=>{switch(L){case"httpStream":return e.jsx(Fr,{size:16});case"inMemory":return e.jsx(ms,{size:16});default:return e.jsx(Pt,{size:16})}},oe=L=>{switch(L){case"httpStream":return u.palette.secondary.main;case"inMemory":return u.palette.warning.main;default:return u.palette.text.disabled}},ie={"mcp-tools":{id:"mcp-tools",icon:e.jsx(ut,{size:16,color:p?u.palette.success.main:u.palette.text.disabled}),label:"工具",onClick:me,isActive:p},"new-topic":{id:"new-topic",icon:e.jsx(st,{size:16,color:u.palette.success.main}),label:"新建话题",onClick:T,isActive:!1},"clear-topic":{id:"clear-topic",icon:v?e.jsx(Ar,{size:16,color:u.palette.error.main}):e.jsx(_t,{size:16,color:u.palette.primary.main}),label:v?"确认清空":"清空内容",onClick:R,isActive:v},"generate-image":{id:"generate-image",icon:e.jsx(ze,{name:"imageGenerate",size:16,color:r?u.palette.secondary.main:Fe(u.palette.secondary.main,.6)}),label:r?"取消生成":"生成图片",onClick:()=>{i?.(),o()},isActive:r},"generate-video":{id:"generate-video",icon:e.jsx(lr,{size:16,color:d?u.palette.error.main:Fe(u.palette.error.main,.6)}),label:d?"取消生成":"生成视频",onClick:()=>{l?.(),o()},isActive:d},knowledge:{id:"knowledge",icon:e.jsx(wt,{size:16,color:u.palette.info.main}),label:"知识库",onClick:U,isActive:!1},"web-search":D&&b?{id:"web-search",icon:e.jsx(ze,{name:"search",size:16,color:x?u.palette.primary.main:Fe(u.palette.primary.main,.6)}),label:B?.providers?.find(L=>L.id===c)?.name||"网络搜索",onClick:Y,isActive:x}:null},Q=k.order.filter(L=>{const X=ie[L];return k.visibility[L]&&X&&typeof X=="object"&&"id"in X}).map(L=>ie[L]).filter(L=>L!==null);return e.jsxs(e.Fragment,{children:[e.jsx(Tr,{anchorEl:n,open:t,onClose:o,disableAutoFocus:!0,disableRestoreFocus:!0,disableEnforceFocus:!0,anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"bottom",horizontal:"left"},slotProps:{paper:{sx:{borderRadius:3,minWidth:{xs:"90vw",sm:280},maxWidth:{xs:"95vw",sm:320},width:{xs:"90vw",sm:"auto"},maxHeight:{xs:"70vh",sm:"80vh"},overflow:"auto",boxShadow:u.shadows[8],backgroundColor:u.palette.background.paper}},root:{slotProps:{backdrop:{invisible:!1,sx:{backgroundColor:"transparent"}}}}},sx:{"& .MuiList-root":{"&:focus":{outline:"none"}}},children:Q.map(L=>!("onClick"in L)||!("icon"in L)||!("label"in L)?null:e.jsxs(De,{onClick:()=>{if(L.id==="clear-topic"&&!v){L.onClick();return}L.onClick(),o()},sx:{padding:{xs:1.5,sm:2},minHeight:{xs:52,sm:60},display:"flex",alignItems:"center","&:hover":{backgroundColor:u.palette.action.hover}},children:[e.jsx(C,{sx:{width:{xs:28,sm:32},height:{xs:28,sm:32},borderRadius:2,backgroundColor:L.isActive?L.id==="mcp-tools"?Fe(u.palette.success.main,.15):Fe(u.palette.primary.main,.15):Fe(u.palette.text.primary,.08),display:"flex",alignItems:"center",justifyContent:"center",marginRight:{xs:1.5,sm:2},flexShrink:0},children:e.jsx(C,{sx:{"& svg":{width:{xs:"14px",sm:"16px"},height:{xs:"14px",sm:"16px"}}},children:L.icon})}),e.jsx(K,{variant:"body2",sx:{color:u.palette.text.primary,fontSize:{xs:"14px",sm:"15px"},fontWeight:500,flex:1},children:L.label})]},L.id))}),e.jsx(Kr,{open:g,onClose:()=>m(!1),onProviderSelect:J}),e.jsx(Nr,{open:I,onClose:()=>E(!1),onSelect:N}),e.jsxs(ht,{open:F,onClose:H,maxWidth:"sm",fullWidth:!0,fullScreen:f,PaperProps:{sx:{borderRadius:{xs:0,sm:2},maxHeight:{xs:"100vh",sm:"80vh"},margin:{xs:0,sm:"auto"}}},children:[e.jsx(xt,{sx:{pb:1,px:{xs:2,sm:3},pt:{xs:2,sm:3}},children:e.jsxs(C,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:1}},children:[e.jsx(ne,{onClick:H,sx:{mr:1,p:.5,display:{xs:"inline-flex",sm:"none"}},children:e.jsx(gs,{size:22})}),e.jsx(C,{sx:{"& svg":{width:{xs:"18px",sm:"20px"},height:{xs:"18px",sm:"20px"},color:u.palette.success.main,display:{xs:"none",sm:"inline-flex"}}}}),e.jsx(K,{variant:"h6",fontWeight:600,sx:{fontSize:{xs:"1.1rem",sm:"1.25rem"}},children:"MCP 工具服务器"}),P.length>0&&e.jsx(tt,{label:`${P.length} 个运行中`,size:"small",color:"success",variant:"outlined",sx:{ml:{xs:.5,sm:1}}})]}),e.jsxs(C,{sx:{display:"flex",alignItems:"center"},children:[y&&e.jsx(Gt,{checked:p,onChange:L=>te(L.target.checked)}),e.jsx(ne,{onClick:H,sx:{ml:1,display:{xs:"none",sm:"inline-flex"}},children:e.jsx(Ve,{size:22})})]})]})}),e.jsx(gt,{sx:{p:0},children:A.length===0?e.jsxs(C,{sx:{p:{xs:2,sm:3},textAlign:"center"},children:[e.jsx(C,{sx:{"& svg":{width:{xs:"40px",sm:"48px"},height:{xs:"40px",sm:"48px"}},mb:{xs:1.5,sm:2}},children:e.jsx(ut,{size:48,color:u.palette.text.disabled})}),e.jsx(K,{variant:"h6",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",sm:"1.25rem"}},children:"还没有配置 MCP 服务器"}),e.jsx(K,{variant:"body2",color:"text.secondary",sx:{mb:{xs:2,sm:3},fontSize:{xs:"13px",sm:"14px"}},children:"MCP 服务器可以为 AI 提供额外的工具和功能"}),e.jsx(Ie,{variant:"contained",startIcon:e.jsx(C,{sx:{"& svg":{width:{xs:"14px",sm:"16px"},height:{xs:"14px",sm:"16px"}}},children:e.jsx(st,{size:16})}),onClick:de,sx:{bgcolor:u.palette.success.main,"&:hover":{bgcolor:u.palette.success.dark},fontSize:{xs:"14px",sm:"16px"}},children:"添加服务器"})]}):e.jsxs(e.Fragment,{children:[e.jsx(et,{sx:{px:{xs:0,sm:1}},children:A.map(L=>e.jsxs(qe,{sx:{padding:{xs:"12px 16px",sm:"12px"},borderRadius:2,mb:1.5,backgroundColor:Fe(u.palette.text.primary,.05),transition:"background-color 0.2s",display:"flex",alignItems:"flex-start","&:hover":{backgroundColor:Fe(u.palette.text.primary,.08)}},children:[e.jsx(ye,{sx:{minWidth:40,mt:.5},children:e.jsx(fs,{sx:{bgcolor:Fe(oe(L.type),.1),color:oe(L.type),width:{xs:28,sm:32},height:{xs:28,sm:32},"& svg":{width:{xs:"14px",sm:"16px"},height:{xs:"14px",sm:"16px"}}},children:V(L.type)})}),e.jsx(C,{sx:{flex:1,pr:7},children:e.jsx(we,{primary:L.name,secondary:L.description,primaryTypographyProps:{fontWeight:600,fontSize:"1rem",color:u.palette.text.primary},secondaryTypographyProps:{fontSize:"0.875rem",color:u.palette.text.secondary,whiteSpace:"normal",sx:{wordBreak:"break-word"}}})}),e.jsx(kr,{children:e.jsx(Gt,{checked:L.isActive,onChange:X=>{le(L.id,X.target.checked)}})})]},L.id))}),e.jsx(C,{sx:{p:{xs:1.5,sm:2},borderTop:"1px solid",borderColor:"divider"},children:e.jsx(Ie,{fullWidth:!0,variant:"outlined",startIcon:e.jsx(C,{sx:{"& svg":{width:{xs:"14px",sm:"16px"},height:{xs:"14px",sm:"16px"}}},children:e.jsx(Pt,{size:16})}),onClick:de,sx:{fontSize:{xs:"14px",sm:"16px"}},children:"管理服务器"})})]})})]})]})},Hn=({message:n,isStreaming:t,isDebating:o,canSendMessage:a,imageGenerationMode:r,videoGenerationMode:i,webSearchActive:d,toolsEnabled:l,availableModels:x,onSendMultiModelMessage:b,handleImageUploadLocal:p,handleFileUploadLocal:y,onStartDebate:g,onStopDebate:m,handleInsertPhrase:v,currentAssistant:S,onClearTopic:I,toggleImageGenerationMode:E,toggleVideoGenerationMode:F,toggleWebSearch:h,onToolsEnabledChange:A,showAIDebateButton:z,showQuickPhraseButton:P,processImages:W,files:u,setImages:f,setFiles:M,setUploadingMedia:$,setMessage:B})=>{const[D,c]=s.useState(null),[k,w]=s.useState(!1),[T,R]=s.useState(!1),[U,N]=s.useState(null),Y=s.useRef(null),J=s.useRef(null),ee=s.useCallback(Q=>{c(Q.currentTarget)},[]),me=s.useCallback(()=>{c(null)},[]),H=s.useCallback(Q=>{N(Q.currentTarget),R(!0)},[]),le=s.useCallback(()=>{N(null),R(!1)},[]),de=s.useCallback(async Q=>{if(!n.trim()&&u.length===0){console.log("没有内容可发送");return}if(!Q||Q.length===0){console.log("没有选择模型");return}let L=n.trim();const X=await W(),Z=u.filter(pe=>!pe.mimeType.startsWith("image/"));console.log("发送多模型消息:",{message:L,models:Q.map(pe=>`${pe.provider||pe.providerType}:${pe.id}`),images:X.length,files:u.length,toolsEnabled:l}),b&&b(L,Q,X.length>0?X:void 0,l,Z),B(""),f([]),M([]),$(!1),w(!1)},[n,u,W,l,b,B,f,M,$]),te=s.useCallback(()=>{if(o)m?.();else if(Y.current){const Q=Y.current.querySelector("button");Q&&Q.click()}},[o,m]),V=s.useCallback(Q=>{if(J.current){const X=Q.currentTarget.getBoundingClientRect(),Z=J.current;Z.style.position="fixed",Z.style.left=`${X.left}px`,Z.style.top=`${X.top}px`,Z.style.zIndex="-1",Z.style.opacity="0",Z.style.pointerEvents="none";const pe=Z.querySelector("button");pe&&pe.click()}},[]),oe=s.useCallback(()=>{if(J.current){const Q=J.current;Q.style.position="fixed",Q.style.left="50%",Q.style.top="50%",Q.style.transform="translate(-50%, -50%)",Q.style.zIndex="-1",Q.style.opacity="0",Q.style.pointerEvents="none";const L=Q.querySelector("button");L&&L.click()}},[]),ie=s.useCallback(()=>e.jsxs(e.Fragment,{children:[e.jsx(vs,{anchorEl:D,open:!!D,onClose:me,onImageUpload:p,onFileUpload:y,onMultiModelSend:()=>w(!0),showMultiModel:!!(b&&x.length>1&&!t&&a()),onAIDebate:te,showAIDebate:z,isDebating:o,onQuickPhrase:oe,showQuickPhrase:P}),e.jsx(Lr,{open:k,onClose:()=>w(!1),availableModels:x,onConfirm:de,maxSelection:5}),e.jsx(Un,{anchorEl:U,open:T,onClose:le,onClearTopic:I,imageGenerationMode:r,toggleImageGenerationMode:E,videoGenerationMode:i,toggleVideoGenerationMode:F,webSearchActive:d,toggleWebSearch:h,toolsEnabled:l,onToolsEnabledChange:A}),e.jsx("div",{style:{position:"absolute",left:"-9999px",top:"-9999px"},ref:Y,children:e.jsx(Or,{onStartDebate:g,onStopDebate:m,isDebating:o,disabled:!1,question:n})}),e.jsx("div",{ref:J,style:{position:"fixed",left:"-9999px",top:"-9999px",zIndex:-1,opacity:0,pointerEvents:"none"},children:e.jsx(_r,{onInsertPhrase:v,assistant:S,disabled:!1,size:"medium"})})]}),[D,me,p,y,b,x,t,a,te,z,o,oe,P,k,de,U,T,le,I,r,E,i,F,d,h,l,A,g,m,n,v,S]);return{uploadMenuAnchorEl:D,multiModelSelectorOpen:k,toolsMenuOpen:T,toolsMenuAnchorEl:U,handleOpenUploadMenu:ee,handleCloseUploadMenu:me,handleOpenToolsMenu:H,handleCloseToolsMenu:le,handleMultiModelSend:de,handleAIDebateClick:te,handleQuickPhraseClick:V,handleQuickPhraseClickForUploadMenu:oe,setMultiModelSelectorOpen:w,renderMenus:ie}},Kn=({isLoading:n,allowConsecutiveMessages:t,isStreaming:o,uploadingMedia:a,imageGenerationMode:r,videoGenerationMode:i,webSearchActive:d,toolsEnabled:l,images:x,files:b,handleSubmit:p,onStopResponse:y,handleImageUploadLocal:g,handleFileUploadLocal:m,onClearTopic:v,onToolsEnabledChange:S,handleQuickWebSearchToggle:I,menuManager:E,voiceInputManager:F,canSendMessage:h,isDarkMode:A,iconColor:z,disabledColor:P,showLoadingIndicator:W,isDebating:u})=>{const[f,M]=s.useState(!1),$=se(T=>T.settings.integratedInputLeftButtons||["tools","clear","search"]),B=se(T=>T.settings.integratedInputRightButtons||["voice","send"]),D=s.useCallback(()=>{f?(v?.(),M(!1)):(M(!0),setTimeout(()=>M(!1),3e3))},[f,v]),c=s.useCallback(()=>{console.log("知识库功能待实现")},[]),k={tools:{id:"tools",icon:e.jsx(ze,{name:"settingsPanel",size:20}),tooltip:"扩展",onClick:E.handleOpenToolsMenu,color:z,disabled:!1,isActive:!1},"mcp-tools":{id:"mcp-tools",icon:e.jsx(ut,{size:20}),tooltip:l?"禁用MCP工具":"启用MCP工具",onClick:()=>S?.(!l),color:l?"#4CAF50":z,disabled:!1,isActive:l},clear:{id:"clear",icon:f?e.jsx(Ar,{size:20}):e.jsx(_t,{size:20}),tooltip:f?"确认清空":"清空内容",onClick:D,color:f?"#f44336":z,disabled:!1,isActive:f},image:{id:"image",icon:e.jsx(pt,{size:20}),tooltip:r?"退出图像生成模式":"图像生成",onClick:()=>console.log("图像生成功能"),color:r?"#9C27B0":z,disabled:!1,isActive:r},video:{id:"video",icon:e.jsx(lr,{size:20}),tooltip:i?"退出视频生成模式":"视频生成",onClick:()=>console.log("视频生成功能"),color:i?"#FF5722":z,disabled:!1,isActive:i},knowledge:{id:"knowledge",icon:e.jsx(wt,{size:20}),tooltip:"知识库",onClick:c,color:z,disabled:!1,isActive:!1},search:{id:"search",icon:e.jsx(ze,{name:"search",size:20}),tooltip:d?"退出网络搜索模式":"网络搜索",onClick:I||(()=>console.log("网络搜索功能")),color:d?"#3b82f6":z,disabled:!1,isActive:d},upload:{id:"upload",icon:a?e.jsx(dt,{size:20}):e.jsx(ws,{badgeContent:x.length+b.length,color:"primary",max:9,invisible:x.length+b.length===0,children:e.jsx(st,{size:20})}),tooltip:"添加内容",onClick:E.handleOpenUploadMenu,color:a?P:z,disabled:a||n&&!t,isActive:!1},camera:{id:"camera",icon:e.jsx($r,{size:20}),tooltip:"拍摄照片",onClick:()=>g("camera"),color:"#9C27B0",disabled:a||n&&!t,isActive:!1},"photo-select":{id:"photo-select",icon:e.jsx(pt,{size:20}),tooltip:"选择图片",onClick:()=>g("photos"),color:"#1976D2",disabled:a||n&&!t,isActive:!1},"file-upload":{id:"file-upload",icon:e.jsx(Rt,{size:20}),tooltip:"上传文件",onClick:m,color:"#4CAF50",disabled:a||n&&!t,isActive:!1},"ai-debate":{id:"ai-debate",icon:e.jsx(ze,{name:"aiDebate",size:20,color:u?"#f44336":z}),tooltip:u?"停止AI辩论":"开始AI辩论",onClick:E.handleAIDebateClick,color:u?"#f44336":z,disabled:!1,isActive:u},"quick-phrase":{id:"quick-phrase",icon:e.jsx(ze,{name:"quickPhrase",size:20,color:z}),tooltip:"快捷短语",onClick:E.handleQuickPhraseClick,color:z,disabled:!1,isActive:!1},"multi-model":{id:"multi-model",icon:e.jsx(tr,{size:20}),tooltip:"多模型发送",onClick:()=>E.setMultiModelSelectorOpen(!0),color:z,disabled:!1,isActive:!1},send:{id:"send",icon:o?e.jsx(ar,{size:18}):W?e.jsx(dt,{size:20,color:"inherit"}):r?e.jsx(pt,{size:18}):e.jsx(er,{size:18}),tooltip:o?"停止生成":r?"生成图像":"发送消息",onClick:o&&y?y:p,color:o?"#ff4d4f":!h()||n&&!t?P:r?"#9C27B0":A?"#4CAF50":"#09bb07",disabled:!o&&(!h()||n&&!t),isActive:!1},voice:F.getVoiceButtonConfig()};return{renderButtonToolbar:s.useCallback(()=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",paddingTop:"0px",minHeight:"36px",height:"36px",flex:"0 0 auto"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:$.map(T=>{const R=k[T];return R?e.jsx(Te,{title:R.tooltip,children:e.jsx("span",{children:e.jsx(ne,{size:"medium",onClick:R.onClick,disabled:R.disabled||n&&!t,style:{color:R.color,padding:"6px",backgroundColor:R.isActive?"rgba(59, 130, 246, 0.1)":"transparent",transition:"all 0.2s ease-in-out"},children:R.icon})})},T):null})}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:B.map(T=>{const R=k[T];return R?e.jsx(Te,{title:R.tooltip,children:e.jsx("span",{children:e.jsx(ne,{size:"medium",onClick:R.onClick,disabled:R.disabled||n&&!t,style:{color:R.color,padding:"6px",backgroundColor:R.isActive?"rgba(59, 130, 246, 0.1)":"transparent",transition:"all 0.2s ease-in-out"},children:R.icon})})},T):null})})]}),[$,B,k,n,t])}},Nn=({message:n,isMobile:t,isTablet:o,isIOS:a,isKeyboardVisible:r,isDarkMode:i,iconColor:d,themeColors:l,inputBoxStyle:x,border:b,borderRadius:p,boxShadow:y,handleChange:g})=>{const[m,v]=s.useState(!1),[S,I]=s.useState(Math.floor(window.innerHeight*.7)),[E,F]=s.useState(!1);s.useEffect(()=>{const f=()=>{I(Math.floor(window.innerHeight*.7))};return window.addEventListener("resize",f),()=>window.removeEventListener("resize",f)},[]);const h=s.useCallback(()=>{const f=n.length,$=Math.floor((t?280:o?400:500)/(o?17:16)),B=(n.match(/\n/g)||[]).length,D=Math.ceil(f/$)+B;F(m?!0:D>4)},[n,t,o,m]);s.useEffect(()=>{h()},[n,h]),s.useEffect(()=>{setTimeout(h,100)},[m,h]);const A=s.useCallback(f=>{g(f),setTimeout(h,100)},[g,h]),z=s.useCallback(()=>{v(!m)},[m]),P=()=>t?{paddingTop:"0px",paddingBottom:a?"34px":"4px",maxWidth:"100%",marginTop:"0",marginLeft:"0",marginRight:"0",paddingLeft:"8px",paddingRight:"8px"}:o?{paddingTop:"0px",paddingBottom:a?"34px":"4px",maxWidth:"calc(100% - 40px)",marginTop:"0",marginLeft:"auto",marginRight:"auto"}:{paddingTop:"0px",paddingBottom:a?"34px":"6px",maxWidth:"calc(100% - 32px)",marginTop:"0",marginLeft:"auto",marginRight:"auto"},W=s.useCallback(()=>E?e.jsx("div",{style:{position:"absolute",top:"4px",right:"4px",zIndex:10},children:e.jsx(Te,{title:m?"收起输入框":"展开输入框",children:e.jsx(ne,{onClick:z,size:"small",style:{color:m?"#2196F3":d,padding:"2px",width:"20px",height:"20px",minWidth:"20px",backgroundColor:i?"rgba(42, 42, 42, 0.9)":"rgba(255, 255, 255, 0.9)",backdropFilter:"blur(4px)",borderRadius:"6px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transition:"all 0.2s ease"},children:m?e.jsx(yt,{size:14}):e.jsx(Ut,{size:14})})})}):null,[E,m,z,d,i]),u=s.useCallback(f=>{const M=P();return e.jsx("div",{style:{backgroundColor:"transparent",...M,width:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",boxShadow:"none",transition:"all 0.3s ease",marginBottom:"0",paddingBottom:r&&t?"env(safe-area-inset-bottom)":a?"34px":"0",border:"none"},children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",padding:o?"8px 12px":t?"6px 8px":"7px 10px",borderRadius:p,background:l.paper,border:b,minHeight:o?"72px":t?"64px":"68px",boxShadow:y,width:"100%",maxWidth:"100%",backdropFilter:x==="modern"?"blur(10px)":"none",WebkitBackdropFilter:x==="modern"?"blur(10px)":"none",transition:"all 0.3s ease",position:"relative",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTouchCallout:"none",WebkitTapHighlightColor:"transparent"},children:[W(),f]})})},[P,r,t,o,a,l.paper,b,y,x,W]);return{expanded:m,expandedHeight:S,showExpandButton:E,enhancedHandleChange:A,handleExpandToggle:z,renderContainer:u}},jo=({onSendMessage:n,onSendMultiModelMessage:t,onStartDebate:o,onStopDebate:a,isLoading:r=!1,allowConsecutiveMessages:i=!0,imageGenerationMode:d=!1,videoGenerationMode:l=!1,onSendImagePrompt:x,webSearchActive:b=!1,onStopResponse:p,isStreaming:y=!1,isDebating:g=!1,toolsEnabled:m=!0,availableModels:v=[],onClearTopic:S,toggleImageGenerationMode:I,toggleVideoGenerationMode:E,toggleWebSearch:F,onToolsEnabledChange:h})=>{const[A,z]=s.useState(!1),[P,W]=s.useState([]),[u,f]=s.useState([]),[M,$]=s.useState(!1),[B,D]=s.useState({}),[c,k]=s.useState([]),w=s.useRef(null),[T,R]=s.useState(!1),U=se(ae=>ae.assistants.currentAssistant),N=or(),Y=se(ae=>ae.webSearch),{styles:J,isDarkMode:ee,inputBoxStyle:me}=cr(),H=$e(),le=se(ae=>ae.settings.themeStyle),de=Pr(H,le),te=se(ae=>ae.settings.showAIDebateButton??!0),V=se(ae=>ae.settings.showQuickPhraseButton??!0);s.useEffect(()=>{T&&Y?.enabled&&Y?.provider&&Y.provider!=="custom"&&(F?.(),R(!1))},[Y?.enabled,Y?.provider,T,F]);const{message:oe,setMessage:ie,textareaRef:Q,canSendMessage:L,handleSubmit:X,handleKeyDown:Z,handleChange:pe,textareaHeight:O,showCharCount:ue,handleCompositionStart:G,handleCompositionEnd:fe,isMobile:ke,isTablet:vt}=Mr({onSendMessage:n,onSendImagePrompt:x,isLoading:r,allowConsecutiveMessages:i,imageGenerationMode:d,videoGenerationMode:l,toolsEnabled:m,images:P,files:u,setImages:W,setFiles:f,enableTextareaResize:!0,enableCompositionHandling:!0,enableCharacterCount:!0}),{isKeyboardVisible:Et,isPageTransitioning:Ft,shouldHandleFocus:At}=Ur();s.useEffect(()=>Se.subscribe(k),[]);const{border:Re,borderRadius:be,boxShadow:Bt}=J,mt=de.isDark?"#ffffff":"#000000",ge=de.isDark?"#555":"#ccc";s.useEffect(()=>{const ae=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&"ontouchend"in document;if(z(ae),ae){document.body.classList.add("platform-ios"),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0)&&document.body.classList.add("pwa-mode");const ce=()=>{const Pe=window.visualViewport?.height||window.innerHeight,Le=window.screen.height*.75;Pe<Le?document.body.classList.add("keyboard-visible"):document.body.classList.remove("keyboard-visible")};return window.visualViewport?window.visualViewport.addEventListener("resize",ce):window.addEventListener("resize",ce),()=>{window.visualViewport?window.visualViewport.removeEventListener("resize",ce):window.removeEventListener("resize",ce)}}},[]);const Qe=async()=>{const ae=[...P,...u.filter(ce=>ce.mimeType.startsWith("image/")).map(ce=>({base64Data:ce.base64Data,url:ce.url||"",width:ce.width,height:ce.height}))];return await Promise.all(ae.map(async ce=>{let Pe=ce.base64Data||ce.url;if(ce.url&&ce.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/)){const Me=ce.url.match(/\[图片:([a-zA-Z0-9_-]+)\]/);if(Me&&Me[1])try{const Le=Me[1],Xe=await rt.getImageBlob(Le);Xe&&(Pe=await new Promise(ft=>{const bt=new FileReader;bt.onload=()=>ft(bt.result),bt.readAsDataURL(Xe)}))}catch(Le){console.error("加载图片引用失败:",Le)}}return{type:"image_url",image_url:{url:Pe}}}))},je=_n({message:oe,setMessage:ie,isDarkMode:ee,isLoading:r,allowConsecutiveMessages:i,uploadingMedia:M,files:u,setImages:W,setFiles:f,setUploadingMedia:$,processImages:Qe,onSendMessage:n,toolsEnabled:m,iconColor:mt}),nt=async(ae="photos")=>{w.current&&await w.current.handleImageUpload(ae)},Ct=async()=>{w.current&&await w.current.handleFileUpload()},kt=s.useCallback(()=>{if(b)F?.();else{const ae=Y?.enabled||!1,Ce=Y?.provider;if(ae&&Ce&&Ce!=="custom")F?.();else{const ce=[];ae||ce.push(an()),(!Ce||Ce==="custom")&&ce.push(Sr("bing-free")),ce.forEach(Pe=>N(Pe)),R(!0)}}},[b,Y,F,N,R]),St=s.useCallback(ae=>{if(!Q.current)return;const Ce=Q.current,ce=Ce.selectionStart,Pe=Ce.selectionEnd,Me=oe,Le=Me.slice(0,ce)+ae+Me.slice(Pe);ie(Le),setTimeout(()=>{if(Ce){const Xe=ce+ae.length;Ce.focus(),Ce.setSelectionRange(Xe,Xe)}},10)},[oe,ie]),It=Hn({message:oe,isStreaming:y,isDebating:g,canSendMessage:L,imageGenerationMode:d,videoGenerationMode:l,webSearchActive:b,toolsEnabled:m,availableModels:v,onSendMultiModelMessage:t,handleImageUploadLocal:nt,handleFileUploadLocal:Ct,onStartDebate:o,onStopDebate:a,handleInsertPhrase:St,currentAssistant:U,onClearTopic:S,toggleImageGenerationMode:I,toggleVideoGenerationMode:E,toggleWebSearch:F,onToolsEnabledChange:h,showAIDebateButton:te,showQuickPhraseButton:V,processImages:Qe,files:u,setImages:W,setFiles:f,setUploadingMedia:$,setMessage:ie}),Dt=r&&!i,Ze=Nn({message:oe,isMobile:ke,isTablet:vt,isIOS:A,isKeyboardVisible:Et,isDarkMode:ee,iconColor:mt,themeColors:de,inputBoxStyle:me,border:Re,borderRadius:be,boxShadow:Bt,handleChange:pe}),He=Kn({isLoading:r,allowConsecutiveMessages:i,isStreaming:y,uploadingMedia:M,imageGenerationMode:d,videoGenerationMode:l,webSearchActive:b,toolsEnabled:m,images:P,files:u,handleSubmit:X,onStopResponse:p,handleImageUploadLocal:nt,handleFileUploadLocal:Ct,onClearTopic:S,onToolsEnabledChange:h,handleQuickWebSearchToggle:kt,menuManager:It,voiceInputManager:je,canSendMessage:L,isDarkMode:ee,iconColor:mt,disabledColor:ge,showLoadingIndicator:Dt,isDebating:g});return Ze.renderContainer(e.jsxs(e.Fragment,{children:[e.jsx(Wr,{ref:w,images:P,files:u,setImages:W,setFiles:f,setUploadingMedia:$,fileStatuses:B,setFileStatuses:D,isDarkMode:ee,isMobile:ke,borderRadius:be}),e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"0px",minHeight:"36px",height:"36px",flex:"1"},children:je.isVoiceRecording?je.renderVoiceInput():e.jsx(ks,{message:oe,textareaRef:Q,textareaHeight:O,showCharCount:ue,handleChange:Ze.enhancedHandleChange,handleKeyDown:Z,handleCompositionStart:G,handleCompositionEnd:fe,onPaste:ae=>{w.current&&w.current.handlePaste(ae)},isLoading:r,allowConsecutiveMessages:i,imageGenerationMode:d,videoGenerationMode:l,webSearchActive:b,isMobile:ke,isTablet:vt,isDarkMode:ee,shouldHideVoiceButton:!1,expanded:Ze.expanded,expandedHeight:Ze.expandedHeight,onExpandToggle:Ze.handleExpandToggle,isPageTransitioning:Ft,shouldHandleFocus:At})}),!je.isVoiceRecording&&He.renderButtonToolbar(),It.renderMenus(),e.jsx(Er,{messages:c,onClose:ae=>Se.remove(ae),maxVisible:3})]}))},zs=n=>({container:{background:"transparent",border:"none",borderRadius:"24px",padding:"0 8px",position:"relative"},button:{position:"relative",background:n?"rgba(255, 255, 255, 0.02)":"rgba(255, 255, 255, 0.06)",border:n?"1px solid rgba(255, 255, 255, 0.04)":"1px solid rgba(255, 255, 255, 0.08)",borderRadius:"16px",padding:"8px 14px",backdropFilter:"blur(40px) saturate(200%) brightness(105%)",WebkitBackdropFilter:"blur(40px) saturate(200%) brightness(105%)",boxShadow:n?`0 4px 20px rgba(0, 0, 0, 0.06),
           0 1px 4px rgba(0, 0, 0, 0.04),
           inset 0 1px 0 rgba(255, 255, 255, 0.03),
           inset 0 -1px 0 rgba(255, 255, 255, 0.01)`:`0 4px 20px rgba(0, 0, 0, 0.03),
           0 1px 4px rgba(0, 0, 0, 0.02),
           inset 0 1px 0 rgba(255, 255, 255, 0.12),
           inset 0 -1px 0 rgba(255, 255, 255, 0.06)`,transition:"all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px",minHeight:"36px",userSelect:"none",WebkitUserSelect:"none",willChange:"transform, background, box-shadow, backdrop-filter",transform:"translateZ(0)","&::before":{content:'""',position:"absolute",top:"1px",left:"1px",right:"1px",height:"40%",background:n?"linear-gradient(180deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.005) 100%)":"linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.01) 100%)",borderRadius:"15px 15px 0 0",pointerEvents:"none"}},buttonHover:{background:n?"rgba(255, 255, 255, 0.04)":"rgba(255, 255, 255, 0.1)",border:n?"1px solid rgba(255, 255, 255, 0.06)":"1px solid rgba(255, 255, 255, 0.12)",backdropFilter:"blur(50px) saturate(220%) brightness(108%)",WebkitBackdropFilter:"blur(50px) saturate(220%) brightness(108%)",boxShadow:n?`0 8px 30px rgba(0, 0, 0, 0.08),
           0 2px 8px rgba(0, 0, 0, 0.06),
           inset 0 1px 0 rgba(255, 255, 255, 0.05),
           inset 0 -1px 0 rgba(255, 255, 255, 0.02)`:`0 8px 30px rgba(0, 0, 0, 0.04),
           0 2px 8px rgba(0, 0, 0, 0.03),
           inset 0 1px 0 rgba(255, 255, 255, 0.18),
           inset 0 -1px 0 rgba(255, 255, 255, 0.08)`,transform:"translateY(-1px) scale(1.01) translateZ(0)"},buttonActive:{background:n?"rgba(255, 255, 255, 0.06)":"rgba(255, 255, 255, 0.14)",border:n?"1px solid rgba(255, 255, 255, 0.08)":"1px solid rgba(255, 255, 255, 0.16)",backdropFilter:"blur(35px) saturate(240%) brightness(112%)",WebkitBackdropFilter:"blur(35px) saturate(240%) brightness(112%)",boxShadow:n?`0 2px 12px rgba(0, 0, 0, 0.1),
           inset 0 1px 4px rgba(0, 0, 0, 0.04),
           inset 0 1px 0 rgba(255, 255, 255, 0.06)`:`0 2px 12px rgba(0, 0, 0, 0.05),
           inset 0 1px 4px rgba(0, 0, 0, 0.02),
           inset 0 1px 0 rgba(255, 255, 255, 0.22)`,transform:"translateY(0px) scale(0.98) translateZ(0)"},text:{fontSize:"13px",fontWeight:600,color:n?"rgba(255, 255, 255, 0.92)":"rgba(0, 0, 0, 0.85)",textShadow:n?"0 1px 3px rgba(0, 0, 0, 0.4)":"0 1px 3px rgba(255, 255, 255, 0.9)",letterSpacing:"0.02em"}}),Ts=n=>({container:{background:"transparent",border:"none",borderRadius:"24px",padding:"0 8px"},button:{background:"transparent",border:"none",borderRadius:"20px",padding:"6px 12px",transition:"all 0.15s ease",cursor:"pointer",display:"flex",alignItems:"center",gap:"6px",minHeight:"32px"},buttonHover:{background:n?"rgba(255, 255, 255, 0.06)":"rgba(0, 0, 0, 0.04)"},buttonActive:{background:n?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.06)",transform:"scale(0.96)"},text:{fontSize:"13px",fontWeight:500,color:n?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.75)"}}),vo=({onClearTopic:n,imageGenerationMode:t=!1,toggleImageGenerationMode:o,videoGenerationMode:a=!1,toggleVideoGenerationMode:r,webSearchActive:i=!1,toggleWebSearch:d,toolsEnabled:l=!0,onToolsEnabledChange:x})=>{const b=s.useRef(null),p=s.useRef(null),[y,g]=s.useState(!1),[m,v]=s.useState(0),[S,I]=s.useState(0),[E,F]=s.useState(!1),[h,A]=s.useState(!1),[z,P]=s.useState(!1),u=$e().palette.mode==="dark",f=or(),{handleCreateTopic:M}=Is(),$=se(O=>O.webSearch),B=$?.enabled||!1,D=$?.provider,c=se(O=>O.settings.toolbarDisplayStyle||"both"),k=se(O=>O.settings.toolbarCollapsed||!1),[w,T]=s.useState(k),R=se(O=>O.settings.toolbarStyle||"glassmorphism"),U=se(O=>O.settings.toolbarButtons||{order:["mcp-tools","new-topic","clear-topic","generate-image","generate-video","knowledge","web-search"],visibility:{"mcp-tools":!0,"new-topic":!0,"clear-topic":!0,"generate-image":!0,"generate-video":!0,knowledge:!0,"web-search":!0}}),N=R==="glassmorphism"?zs(u):Ts(u),Y=O=>({...N.button,...O&&R==="glassmorphism"&&{background:u?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.28)",border:u?"1px solid rgba(255, 255, 255, 0.18)":"1px solid rgba(255, 255, 255, 0.35)",backdropFilter:"blur(26px) saturate(220%) brightness(118%)",WebkitBackdropFilter:"blur(26px) saturate(220%) brightness(118%)",boxShadow:u?`0 6px 24px rgba(0, 0, 0, 0.18),
             0 2px 8px rgba(0, 0, 0, 0.12),
             inset 0 1px 0 rgba(255, 255, 255, 0.18),
             inset 0 -1px 0 rgba(255, 255, 255, 0.08)`:`0 6px 24px rgba(0, 0, 0, 0.09),
             0 2px 8px rgba(0, 0, 0, 0.06),
             inset 0 1px 0 rgba(255, 255, 255, 0.5),
             inset 0 -1px 0 rgba(255, 255, 255, 0.25)`,"&::after":{content:'""',position:"absolute",top:"2px",left:"2px",right:"2px",height:"40%",background:u?"linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.02) 100%)":"linear-gradient(180deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.05) 100%)",borderRadius:"18px 18px 0 0",pointerEvents:"none"}},...O&&R==="transparent"&&{background:u?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.05)"}});s.useEffect(()=>{if(h){const O=setTimeout(()=>{A(!1)},3e3);return()=>clearTimeout(O)}},[h]),s.useEffect(()=>{T(k)},[k]),s.useEffect(()=>()=>{p.current&&clearTimeout(p.current)},[]);const J=()=>{const O=!w;T(O),p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{f(ln({toolbarCollapsed:O}))},500)},ee=()=>{h?(n?.(),A(!1)):A(!0)},me=O=>{g(!0),v(O.pageX-b.current.offsetLeft),I(b.current.scrollLeft),b.current&&(b.current.style.cursor="grabbing")},H=()=>{g(!1),b.current&&(b.current.style.cursor="grab")},le=()=>{g(!1),b.current&&(b.current.style.cursor="grab")},de=O=>{if(!y)return;O.preventDefault();const G=(O.pageX-b.current.offsetLeft-m)*1.5,fe=S-G;if(b.current){const ke=b.current.scrollWidth-b.current.clientWidth;fe<0?b.current.scrollLeft=fe*.3:fe>ke?b.current.scrollLeft=ke+(fe-ke)*.3:b.current.scrollLeft=fe}},te=O=>{g(!0),v(O.touches[0].pageX-b.current.offsetLeft),I(b.current.scrollLeft)},V=()=>{g(!1)},oe=O=>{if(!y)return;const G=(O.touches[0].pageX-b.current.offsetLeft-m)*1.5,fe=S-G;if(b.current){const ke=b.current.scrollWidth-b.current.clientWidth;fe<0?b.current.scrollLeft=fe*.3:fe>ke?b.current.scrollLeft=ke+(fe-ke)*.3:b.current.scrollLeft=fe}},ie=()=>{P(!0)},Q=(O,ue)=>{console.log("选择了知识库:",O,"搜索结果:",ue);const G={knowledgeBase:{id:O.id,name:O.name},isSelected:!0,searchOnSend:!0};console.log("[ChatToolbar] 保存知识库选择到sessionStorage:",G),window.sessionStorage.setItem("selectedKnowledgeBase",JSON.stringify(G));const fe=window.sessionStorage.getItem("selectedKnowledgeBase");console.log("[ChatToolbar] sessionStorage保存验证:",fe),P(!1)},L=()=>{i?d?.():F(!0)},X=O=>{O&&d&&d()},Z={"mcp-tools":x?{id:"mcp-tools",component:"MCPToolsButton",isActive:l}:null,"new-topic":{id:"new-topic",icon:e.jsx(st,{size:16,color:u?"rgba(76, 175, 80, 0.8)":"rgba(76, 175, 80, 0.7)"}),label:"新建话题",onClick:M,isActive:!1},"clear-topic":{id:"clear-topic",icon:h?e.jsx(Ar,{size:16,color:u?"rgba(244, 67, 54, 0.8)":"rgba(244, 67, 54, 0.7)"}):e.jsx(_t,{size:16,color:u?"rgba(33, 150, 243, 0.8)":"rgba(33, 150, 243, 0.7)"}),label:h?"确认清空":"清空内容",onClick:ee,isActive:h},"generate-image":{id:"generate-image",icon:e.jsx(ze,{name:"imageGenerate",size:16,color:t?u?"rgba(156, 39, 176, 0.9)":"rgba(156, 39, 176, 0.8)":u?"rgba(156, 39, 176, 0.6)":"rgba(156, 39, 176, 0.5)"}),label:t?"取消生成":"生成图片",onClick:o,isActive:t},"generate-video":{id:"generate-video",icon:e.jsx(lr,{size:16,color:a?u?"rgba(233, 30, 99, 0.9)":"rgba(233, 30, 99, 0.8)":u?"rgba(233, 30, 99, 0.6)":"rgba(233, 30, 99, 0.5)"}),label:a?"取消生成":"生成视频",onClick:r,isActive:a},knowledge:{id:"knowledge",icon:e.jsx(wt,{size:16,color:u?"rgba(5, 150, 105, 0.8)":"rgba(5, 150, 105, 0.7)"}),label:"知识库",onClick:ie,isActive:!1},"web-search":B&&d?{id:"web-search",icon:e.jsx(ze,{name:"search",size:16,color:i?u?"rgba(59, 130, 246, 0.9)":"rgba(59, 130, 246, 0.8)":u?"rgba(59, 130, 246, 0.6)":"rgba(59, 130, 246, 0.5)"}),label:i?"关闭搜索":$?.providers?.find(O=>O.id===D)?.name||"搜索",onClick:L,isActive:i}:null},pe=U.order.filter(O=>U.visibility[O]&&Z[O]).map(O=>Z[O]).filter(O=>O!==null);return e.jsxs(C,{sx:{padding:"4px 0 0 0",backgroundColor:"transparent",width:"100%",position:"relative",overflow:"visible",zIndex:1,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsxs(C,{sx:{display:"flex",alignItems:"center",width:"100%",maxWidth:"800px",position:"relative",...N.container},children:[e.jsx(ne,{onClick:J,size:"small",sx:{...R==="glassmorphism"?{background:u?"rgba(255, 255, 255, 0.02)":"rgba(255, 255, 255, 0.05)",border:u?"1px solid rgba(255, 255, 255, 0.03)":"1px solid rgba(255, 255, 255, 0.08)",borderRadius:"14px",width:32,height:32,backdropFilter:"blur(18px) saturate(180%) brightness(110%)",WebkitBackdropFilter:"blur(18px) saturate(180%) brightness(110%)",boxShadow:u?`0 6px 20px rgba(0, 0, 0, 0.1),
                   0 1px 4px rgba(0, 0, 0, 0.06),
                   inset 0 1px 0 rgba(255, 255, 255, 0.06)`:`0 6px 20px rgba(0, 0, 0, 0.05),
                   0 1px 4px rgba(0, 0, 0, 0.03),
                   inset 0 1px 0 rgba(255, 255, 255, 0.25)`,transition:"all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)",marginRight:1,"&:hover":{background:u?"rgba(255, 255, 255, 0.07)":"rgba(255, 255, 255, 0.15)",border:u?"1px solid rgba(255, 255, 255, 0.1)":"1px solid rgba(255, 255, 255, 0.22)",backdropFilter:"blur(22px) saturate(200%) brightness(115%)",WebkitBackdropFilter:"blur(22px) saturate(200%) brightness(115%)",boxShadow:u?`0 8px 28px rgba(0, 0, 0, 0.12),
                     0 2px 8px rgba(0, 0, 0, 0.08),
                     inset 0 1px 0 rgba(255, 255, 255, 0.1)`:`0 8px 28px rgba(0, 0, 0, 0.06),
                     0 2px 8px rgba(0, 0, 0, 0.04),
                     inset 0 1px 0 rgba(255, 255, 255, 0.35)`,transform:"translateY(-1px) scale(1.05)"},"&:active":{transform:"translateY(0px) scale(0.95)",boxShadow:u?`0 2px 8px rgba(0, 0, 0, 0.15),
                     inset 0 2px 6px rgba(0, 0, 0, 0.08)`:`0 2px 8px rgba(0, 0, 0, 0.08),
                     inset 0 2px 6px rgba(0, 0, 0, 0.04)`}}:{background:"transparent",borderRadius:"16px",width:28,height:28,transition:"all 0.15s ease",marginRight:.5,"&:hover":{background:u?"rgba(255, 255, 255, 0.06)":"rgba(0, 0, 0, 0.04)"}},color:u?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.8)",flexShrink:0},children:e.jsx(un,{size:16,style:{transition:"transform 0.2s ease",transform:w?"rotate(180deg)":"rotate(0deg)"}})}),e.jsx(C,{sx:{display:w?"none":"flex",alignItems:"center",flex:1,overflow:"hidden"},children:e.jsx(C,{ref:b,sx:{display:"flex",overflowX:"auto",padding:"0 8px",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"},whiteSpace:"nowrap",minHeight:"38px",alignItems:"center",justifyContent:{xs:"flex-start",md:"center"},cursor:"grab",willChange:"transform",transform:"translateZ(0)",width:"100%","&:active":{cursor:"grabbing"}},onMouseDown:me,onMouseUp:H,onMouseLeave:le,onMouseMove:de,onTouchStart:te,onTouchEnd:V,onTouchMove:oe,children:pe.map(O=>{if("component"in O&&O.component==="MCPToolsButton")return e.jsx(C,{sx:{mr:1},children:e.jsx(Ss,{toolsEnabled:l,onToolsEnabledChange:x})},O.id);if(!("onClick"in O)||!("icon"in O)||!("label"in O))return null;const ue=Y(O.isActive);return e.jsxs(C,{onClick:O.onClick,sx:{...ue,margin:R==="glassmorphism"?"0 4px":"0 2px","&:hover":{...N.buttonHover},"&:active":{...N.buttonActive}},children:[c!=="text"&&O.icon,c!=="icon"&&e.jsx(K,{variant:"body2",sx:{...N.text,ml:c==="both"?.5:0},children:O.label})]},O.id)})})})]}),e.jsx(Kr,{open:E,onClose:()=>F(!1),onProviderSelect:X}),e.jsx(Nr,{open:z,onClose:()=>P(!1),onSelect:Q})]})};export{yo as C,is as H,jo as I,vn as M,zn as V,vo as a,wo as b,Is as c,$n as u};
